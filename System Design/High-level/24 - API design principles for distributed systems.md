# 24 - API design principles for distributed systems

## 1. Activate Prior Knowledge

- Какви са основните разлики между API-та, използвани в монолитни приложения, и тези в разпределени системи?
- Какви предизвикателства възникват при комуникацията между различни компоненти на една AI система, работеща на няколко сървъра?
- Можете ли да си спомните случай, в който лошо проектиран API е довел до проблеми в интеграцията или производителността?

## 2. Overview

API-тата (Application Programming Interfaces) са основният начин, по който различни компоненти на разпределени системи комуникират помежду си. В контекста на разпределени системи, API дизайнът трябва да отчита мрежова латентност, частична достъпност, сигурност и еволюция на интерфейсите. Това е особено важно при мащабируеми AI системи, където множество услуги трябва да обменят данни ефективно и надеждно.

Добрият API дизайн е ключов за постигане на устойчивост, лесна поддръжка и възможност за разширяване на системата. Той позволява на различни екипи да работят независимо, намалява риска от грешки и улеснява интеграцията на нови функционалности. В разпределените среди, където компонентите често са разположени на различни физически или виртуални машини, API-тата трябва да бъдат проектирани така, че да минимизират зависимостите и да осигурят ясни, стабилни договори за комуникация.

В допълнение, API-тата трябва да бъдат устойчиви на промени във вътрешната реализация на услугите, да поддържат версии и да осигуряват механизми за обработка на грешки и откази. Това гарантира, че системата може да се развива без да се нарушава работата на вече интегрирани клиенти.

## 3. Key Concepts

- Distributed System – Система, съставена от множество независими компоненти, които комуникират през мрежа. Представете си я като екип от хора, работещи от различни офиси, които трябва да си изпращат съобщения.
- API Contract – Официално описание на това как клиентите и сървърите си взаимодействат чрез API. Аналогично на договор между две страни.
- Idempotency – Свойство на операция, която може да бъде изпълнена многократно с един и същ резултат. Като бутон за "повторно изпращане" на съобщение, който не създава дублирани съобщения.
- Versioning – Управление на различни версии на API, така че новите промени да не нарушават работата на съществуващи клиенти.
- Fault Tolerance – Способността на системата да продължи да работи дори при частични откази или грешки.
- Latency – Забавяне при предаване на данни между компоненти; критичен фактор при разпределени системи.
- Rate Limiting – Ограничаване на броя заявки към API за определен период, за да се предпази системата от претоварване.

## 4. Step-by-step Learning Path

1. **Understand API Contracts**
   - Фокус: Как се описват и документират API договори (например с OpenAPI/Swagger).
   - Задача: Изберете съществуващ публичен API и намерете неговата документация.
   - Въпроси: Какво съдържа един API contract? Защо е важен за разпределени системи?

2. **Design for Idempotency**
   - Фокус: Проектиране на операции, които могат да се повторят безопасно.
   - Задача: Напишете примерна POST заявка, която създава ресурс, и добавете idempotency ключ.
   - Въпроси: Какво би се случило, ако една заявка бъде изпратена два пъти? Как ще го предотвратите?

3. **Implement Versioning**
   - Фокус: Поддържане на няколко версии на API.
   - Задача: Добавете версия към URL на API (напр. /v1/resource).
   - Въпроси: Какви са плюсовете и минусите на различните подходи за versioning (URL, header, media type)?

4. **Handle Faults and Timeouts**
   - Фокус: Обработка на грешки, timeouts и retries.
   - Задача: Имплементирайте механизъм за retry с exponential backoff в клиентски код.
   - Въпроси: Какви грешки трябва да бъдат retry-нати? Кога е по-добре да се върне грешка към клиента?

5. **Secure the API**
   - Фокус: Аутентикация, авторизация и rate limiting.
   - Задача: Добавете API ключ или OAuth2 механизъм към примерен endpoint.
   - Въпроси: Какви са рисковете при публични API-та? Как rate limiting предпазва системата?

## 5. Examples

### Пример 1: Idempotent API за създаване на поръчка

```http
POST /api/v1/orders
Idempotency-Key: 123e4567-e89b-12d3-a456-426614174000
Content-Type: application/json

{
  "product_id": "A123",
  "quantity": 2
}
```
Ако клиентът изпрати същата заявка два пъти с един и същ Idempotency-Key, ще бъде създадена само една поръчка.

---

### Пример 2: Версиониране на API

```http
GET /api/v1/users/42
Authorization: Bearer <token>
```
Тук `/v1/` позволява паралелна поддръжка на различни версии на API, без да се нарушават старите клиенти.

---

### Пример 3: Rate Limiting с HTTP Headers

```http
HTTP/1.1 429 Too Many Requests
Retry-After: 60
```
Когато клиентът надвиши лимита, получава грешка 429 и указание кога може да опита отново.

## 6. Common Pitfalls

- **Липса на idempotency** – Повтарящи се заявки могат да създадат дублирани ресурси или транзакции.
- **Неясна или непълна документация** – Клиентите не знаят как да използват API-то правилно, което води до грешки.
- **Липса на versioning** – Всяка промяна чупи съществуващи интеграции.
- **Пренебрегване на грешките и timeouts** – Клиентите "висят" или системата става нестабилна при мрежови проблеми.
- **Недостатъчна сигурност** – Липса на аутентикация и rate limiting излага системата на атаки и претоварване.

## 7. Short Retrieval Quiz

1. Какво означава idempotency при API дизайн?
2. Защо е важно да се поддържат версии на API в разпределени системи?
3. Какво е rate limiting и как предпазва системата?
4. Какви са основните предимства на добре документирания API contract?
5. Как трябва да реагира клиентът при получаване на HTTP 429?
6. Какви са рисковете при липса на fault tolerance в API?
7. Какви подходи за versioning на API познавате?

## 8. Quick Recap

- API-тата са ключовият комуникационен слой в разпределените системи.
- Добрият дизайн включва ясни договори, idempotency, versioning и обработка на грешки.
- Rate limiting и сигурността са критични за защита на услугите.
- Документацията е също толкова важна, колкото и самият код.
- Fault tolerance позволява на системата да работи устойчиво при частични откази.
- Версионирането осигурява плавна еволюция на API без да се нарушават старите клиенти.
- Практическите задачи и примери помагат за по-дълбоко разбиране на принципите.

## 9. Spaced Review Plan

| Review Time | Review Prompt                                                    |
|-------------|------------------------------------------------------------------|
| 1 day       | Опишете с примери какво е idempotency и защо е важно.            |
| 3 days      | Избройте основните принципи за сигурност при API в distributed systems. |
| 1 week      | Обяснете как versioning и rate limiting се прилагат на практика. |
| 1 month     | Дайте пример за често срещан проблем при API дизайн и как се решава. |