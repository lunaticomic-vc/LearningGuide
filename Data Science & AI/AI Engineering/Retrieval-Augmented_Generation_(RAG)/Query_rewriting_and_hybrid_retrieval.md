# Query_rewriting_and_hybrid_retrieval

## 1. Activate Prior Knowledge

- Какво представлява търсенето в контекста на информационни системи и какво е значението на формулирането на заявка (query)?
- Какви са основните предизвикателства при търсенето в големи бази данни или документи, особено когато заявката е неясна или непълна?
- Как бихте комбинирали различни подходи за търсене, за да подобрите точността и релевантността на резултатите?

## 2. Overview

Query rewriting (пренаписване на заявка) е процесът на модифициране или разширяване на първоначалната заявка, за да се подобри качеството на търсенето. Това може да включва добавяне на синоними, корекция на правописни грешки, разширяване с по-общи или по-специфични термини и други техники. Целта е да се улесни системата при намирането на по-релевантни резултати, особено когато потребителят не формулира оптимална заявка.

Hybrid retrieval (хибридно търсене) комбинира различни методи за извличане на информация, като например класическо търсене по ключови думи (keyword-based retrieval) и семантично търсене, базирано на модели за разбиране на смисъла. Този подход използва силните страни на всеки метод, за да осигури по-точни и контекстуално подходящи резултати.

В по-широк контекст, query rewriting и hybrid retrieval са ключови компоненти в съвременните AI системи за търсене, като търсачки, виртуални асистенти и системи за препоръки. Те подобряват взаимодействието между потребителите и системата, като намаляват нуждата от прецизни заявки и увеличават удовлетворението от резултатите.

## 3. Key Concepts

- **Query rewriting** – процес на автоматично или полуавтоматично преформулиране на потребителска заявка с цел подобряване на резултатите от търсенето. Може да се сравни с редактиране на въпрос, за да стане по-ясен и разбираем.
- **Synonym expansion** – добавяне на синоними към ключовите думи в заявката, за да се обхванат различни начини, по които може да бъде формулирана една идея.
- **Semantic retrieval** – търсене, което използва модели за разбиране на значението на думите и контекста, а не само точните съвпадения на ключови думи.
- **Hybrid retrieval** – комбиниране на различни техники за търсене, например keyword-based и semantic, за постигане на по-добри резултати.
- **Relevance feedback** – метод, при който системата използва обратна връзка от потребителя за подобряване на заявката или резултатите.
- **Query intent** – намерението зад заявката, което системата се опитва да разбере, за да предостави по-подходящи резултати.

## 4. Step-by-step Learning Path

1. **Разберете основите на query rewriting**
   - Фокус: Какво е query rewriting и защо е важно.
   - Задача: Напишете ръчно 3 пренаписани версии на проста заявка (например „автомобили“).
   - Въпроси: Как query rewriting може да подобри търсенето? Кои са основните техники?

2. **Изучете synonym expansion и корекция на грешки**
   - Фокус: Разширяване на заявката с синоними и корекция на правопис.
   - Задача: Използвайте библиотека за синоними (например WordNet) и имплементирайте прост скрипт за разширяване на заявка.
   - Въпроси: Как synonym expansion влияе на резултатите? Какви са рисковете?

3. **Запознайте се с концепцията за semantic retrieval**
   - Фокус: Разбиране на семантичното търсене и модели като word embeddings.
   - Задача: Използвайте предварително обучен модел (например Word2Vec или BERT) за намиране на семантично близки термини.
   - Въпроси: Как семантичното търсене се различава от keyword-based? Как се измерва семантична близост?

4. **Практикувайте изграждане на хибридна система**
   - Фокус: Комбиниране на keyword и semantic retrieval.
   - Задача: Имплементирайте прост хибриден ранкър, който комбинира двата подхода с тегла.
   - Въпроси: Как да балансираме двата метода? Какво е предимството на хибридния подход?

5. **Изследвайте relevance feedback и оптимизация**
   - Фокус: Използване на обратна връзка за подобряване на заявката.
   - Задача: Добавете механизъм за събиране на обратна връзка и адаптирайте заявката.
   - Въпроси: Как обратната връзка подобрява търсенето? Какви са ограниченията?

## 5. Examples

### Пример 1: Пренаписване на заявка с синоними

```python
from nltk.corpus import wordnet

def synonym_expansion(query):
    expanded_terms = set(query.split())
    for word in query.split():
        for syn in wordnet.synsets(word):
            for lemma in syn.lemmas():
                expanded_terms.add(lemma.name())
    return ' '.join(expanded_terms)

query = "car"
print(synonym_expansion(query))
```

### Пример 2: Хибридно търсене с теглове

```python
def hybrid_score(keyword_score, semantic_score, alpha=0.6):
    return alpha * keyword_score + (1 - alpha) * semantic_score

# Примерни резултати
keyword_score = 0.8
semantic_score = 0.7
final_score = hybrid_score(keyword_score, semantic_score)
print(f"Hybrid score: {final_score}")
```

### Пример 3: Семантично търсене с BERT (псевдокод)

```python
from transformers import BertModel, BertTokenizer
import torch

tokenizer = BertTokenizer.from_pretrained('bert-base-uncased')
model = BertModel.from_pretrained('bert-base-uncased')

def embed_text(text):
    inputs = tokenizer(text, return_tensors='pt')
    outputs = model(**inputs)
    return outputs.last_hidden_state.mean(dim=1)

query_embedding = embed_text("electric car")
doc_embedding = embed_text("battery-powered vehicle")

similarity = torch.cosine_similarity(query_embedding, doc_embedding)
print(f"Semantic similarity: {similarity.item()}")
```

## 6. Common Pitfalls

- **Пренаписване, което прекалено разширява заявката** – добавянето на твърде много синоними или термини може да доведе до шум и нерелевантни резултати.
- **Игнориране на намерението на потребителя** – пренаписването трябва да запази основния смисъл, а не да го изкривява.
- **Прекалено опиране само на keyword-based търсене** – води до пропускане на семантични съвпадения.
- **Недостатъчно балансиране в хибридния модел** – неправилно зададени тегла могат да намалят качеството на резултатите.
- **Пренебрегване на обратната връзка от потребителя** – без нея системата не може да се адаптира и подобрява.

## 7. Short Retrieval Quiz

1. Какво е целта на query rewriting?
2. Как synonym expansion подобрява търсенето?
3. Какво представлява hybrid retrieval?
4. Кои два основни подхода се комбинират в хибридното търсене?
5. Как relevance feedback помага за оптимизацията на заявките?
6. Каква е разликата между keyword-based и semantic retrieval?
7. Как може прекомерното разширяване на заявката да навреди на резултатите?

## 8. Quick Recap

- Query rewriting подобрява заявките за по-добри резултати.
- Synonym expansion и корекция на грешки са чести техники за пренаписване.
- Semantic retrieval използва модели за разбиране на смисъла.
- Hybrid retrieval комбинира keyword и semantic подходи за оптимални резултати.
- Relevance feedback позволява адаптация спрямо потребителските предпочитания.
- Балансът между различните методи е ключов за ефективност.
- Избягвайте прекомерно разширяване и загуба на намерението на заявката.

## 9. Spaced Review Plan

| Време след учене | Промпт за преговор                                      |
|------------------|---------------------------------------------------------|
| 1 ден            | Обяснете с прости думи какво е query rewriting.         |
| 3 дни            | Избройте и опишете основните техники за query rewriting.|
| 1 седмица        | Какво представлява hybrid retrieval и защо е полезно?   |
| 1 месец          | Дайте пример за приложение на relevance feedback.       |