# 11 - Caching within services and local optimization techniques

## 1. Activate Prior Knowledge

- Какви са основните причини за забавяне на отговорите в една услуга или система?
- Можете ли да дадете пример от реалния живот, където нещо се "запомня" временно, за да се ускори процесът?
- Какви техники за оптимизация сте използвали или чували в контекста на софтуерно инженерство или AI системи?

## 2. Overview

Кеширането (caching) е техника за временно съхраняване на често използвани или скъпо струващи за изчисление данни, така че бъдещи заявки за тези данни да се обслужват по-бързо. В рамките на една услуга (service), кеширането може значително да намали латентността, да облекчи натоварването върху изчислителните ресурси и да подобри мащабируемостта.

Локалната оптимизация включва прилагането на специфични техники и стратегии за ускоряване на определени части от системата, без да се променя цялостната ѝ архитектура. Това често се прави чрез анализ на "тесни места" (bottlenecks) и прилагане на targeted подобрения.

В контекста на AI системи и съвременни уеб услуги, кеширането и локалната оптимизация са ключови за постигане на висока производителност, ниска латентност и ефективно използване на ресурси. Те позволяват на системите да реагират по-бързо на потребителски заявки и да мащабират по-лесно при увеличаващо се натоварване.

## 3. Key Concepts

- Cache (Кеш) – Бърза памет или хранилище, в което се съхраняват често използвани данни за по-бърз достъп. Мислете за това като за "бележка до себе си" в работния процес.
- Cache Hit (Кеш попадение) – Когато търсените данни вече са в кеша и могат да се използват веднага, без допълнителни изчисления.
- Cache Miss (Кеш пропуск) – Когато търсените данни не са в кеша и трябва да бъдат изчислени или извлечени от по-бавен източник.
- Eviction Policy (Политика за изчистване) – Правила, определящи кои данни да бъдат премахнати от кеша, когато той се запълни (напр. LRU – Least Recently Used).
- Local Optimization (Локална оптимизация) – Подобряване на производителността на конкретна част от системата, често чрез анализ на профилиране и прилагане на targeted промени.
- Memoization (Мемоизация) – Техника за кеширане на резултатите от скъпи функции, за да се избегне повторно изчисление.
- Hot Path (Горещ път) – Често използвана част от кода, която има голямо влияние върху производителността.

## 4. Step-by-step Learning Path

1. **Разберете основите на кеширането**
   - Фокус: Какво е кеш и защо е полезен.
   - Задача: Намерете пример за кеширане във вашия любим софтуер (например браузър).
   - Въпроси: Как кешът ускорява работата? Какво се случва при cache miss?

2. **Изследвайте различни типове кеширане**
   - Фокус: Разлика между in-memory кеш, distributed cache и persistent cache.
   - Задача: Направете кратко сравнение между Redis и локален in-memory кеш.
   - Въпроси: Кога бихте използвали in-memory кеш вместо Redis?

3. **Имплементирайте прост кеш в услуга**
   - Фокус: Основни операции – добавяне, търсене, изчистване.
   - Задача: Напишете функция с мемоизация на любим език (например Python).
   - Въпроси: Какви са предимствата и недостатъците на мемоизацията?

4. **Анализирайте и оптимизирайте "горещи пътища"**
   - Фокус: Използване на профилиране за идентифициране на bottlenecks.
   - Задача: Профилирайте малък проект и идентифицирайте най-бавната функция.
   - Въпроси: Какви техники можете да приложите за локална оптимизация?

5. **Изберете и приложете политика за изчистване на кеша**
   - Фокус: LRU, LFU, FIFO и техните trade-offs.
   - Задача: Имплементирайте LRU кеш (или използвайте библиотека).
   - Въпроси: Как изборът на eviction policy влияе на ефективността?

## 5. Examples

### Пример 1: Мемоизация на скъпа функция

```python
def expensive_computation(x):
    print("Computing...")
    return x * x

cache = {}

def memoized_expensive_computation(x):
    if x in cache:
        return cache[x]
    result = expensive_computation(x)
    cache[x] = result
    return result

print(memoized_expensive_computation(5))  # Computing... 25
print(memoized_expensive_computation(5))  # 25 (без повторно изчисление)
```

### Пример 2: In-memory кеш в уеб услуга (Flask + SimpleCache)

```python
from flask import Flask, request
from werkzeug.middleware.proxy_fix import ProxyFix
from werkzeug.contrib.cache import SimpleCache

app = Flask(__name__)
cache = SimpleCache()

@app.route('/data')
def get_data():
    key = request.args.get('key')
    value = cache.get(key)
    if value is None:
        # Скъпа операция, напр. заявка към база данни
        value = expensive_db_query(key)
        cache.set(key, value, timeout=60)
    return value
```

### Пример 3: Локална оптимизация чрез профилиране

- Профилирате функция, която се изпълнява често и забавя системата.
- Оптимизирате я чрез кеширане на резултатите или пренаписване на алгоритъма.

## 6. Common Pitfalls

- **Прекомерно кеширане:** Кеширането на твърде много или неподходящи данни може да доведе до изчерпване на паметта.
- **Остарели данни (Stale Data):** Ако кешът не се обновява правилно, потребителите могат да получат стари или некоректни резултати.
- **Неподходяща политика за изчистване:** Изборът на неподходящ eviction policy може да намали ефективността на кеша.
- **Липса на профилиране:** Оптимизиране "на сляпо" без анализ на реалните bottlenecks често води до неефективни подобрения.
- **Кеширане на чувствителни данни:** Без подходящи мерки за сигурност, кешът може да стане източник на изтичане на информация.

## 7. Short Retrieval Quiz

1. Какво е cache hit и защо е важно?
2. Каква е разликата между in-memory кеш и distributed cache?
3. Какво представлява мемоизацията?
4. Какво е eviction policy и дайте пример за такава?
5. Какви са рисковете при кеширане на чувствителни данни?
6. Как можете да идентифицирате "горещ път" в една услуга?
7. Какво се случва при cache miss?

## 8. Quick Recap

- Кеширането ускорява достъпа до често използвани или скъпи за изчисление данни.
- Локалната оптимизация се фокусира върху targeted подобрения в конкретни части от системата.
- Memoization е специален случай на кеширане за функции.
- Изборът на подходяща политика за изчистване е критичен за ефективността на кеша.
- Профилирането помага да се идентифицират bottlenecks и да се насочат усилията за оптимизация.
- Прекомерното или неправилно кеширане може да доведе до проблеми с паметта и остарели данни.
- Кеширането е особено важно за мащабируеми и високопроизводителни AI и уеб услуги.

## 9. Spaced Review Plan

| Време      | Преговори/Задачи                                               |
|------------|---------------------------------------------------------------|
| 1 ден      | Обяснете с ваши думи как работи кешът и дайте пример за мемоизация. |
| 3 дни      | Опишете различни политики за изчистване на кеша и кога се използват. |
| 1 седмица  | Анализирайте реална услуга и предложете локална оптимизация чрез кеширане. |
| 1 месец    | Прегледайте типични грешки при кеширане и как да ги избегнете. |