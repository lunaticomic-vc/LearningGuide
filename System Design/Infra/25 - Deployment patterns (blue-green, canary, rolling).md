# 25 - Deployment patterns (blue-green, canary, rolling)

## 1. Activate Prior Knowledge

- Какви са основните рискове при внедряване на нови версии на софтуер в продукционна среда, особено при AI системи?
- Можете ли да си спомните ситуация, в която внедряване е довело до неочаквани проблеми или прекъсване на услугата?
- Какви методи познавате за минимизиране на риска при промяна на работещи системи?

## 2. Overview

Внедряването на нови версии на софтуер е критичен процес, особено при мащабни или чувствителни системи като AI платформи. Грешки или прекъсвания по време на внедряване могат да доведат до загуба на данни, приходи или доверие. За да се минимизират тези рискове, са разработени различни deployment patterns – стратегии за плавно и безопасно въвеждане на нови версии.

Blue-green, canary и rolling deployment са три от най-популярните модели. Всеки от тях има различен подход към управлението на трафика, времето за внедряване и възможността за бързо връщане към предишна версия (rollback). Изборът на подходящ модел зависи от спецификата на системата, нуждите на бизнеса и нивото на приемлив риск.

Тези deployment patterns са особено важни в контекста на AI системи, където новите модели или функции могат да имат непредвидими ефекти върху продукционните данни и потребителското изживяване. Разбирането и прилагането им е ключово умение за всеки софтуерен инженер.

## 3. Key Concepts

- Deployment Pattern – Шаблон или стратегия за внедряване на нова версия на софтуер в продукционна среда. Може да се сравни с различни начини за смяна на гума: бързо, поетапно или с резервен комплект.
- Blue-Green Deployment – Поддържане на две идентични среди (blue и green), като само едната е активна. Превключването става мигновено, подобно на смяна на релси за влак.
- Canary Deployment – Постепенно насочване на малка част от трафика към новата версия, за да се наблюдава поведението ѝ. Аналогия: първо пускате „канарче“ в мината, за да проверите дали е безопасно.
- Rolling Deployment – Поетапно обновяване на сървърите или инстанциите, докато всички преминат към новата версия. Прилича на смяна на крушките една по една, вместо наведнъж.
- Rollback – Връщане към предишна версия при проблеми с новата. Критично за минимизиране на щетите.
- Traffic Routing – Управление на това коя версия на приложението получава трафика на потребителите.

## 4. Step-by-step Learning Path

1. **Разберете основните deployment patterns**
   - Фокус: Прочетете за blue-green, canary и rolling deployment.
   - Задача: Направете кратко резюме (2 изречения) за всеки модел.
   - Въпроси: Каква е основната разлика между blue-green и canary deployment? Кога бихте избрали rolling deployment?

2. **Симулирайте blue-green deployment**
   - Фокус: Разгледайте как се поддържат две среди и как се превключва трафика.
   - Задача: Начертайте схема на blue-green deployment за уеб приложение.
   - Въпроси: Какво се случва с потребителите по време на превключването? Как се осъществява rollback?

3. **Използвайте canary deployment в облачна среда**
   - Фокус: Научете как се насочва част от трафика към нова версия.
   - Задача: Създайте Kubernetes deployment с canary стратегия (примерно с 10% трафик към новата версия).
   - Въпроси: Какви метрики бихте наблюдавали при canary deployment? Как определяте кога да увеличите трафика?

4. **Реализирайте rolling deployment**
   - Фокус: Разберете как се обновяват инстанции поетапно.
   - Задача: Напишете скрипт или използвайте CI/CD инструмент за rolling deployment на API услуга.
   - Въпроси: Какви са предимствата и недостатъците на rolling deployment? Как се осигурява непрекъсната работа?

5. **Оценете и сравнете моделите**
   - Фокус: Анализирайте кога кой модел е най-подходящ.
   - Задача: Изберете реален проект и аргументирайте кой deployment pattern бихте използвали.
   - Въпроси: Какви фактори влияят върху избора на deployment pattern? Какво бихте направили при критичен инцидент?

## 5. Examples

### Пример 1: Blue-Green Deployment с уеб приложение

```yaml
# Примерна конфигурация за blue-green deployment с Nginx
upstream blue_app { server 10.0.0.1; }
upstream green_app { server 10.0.0.2; }

server {
    listen 80;
    location / {
        proxy_pass http://green_app; # Смяна на blue към green
    }
}
```
При нужда от rollback, proxy_pass се връща към blue_app.

---

### Пример 2: Canary Deployment в Kubernetes

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app-canary
spec:
  replicas: 1
  selector:
    matchLabels:
      app: my-app
      version: canary
  template:
    metadata:
      labels:
        app: my-app
        version: canary
    spec:
      containers:
      - name: my-app
        image: my-app:v2
```
В същото време основният deployment (v1) работи с повече реплики.

---

### Пример 3: Rolling Deployment с Ansible

```yaml
- hosts: app_servers
  serial: 2
  tasks:
    - name: Update application
      shell: ./deploy_new_version.sh
```
Ansible ще обновява по 2 сървъра наведнъж, докато всички преминат към новата версия.

## 6. Common Pitfalls

- **Липса на автоматизация** – Ръчното превключване или обновяване увеличава риска от грешки. Използвайте CI/CD инструменти.
- **Недостатъчно наблюдение (monitoring)** – Без метрики и аларми не може да се реагира навреме при проблеми, особено при canary deployment.
- **Лош rollback план** – Ако не е планирано връщане към стара версия, може да се стигне до дълъг downtime.
- **Несъвместимост между среди** – Blue и green средите трябва да са идентични; разлики водят до неочаквани бъгове.
- **Прекалено бързо увеличаване на трафика към новата версия** – При canary deployment това може да доведе до масови проблеми.

## 7. Short Retrieval Quiz

1. Каква е основната идея на blue-green deployment?
2. Какво представлява canary deployment и кога е полезен?
3. Как rolling deployment осигурява непрекъсната работа на системата?
4. Какви са основните предимства на canary deployment пред blue-green?
5. Какво е rollback и защо е важно?
6. Какви метрики трябва да се наблюдават при canary deployment?
7. Какви са рисковете при липса на автоматизация на deployment процеса?

## 8. Quick Recap

- Deployment patterns са стратегии за безопасно и ефективно внедряване на нови версии.
- Blue-green deployment използва две идентични среди и мигновено превключване.
- Canary deployment насочва малка част от трафика към новата версия за наблюдение.
- Rolling deployment обновява инстанциите поетапно, без прекъсване на услугата.
- Rollback е критично умение за бързо възстановяване при проблеми.
- Автоматизацията и мониторингът са ключови за успешен deployment.
- Изборът на модел зависи от спецификата на системата и бизнес изискванията.

## 9. Spaced Review Plan

| Review Time | Prompt                                                                 |
|-------------|------------------------------------------------------------------------|
| 1 day       | Обяснете с примери разликите между blue-green и canary deployment.     |
| 3 days      | Опишете как бихте реализирали rolling deployment за AI услуга.         |
| 1 week      | Какви метрики бихте наблюдавали при canary deployment и защо?          |
| 1 month     | Кога бихте избрали blue-green deployment пред останалите модели?       |