# 07 - Joins subqueries and relational modeling

## 1. Activate Prior Knowledge

- Как бихте комбинирали данни от две различни таблици в база данни, за да получите пълна информация за даден клиент и неговите поръчки?
- Можете ли да си спомните ситуация, в която трябваше да филтрирате резултати от заявка на база на резултатите от друга заявка?
- Какви са основните предимства на нормализираната структура на базата данни при проектиране на софтуерни системи, особено в контекста на мащабируеми AI приложения?

## 2. Overview

Joins, подзаявки и релационно моделиране са фундаментални концепции в релационните бази данни, които позволяват ефективно управление и анализ на сложни данни. Те са в основата на изграждането на гъвкави и мащабируеми софтуерни системи, където данните са разпределени в множество свързани таблици.

Joins позволяват комбиниране на редове от две или повече таблици въз основа на логически връзки между тях, което е особено важно при анализ на данни в реални бизнес или AI сценарии. Подзаявките дават възможност за вложени заявки, които могат да решават по-сложни задачи, като филтриране или агрегация на данни въз основа на динамични условия.

Релационното моделиране осигурява структурирана рамка за организиране на данните, така че да се минимизират дублиранията и да се улесни поддръжката и разширяемостта на системата. Тези техники са критични за създаване на надеждни, ефективни и лесни за поддръжка бази данни, които са гръбнакът на съвременните AI и софтуерни приложения.

## 3. Key Concepts

- Join – Операция, която комбинира редове от две или повече таблици въз основа на свързващо условие. Мислете за join като за "съединител" между различни източници на информация.
- Subquery (Подзаявка) – Заявка, вложена в друга заявка, която връща резултат, използван от външната заявка. Подобно на малка "заявка в заявката", която помага за по-сложни филтрации.
- Primary Key (Първичен ключ) – Уникален идентификатор за всеки ред в таблица. Представете си го като ЕГН за всеки запис.
- Foreign Key (Външен ключ) – Поле, което сочи към първичен ключ в друга таблица, създавайки връзка между таблиците.
- Normalization (Нормализация) – Процес на организиране на данни с цел минимизиране на дублирането и осигуряване на целостта на данните.
- Denormalization (Денормализация) – Умишлено въвеждане на дублиране за оптимизация на производителността при четене.
- Entity-Relationship Model (ER-модел) – Графично представяне на обектите (ентитетите) и връзките между тях в базата данни.

## 4. Step-by-step Learning Path

1. **Разберете основните видове JOIN**
   - Фокус: INNER JOIN, LEFT JOIN, RIGHT JOIN, FULL OUTER JOIN.
   - Практическа задача: Напишете SQL заявки, които комбинират две таблици (например `customers` и `orders`) с всеки тип join.
   - Retrieval: Каква е разликата между INNER и LEFT JOIN? Кога бихте използвали RIGHT JOIN?

2. **Работа с подзаявки**
   - Фокус: Вложени SELECT-и в WHERE и FROM клаузи.
   - Практическа задача: Извлечете всички клиенти, които са направили поръчки над определена сума, използвайки подзаявка.
   - Retrieval: Каква е разликата между корелирана и некорелирана подзаявка?

3. **Проектиране на релационен модел**
   - Фокус: Определяне на ентитети, първични и външни ключове, нормализация (1NF, 2NF, 3NF).
   - Практическа задача: Моделирайте база данни за онлайн книжарница с таблици за книги, автори и поръчки.
   - Retrieval: Какво е целта на нормализацията? Как се дефинира външен ключ?

4. **Комбиниране на joins и подзаявки**
   - Фокус: Сложни заявки, използващи едновременно join-и и подзаявки.
   - Практическа задача: Извлечете списък с автори и броя на продадените им книги, като използвате join и подзаявка.
   - Retrieval: Може ли подзаявка да върне повече от един ред? Как ще го обработите?

5. **Оптимизация и добри практики**
   - Фокус: Индекси, избягване на ненужни join-и, анализ на изпълнението на заявки.
   - Практическа задача: Анализирайте изпълнението на сложна заявка с EXPLAIN и предложете оптимизация.
   - Retrieval: Как индексите влияят на join-операциите? Какви са рисковете при прекалено сложни подзаявки?

## 5. Examples

**Пример 1: INNER JOIN**
```sql
SELECT customers.name, orders.order_date
FROM customers
INNER JOIN orders ON customers.id = orders.customer_id;
```
*Връща всички клиенти с техните поръчки.*

**Пример 2: Подзаявка във WHERE**
```sql
SELECT name
FROM customers
WHERE id IN (
    SELECT customer_id
    FROM orders
    WHERE total > 100
);
```
*Връща имената на клиенти с поръчки над 100 лева.*

**Пример 3: Релационен модел (ER диаграма)**
- Таблица `books`: book_id (PK), title, author_id (FK)
- Таблица `authors`: author_id (PK), name
- Таблица `orders`: order_id (PK), book_id (FK), quantity

*Този модел показва как книгите са свързани с авторите и поръчките чрез ключове.*

## 6. Common Pitfalls

- Използване на CROSS JOIN без WHERE условие, което води до огромни и ненужни резултати.
- Забравяне на ON условието при JOIN, което може да доведе до cartesian product.
- Грешно дефинирани външни ключове, което нарушава целостта на данните.
- Неправилна или липсваща нормализация, което води до дублиране и трудна поддръжка.
- Използване на подзаявки, когато join би бил по-ефективен (и обратно).
- Пренебрегване на индекси, което забавя join-операциите.

## 7. Short Retrieval Quiz

1. Каква е основната разлика между INNER JOIN и LEFT JOIN?
2. Защо използваме подзаявки в SQL?
3. Какво представлява външният ключ и каква е неговата роля?
4. Как нормализацията подобрява структурата на базата данни?
5. Може ли подзаявка да върне повече от един ред? Как се обработва това?
6. Какво е ER-модел и защо е важен?
7. Какви са рисковете при използване на денормализация?

## 8. Quick Recap

- Joins комбинират данни от различни таблици чрез логически връзки.
- Подзаявките позволяват вложени и по-гъвкави заявки.
- Релационното моделиране структурира данните чрез ентитети и връзки.
- Първичните и външните ключове гарантират целостта на данните.
- Нормализацията намалява дублирането и улеснява поддръжката.
- Изборът между join и подзаявка зависи от конкретната задача и ефективността.
- Оптимизацията на заявки е критична за производителността на системата.

## 9. Spaced Review Plan

| Review Time | Prompt                                                                 |
|-------------|------------------------------------------------------------------------|
| 1 day       | Обяснете разликата между INNER и LEFT JOIN с пример.                   |
| 3 days      | Начертайте ER-модел за проста система (напр. библиотека).              |
| 1 week      | Напишете заявка, комбинираща join и подзаявка за бизнес казус.         |
| 1 month     | Опишете процеса на нормализация и дайте пример за всяка нормална форма.|