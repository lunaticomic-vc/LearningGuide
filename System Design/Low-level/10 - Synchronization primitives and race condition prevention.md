# 10 - Synchronization primitives and race condition prevention

## 1. Activate Prior Knowledge

- Кога за последно сте работили по проект, в който няколко процеса или нишки трябваше да достъпват едни и същи данни едновременно? Какви проблеми срещнахте?
- Как бихте обяснили какво е "race condition" на колега, който не е запознат с концепцията?
- Можете ли да дадете пример от реалния свят (например в AI системи или уеб приложения), където неправилната синхронизация може да доведе до сериозни грешки или уязвимости?

## 2. Overview

В съвременните софтуерни системи, особено тези, които използват многонишково или многопроцесно изпълнение, често се налага няколко изпълнителни единици да работят с общи ресурси – памет, файлове, бази данни. Без правилна координация между тях може да възникнат race conditions – ситуации, при които резултатът зависи от непредвидимия ред на изпълнение.

Синхронизационните примитиви са основни инструменти, които позволяват на разработчиците да управляват достъпа до споделени ресурси и да предотвратяват нежелани състояния. Те са ключови за изграждането на надежден, коректен и предсказуем софтуер, особено в контекста на паралелни и разпределени системи.

В AI системите, където често се обработват големи обеми от данни паралелно, неправилната синхронизация може да доведе до загуба на данни, неконсистентни модели или дори сривове. Разбирането и правилното използване на синхронизационните примитиви е фундаментално за всеки професионалист в областта на софтуерното инженерство.

## 3. Key Concepts

- Race condition – Ситуация, при която резултатът от изпълнението зависи от реда, по който се изпълняват конкурентни операции. Представете си двама души, които едновременно редактират един и същи документ без координация.
- Critical section – Част от кода, която трябва да се изпълнява само от една нишка или процес в даден момент, за да се избегнат конфликти.
- Mutex (Mutual Exclusion) – Примитив, който позволява само една нишка да влиза в критична секция едновременно. Мислете за това като за ключ за заключване на врата.
- Semaphore – Синхронизационен механизъм, който контролира достъпа до ресурс с ограничен капацитет (например паркинг с определен брой места).
- Deadlock – Състояние, при което две или повече нишки чакат една друга да освободят ресурси и никоя не може да продължи.
- Starvation – Ситуация, при която една или повече нишки никога не получават достъп до ресурс поради постоянна заетост от други.
- Atomic operation – Операция, която се изпълнява изцяло или изобщо не се изпълнява, без да бъде прекъсната от други операции.

## 4. Step-by-step Learning Path

1. **Разберете какво е race condition**
   - Фокус: Прочетете за race conditions и идентифицирайте примери в ежедневния код.
   - Практическа задача: Напишете прост код, където две нишки увеличават една и съща променлива без синхронизация.
   - Въпроси: Какъв е резултатът при всяко изпълнение? Защо се различава?

2. **Изучете критичните секции**
   - Фокус: Определете кои части от кода изискват синхронизация.
   - Практическа задача: Маркирайте критичните секции във вашия примерен код.
   - Въпроси: Какво би станало, ако две нишки влязат едновременно в критична секция?

3. **Използвайте mutex-и**
   - Фокус: Научете как се използват mutex-и за защита на критични секции.
   - Практическа задача: Добавете mutex към предишния код и наблюдавайте резултата.
   - Въпроси: Как се променя поведението на програмата? Има ли вече race condition?

4. **Експериментирайте със семафори**
   - Фокус: Разберете разликата между mutex и semaphore.
   - Практическа задача: Имплементирайте семафор за ограничаване на достъпа до ресурс с капацитет 2.
   - Въпроси: Кога бихте използвали семафор вместо mutex?

5. **Разберете и предотвратете deadlocks**
   - Фокус: Научете как възникват deadlocks и как да ги избягвате.
   - Практическа задача: Създайте примерен deadlock и след това го коригирайте.
   - Въпроси: Какви са основните стратегии за избягване на deadlocks?

## 5. Examples

### Пример 1: Race condition без синхронизация

```python
import threading

counter = 0

def increment():
    global counter
    for _ in range(100000):
        counter += 1

threads = [threading.Thread(target=increment) for _ in range(2)]
for t in threads: t.start()
for t in threads: t.join()
print(counter)  # Очаквано: 200000, реално: по-малко (race condition)
```

### Пример 2: Използване на mutex

```python
import threading

counter = 0
lock = threading.Lock()

def increment():
    global counter
    for _ in range(100000):
        with lock:
            counter += 1

threads = [threading.Thread(target=increment) for _ in range(2)]
for t in threads: t.start()
for t in threads: t.join()
print(counter)  # Винаги: 200000
```

### Пример 3: Семафор за ограничен ресурс

```python
import threading
import time

semaphore = threading.Semaphore(2)

def access_resource(thread_id):
    with semaphore:
        print(f"Thread {thread_id} is accessing the resource")
        time.sleep(1)

threads = [threading.Thread(target=access_resource, args=(i,)) for i in range(5)]
for t in threads: t.start()
for t in threads: t.join()
```

## 6. Common Pitfalls

- **Пропускане на критични секции:** Не всички достъпи до споделени ресурси са защитени, което води до race conditions.
- **Грешно използване на mutex/semaphore:** Използване на mutex там, където е нужен семафор (или обратно), може да доведе до неефективност или блокиране.
- **Deadlocks:** Заключване на ресурси в грешен ред или без таймаути може да блокира цялата система.
- **Starvation:** Прекалено приоритизиране на някои нишки може да остави други без достъп до ресурс.
- **Прекалена синхронизация:** Използване на твърде много заключвания намалява производителността и увеличава сложността.

## 7. Short Retrieval Quiz

1. Какво е race condition и кога възниква?
2. За какво служи mutex и как се използва?
3. Каква е разликата между mutex и semaphore?
4. Какво представлява критична секция?
5. Как може да възникне deadlock?
6. Какво е atomic operation?
7. Какви са рисковете при прекалена синхронизация?

## 8. Quick Recap

- Race conditions възникват при конкурентен достъп до споделени ресурси без синхронизация.
- Критичните секции трябва да се защитават с подходящи примитиви.
- Mutex-ите позволяват само една нишка в критична секция.
- Семафорите управляват достъпа до ресурси с ограничен капацитет.
- Deadlocks и starvation са чести проблеми при неправилна синхронизация.
- Atomic operations са ключови за избягване на race conditions.
- Балансираната синхронизация е важна за производителността и надеждността.

## 9. Spaced Review Plan

| Кога      | Преговори/Въпроси                                    |
|-----------|------------------------------------------------------|
| 1 ден     | Какво е race condition? Как се използва mutex?       |
| 3 дни     | Разлика между mutex и semaphore. Deadlock примери.   |
| 1 седмица | Идентифициране на критични секции в собствен код.    |
| 1 месец   | Анализ на реален проект за синхронизационни проблеми.|