# 04 - Load balancing and reverse proxy concepts

## 1. Activate Prior Knowledge

- Какво се случва, когато много потребители се опитват да достъпят един и същ уебсайт или услуга едновременно? Какви проблеми могат да възникнат?
- Как бихте организирали архитектурата на уеб приложение, за да осигурите висока наличност и устойчивост при натоварване?
- Каква е ролята на посредник (proxy) в комуникацията между клиент и сървър, особено в контекста на мащабируеми AI системи?

## 2. Overview

Load balancing и reverse proxy са фундаментални концепции в съвременните софтуерни архитектури, които позволяват на системите да бъдат мащабируеми, надеждни и ефективни. Load balancer-ът разпределя входящия трафик между множество сървъри, така че никой отделен сървър да не бъде претоварен, а ресурсите да се използват оптимално.

Reverse proxy действа като посредник между клиентите и бекенд сървърите. Той приема клиентските заявки и ги препраща към подходящия сървър, като често изпълнява и допълнителни функции като кеширане, сигурност и компресия.

В контекста на AI системи и големи уеб приложения, тези механизми са критични за осигуряване на непрекъсната работа, бърз отговор и гъвкаво управление на ресурсите. Без тях, дори най-добрият модел или услуга може да стане недостъпна при високо натоварване.

## 3. Key Concepts

- Load Balancer – Софтуерен или хардуерен компонент, който разпределя входящия трафик между няколко сървъра. Може да се сравни с диспечер, който насочва клиенти към най-свободния служител.
- Reverse Proxy – Сървър, който приема заявки от клиенти и ги препраща към един или повече бекенд сървъри. Представете си го като рецепционист, който приема всички гости и ги насочва към правилната стая.
- Round Robin – Прост алгоритъм за разпределяне на заявки, при който всяка нова заявка отива към следващия сървър в списъка.
- Health Check – Механизъм за автоматично следене на състоянието на сървърите, за да се избягва изпращането на трафик към неработещи инстанции.
- Sticky Sessions – Метод, при който заявките от един и същ клиент винаги се насочват към един и същ сървър, за да се запази състоянието на сесията.
- SSL Termination – Процес, при който криптираната връзка (HTTPS) се разшифрова на reverse proxy-то, а към бекенд сървърите се препраща некриптиран трафик.
- Layer 4 vs Layer 7 Load Balancing – Разлика между балансиране на транспортно ниво (IP/порт) и на приложно ниво (HTTP/URL).

## 4. Step-by-step Learning Path

1. **Разберете основната мотивация за load balancing**
   - Фокус: Защо е нужно разпределение на трафика?
   - Практическа задача: Нарисувайте схема на система с един сървър и такава с load balancer и няколко сървъра.
   - Въпроси: Какви са предимствата на load balancing? Какво би се случило без него?

2. **Изучете reverse proxy концепцията**
   - Фокус: Какво прави reverse proxy и как се различава от forward proxy?
   - Практическа задача: Опишете с думи или схема как reverse proxy обработва заявка от клиент.
   - Въпроси: Какви са основните функции на reverse proxy? Къде се поставя в архитектурата?

3. **Запознайте се с основните алгоритми за разпределение**
   - Фокус: Разлика между round robin, least connections, IP hash и др.
   - Практическа задача: Симулирайте с лист хартия как round robin разпределя 10 заявки към 3 сървъра.
   - Въпроси: Кога бихте избрали round robin пред least connections?

4. **Практика с реален инструмент (например Nginx или HAProxy)**
   - Фокус: Конфигуриране на прост load balancer и reverse proxy.
   - Практическа задача: Настройте Nginx като reverse proxy пред два локални уеб сървъра.
   - Въпроси: Как изглежда конфигурацията? Как проверявате дали работи?

5. **Разберете допълнителни функции (health checks, sticky sessions, SSL termination)**
   - Фокус: Как тези функции подобряват надеждността и сигурността?
   - Практическа задача: Добавете health check към вашия load balancer.
   - Въпроси: Какво се случва, ако един сървър спре да отговаря?

## 5. Examples

### Пример 1: Load balancing с Nginx

```nginx
http {
    upstream backend_servers {
        server 127.0.0.1:8001;
        server 127.0.0.1:8002;
    }

    server {
        listen 80;
        location / {
            proxy_pass http://backend_servers;
        }
    }
}
```
Този конфиг разпределя трафика между два бекенд сървъра.

### Пример 2: Reverse proxy за AI inference API

```nginx
server {
    listen 443 ssl;
    server_name ai.example.com;

    ssl_certificate /etc/ssl/cert.pem;
    ssl_certificate_key /etc/ssl/key.pem;

    location /api/ {
        proxy_pass http://localhost:5000/;
    }
}
```
Тук Nginx приема HTTPS заявки и ги препраща към локален AI inference сървър.

### Пример 3: Health check с HAProxy

```haproxy
backend app_servers
    balance roundrobin
    server app1 192.168.1.10:80 check
    server app2 192.168.1.11:80 check
```
HAProxy автоматично следи здравето на сървърите и не изпраща трафик към неработещи инстанции.

## 6. Common Pitfalls

- **Пропускане на health checks:** Без тях, трафикът може да се насочва към неработещи сървъри. Винаги настройвайте автоматични проверки.
- **Липса на SSL termination:** Ако не използвате SSL termination на reverse proxy-то, може да изложите данни на риск или да затрудните бекенд сървърите.
- **Неправилно конфигурирани sticky sessions:** Може да доведе до неравномерно натоварване или загуба на сесии.
- **Недостатъчно ресурси за load balancer-а:** Ако самият load balancer стане bottleneck, цялата система страда.
- **Пренебрегване на Layer 7 правила:** Понякога е нужно да се балансира по URL или header, а не само по IP/порт.

## 7. Short Retrieval Quiz

1. Каква е основната цел на load balancer-а?
2. Каква е разликата между reverse proxy и forward proxy?
3. Как работи round robin алгоритъмът?
4. Какво е health check и защо е важно?
5. Какво представлява SSL termination?
6. Какво може да се случи, ако липсва sticky session при stateful приложение?
7. Къде в архитектурата се поставя reverse proxy?

## 8. Quick Recap

- Load balancer-ът разпределя трафика между няколко сървъра за по-добра производителност и надеждност.
- Reverse proxy приема клиентски заявки и ги препраща към бекенд сървъри, често добавяйки кеширане, сигурност и други функции.
- Основни алгоритми за разпределение са round robin, least connections и други.
- Health checks гарантират, че трафикът се насочва само към работещи сървъри.
- Sticky sessions са важни за приложения, които пазят състояние на сесията.
- SSL termination опростява управлението на криптираните връзки.
- Правилната конфигурация на тези компоненти е критична за скалируемостта и сигурността на системата.

## 9. Spaced Review Plan

| Review Time | Prompt                                                                 |
|-------------|------------------------------------------------------------------------|
| 1 day       | Обяснете разликата между load balancer и reverse proxy с пример.       |
| 3 days      | Избройте и обяснете основните алгоритми за разпределяне на трафик.     |
| 1 week      | Опишете как работят health checks и какво се случва при неуспех.       |
| 1 month     | Дайте пример за реална архитектура с load balancer и reverse proxy.    |