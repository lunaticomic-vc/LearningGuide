# 16 - Rate limiting throttling and backpressure

## 1. Activate Prior Knowledge

- Какво се случва, когато една услуга или API получи твърде много заявки за кратко време? Какви проблеми могат да възникнат?
- Можете ли да си спомните случай, когато дадено приложение или уебсайт е станал бавен или недостъпен поради голям трафик?
- Какви техники познавате за контролиране на натоварването в разпределени или мащабируеми системи?

## 2. Overview

Rate limiting, throttling и backpressure са ключови техники за контролиране на потока от заявки и данни в съвременните софтуерни системи. Те предпазват услугите от претоварване, осигуряват стабилност и гарантират справедливо разпределение на ресурсите между потребителите.

В контекста на AI системи, микросървиси или публични API-та, тези механизми ограничават броя на заявките, които един клиент може да изпрати за определен период. Това предотвратява злоупотреби, DDoS атаки и неочаквани сривове.

Backpressure е особено важен при обработка на потоци от данни (streaming), където бързината на входящите данни може да надвиши способността на системата да ги обработва. Чрез прилагане на тези техники, инженерите гарантират, че системите остават надеждни и предвидими дори при високо натоварване.

## 3. Key Concepts

- Rate limiting – Ограничаване на броя заявки, които клиент може да направи към услуга за определен интервал от време (например 100 заявки на минута). Аналогия: като брояч на посетители на клуб, който допуска само определен брой хора вътре.
- Throttling – Умишлено забавяне или ограничаване на скоростта на обработка на заявки, за да се избегне претоварване. Може да се приложи динамично според текущото натоварване.
- Backpressure – Механизъм, при който системата сигнализира на източника на данни да намали скоростта на изпращане, когато не може да обработи повече. Мислете за това като за задръстване на магистрала, където се ограничава потокът на коли.
- Burst – Кратък период с много интензивен трафик, който може да надвиши нормалните лимити.
- Token bucket/Leaky bucket – Алгоритми за реализиране на rate limiting чрез използване на „кофа“ с токени или капки, които се попълват с определена скорост.
- Fairness (Справедливост) – Гарантиране, че всички клиенти получават равен достъп до ресурсите.

## 4. Step-by-step Learning Path

1. **Разберете нуждата от rate limiting и throttling**
   - Фокус: Защо са необходими тези техники в реални системи.
   - Задача: Намерете пример за публичен API с rate limiting (напр. Twitter API) и опишете лимитите му.
   - Въпроси: Какви проблеми решава rate limiting? Какво може да се случи без него?

2. **Изучете основните алгоритми (Token bucket, Leaky bucket)**
   - Фокус: Как работят най-често използваните алгоритми.
   - Задача: Нарисувайте схема или диаграма на token bucket алгоритъм.
   - Въпроси: Каква е разликата между token bucket и leaky bucket?

3. **Имплементирайте прост rate limiter**
   - Фокус: Практическа реализация на rate limiting.
   - Задача: Напишете прост rate limiter на избран от вас език (например Python).
   - Въпроси: Как ще тествате дали вашият rate limiter работи коректно?

4. **Разберете и приложете backpressure**
   - Фокус: Как се реализира backpressure при обработка на потоци.
   - Задача: Използвайте библиотека за стрийминг (напр. RxPy или Node.js streams) и демонстрирайте backpressure.
   - Въпроси: Какво се случва, ако няма backpressure в потокова система?

5. **Интегрирайте rate limiting и backpressure в реална архитектура**
   - Фокус: Как тези техники се комбинират в мащабируеми системи.
   - Задача: Опишете как бихте внедрили rate limiting и backpressure в микросървисна архитектура.
   - Въпроси: Какви са предизвикателствата при внедряване на тези техники в разпределени системи?

## 5. Examples

### Пример 1: Rate limiting в REST API

```python
from flask import Flask, request, jsonify
from time import time

app = Flask(__name__)
user_requests = {}

RATE_LIMIT = 5  # 5 заявки на минута

@app.route('/data')
def data():
    user = request.remote_addr
    now = time()
    requests = user_requests.get(user, [])
    # Изчистване на стари заявки
    requests = [req for req in requests if now - req < 60]
    if len(requests) >= RATE_LIMIT:
        return jsonify({'error': 'Rate limit exceeded'}), 429
    requests.append(now)
    user_requests[user] = requests
    return jsonify({'data': 'Here is your data'})
```

### Пример 2: Backpressure в Node.js stream

```javascript
const fs = require('fs');
const readable = fs.createReadStream('largefile.txt');
const writable = fs.createWriteStream('output.txt');

readable.pipe(writable);
// Node.js автоматично прилага backpressure между stream-овете
```

### Пример 3: Token bucket алгоритъм (псевдокод)

```
if tokens > 0:
    process_request()
    tokens -= 1
else:
    reject_request()
```

## 6. Common Pitfalls

- **Прекалено агресивни лимити** – Ако лимитите са твърде ниски, легитимни потребители ще бъдат блокирани. Винаги тествайте с реалистичен трафик.
- **Липса на комуникация с клиента** – Клиентите трябва да получават ясни съобщения (напр. HTTP 429) и информация кога могат да опитат отново.
- **Неотчитане на burst трафик** – Само статичен лимит може да блокира кратки пикове. Използвайте burst allowance, ако е необходимо.
- **Backpressure не е имплементиран** – При потокови системи липсата на backpressure може да доведе до загуба на данни или срив.
- **Лоша синхронизация в разпределени системи** – Rate limiting трябва да е координиран между инстанции, иначе може да бъде заобиколен.

## 7. Short Retrieval Quiz

1. Каква е основната цел на rate limiting?
2. Каква е разликата между throttling и rate limiting?
3. Как работи token bucket алгоритъмът?
4. Какво е backpressure и кога се използва?
5. Какъв HTTP статус код се използва при превишен лимит?
6. Какви са потенциалните последствия от липсата на rate limiting?
7. Как се гарантира справедливост между клиентите при rate limiting?

## 8. Quick Recap

- Rate limiting, throttling и backpressure предпазват системите от претоварване.
- Rate limiting ограничава броя заявки за определен период.
- Throttling контролира скоростта на обработка на заявки.
- Backpressure сигнализира на източника да намали потока от данни.
- Алгоритми като token bucket и leaky bucket са стандартни за rate limiting.
- Правилната настройка на лимитите е критична за добър потребителски опит.
- Тези техники са ключови за стабилността на мащабируеми и разпределени системи.

## 9. Spaced Review Plan

| Време      | Преговори/Примери за припомняне                          |
|------------|---------------------------------------------------------|
| 1 ден      | Обяснете разликата между rate limiting и throttling.     |
| 3 дни      | Нарисувайте token bucket и обяснете как работи.          |
| 1 седмица  | Дайте пример за backpressure и защо е важен.             |
| 1 месец    | Опишете как бихте внедрили rate limiting в микросървис.  |