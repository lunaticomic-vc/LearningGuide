# 08 - Consistency models and CAP PACELC trade-offs

## 1. Activate Prior Knowledge

- Какво означава „консистентност“ в контекста на разпределени бази данни или системи?
- Можете ли да дадете пример за ситуация, в която една система трябва да избира между бързина и надеждност?
- Какви предизвикателства възникват, когато множество сървъри обработват едни и същи данни едновременно?

## 2. Overview

В разпределените системи, като бази данни, файлови системи или мащабируеми AI платформи, често се налага да избираме между различни свойства: консистентност, наличност и устойчивост към сривове. Тези избори са формализирани чрез модели на консистентност и теореми като CAP и PACELC.

CAP теоремата твърди, че при наличие на мрежови разделения, една система може да гарантира само две от следните три: консистентност, наличност и устойчивост към разделения (Partition tolerance). PACELC разширява тази идея, като добавя дилемата между латентност и консистентност дори когато няма разделение.

Разбирането на тези модели е ключово за проектирането на надеждни, мащабируеми и бързи системи, особено в сферата на AI, където обработката на големи обеми данни в реално време е критична. Изборът на подходящ модел влияе върху поведението на приложенията, потребителското изживяване и устойчивостта при грешки.

## 3. Key Concepts

- Consistency (Консистентност) – Всички клиенти виждат едни и същи данни по едно и също време. Мислете за това като за „единна истина“.
- Availability (Наличност) – Винаги получавате отговор от системата, дори ако той не е най-актуалният.
- Partition Tolerance (Устойчивост към разделения) – Системата продължава да работи, дори ако комуникацията между части от нея е прекъсната.
- CAP Theorem (CAP теорема) – Не може да имате едновременно консистентност, наличност и устойчивост към разделения; трябва да изберете две.
- PACELC – Разширение на CAP, което казва: Ако има разделение (P), избирате между консистентност (C) и наличност (A); иначе (Else), избирате между латентност (L) и консистентност (C).
- Strong Consistency (Силна консистентност) – Всички операции виждат последната записана стойност.
- Eventual Consistency (Крайна консистентност) – С времето всички копия на данните ще се изравнят, но не веднага.
- Latency (Латентност) – Времето, необходимо за отговор на заявка.

## 4. Step-by-step Learning Path

1. **Разберете основите на CAP теоремата**
   - Фокус: Какво означават C, A и P и защо не могат да се постигнат едновременно.
   - Задача: Нарисувайте Venn диаграма на CAP и маркирайте реални системи (напр. Cassandra, MongoDB, etcd) в нея.
   - Въпроси: Какво жертва една CP система? Какво печели една AP система?
2. **Изследвайте различните модели на консистентност**
   - Фокус: Разлика между силна, слаба и крайна консистентност.
   - Задача: Опишете сценарий, в който eventual consistency е приемлива (напр. социални мрежи).
   - Въпроси: Кога е критично да имаме strong consistency? Какви са рисковете при eventual consistency?
3. **Запознайте се с PACELC модела**
   - Фокус: Как PACELC добавя дилемата между латентност и консистентност.
   - Задача: Попълнете таблица за няколко бази данни (DynamoDB, Cassandra, Spanner) според PACELC.
   - Въпроси: Какво означава EL в PACELC? Как се отразява на latency?
4. **Приложете знанията в реален проект**
   - Фокус: Избор на подходящ модел за конкретно приложение (напр. AI inference, банкови транзакции).
   - Задача: Напишете кратко техническо решение за избор на база данни с обосновка спрямо CAP/PACELC.
   - Въпроси: Какви trade-offs правите? Какво би се случило при мрежово разделение?

## 5. Examples

### Пример 1: Банкова система (CP)

В банковите транзакции е критично да има силна консистентност (CP – Consistency, Partition tolerance). Ако клиент тегли пари, балансът трябва да се актуализира навсякъде веднага.

```python
# Примерен псевдокод за транзакция със силна консистентност
begin_transaction()
  debit(account_A, 100)
  credit(account_B, 100)
commit_transaction()
```

### Пример 2: Социална мрежа (AP/ECP)

Публикациите и лайковете могат да се появят с леко закъснение, но системата трябва винаги да отговаря (Availability). Eventual consistency е приемлива.

```python
# Публикуване на статус, който се синхронизира по-късно между сървърите
post_status(user_id, "Hello world!")
# Сървърите репликират публикацията асинхронно
```

### Пример 3: PACELC в Cassandra

Cassandra избира AP/EL: при разделение жертва консистентност, а без разделение – избира ниска латентност пред силна консистентност.

## 6. Common Pitfalls

- **Неправилен избор на модел** – Използване на eventual consistency за критични финансови операции може да доведе до загуба на данни.
- **Подценяване на мрежовите разделения** – Много системи не са тествани за split-brain сценарии.
- **Пренебрегване на latency** – Изборът на силна консистентност може да доведе до неприемливо забавяне за потребителите.
- **Липса на яснота за бизнес изискванията** – Не всички приложения изискват най-строгата консистентност.

## 7. Short Retrieval Quiz

1. Какво означава „partition tolerance“ в CAP теоремата?
2. Кога е подходящо да използваме eventual consistency?
3. Какво добавя PACELC модела към CAP?
4. Дайте пример за система, която избира availability пред consistency.
5. Какви са рисковете при използване на AP система за банкови транзакции?
6. Как latency влияе на избора на консистентност?
7. Какво означава strong consistency?

## 8. Quick Recap

- CAP теоремата ограничава едновременната реализация на консистентност, наличност и устойчивост към разделения.
- PACELC добавя дилемата между латентност и консистентност, дори без разделения.
- Изборът на модел зависи от бизнес нуждите и техническите ограничения.
- Strong consistency гарантира „единна истина“, но може да е по-бавна.
- Eventual consistency позволява по-висока наличност и мащабируемост, но с риск от временни несъответствия.
- Различните системи (напр. банкови срещу социални мрежи) изискват различни trade-offs.
- Ясното разбиране на тези модели е критично за проектиране на надеждни разпределени системи.

## 9. Spaced Review Plan

| Време      | Преговори/Примери за припомняне                        |
|------------|-------------------------------------------------------|
| 1 ден      | Обяснете CAP/PACELC на колега с пример от реалния свят|
| 3 дни      | Класифицирайте 3 бази данни според PACELC             |
| 1 седмица  | Опишете trade-off за ново AI приложение               |
| 1 месец    | Решете казус: избор на модел за глобална система      |