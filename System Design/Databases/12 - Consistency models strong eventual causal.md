# 12 - Consistency models strong eventual causal

## 1. Activate Prior Knowledge

- Какви са основните предизвикателства при поддържането на консистентност в разпределени системи, особено когато множество възли обработват заявки едновременно?
- Можете ли да си спомните ситуации, в които различни части на една система са виждали различни стойности на едни и същи данни? Какви проблеми или компромиси възникват?
- Какви видове консистентност познавате и как те влияят върху производителността и надеждността на системите, например в бази данни или AI приложения?

## 2. Overview

В разпределените системи консистентността определя как и кога актуализациите на данните стават видими за всички участници. Това е критично важно за системи, които трябва да работят коректно дори при мрежови закъснения, сривове или паралелни операции. 

Съществуват различни модели на консистентност, всеки с различни гаранции и компромиси между производителност, наличност и коректност. Три от най-важните са strong consistency (силна консистентност), eventual consistency (крайна консистентност) и causal consistency (каузална консистентност).

Тези модели са фундаментални за изграждането на мащабируеми бази данни, кеширащи системи и AI инфраструктури, където изборът на подходящ модел влияе пряко върху поведението на приложенията и потребителското преживяване.

Разбирането на разликите между strong, eventual и causal consistency е ключово за всеки софтуерен инженер или AI специалист, който проектира или поддържа разпределени системи.

## 3. Key Concepts

- **Strong Consistency** – Всички възли виждат едни и същи данни по всяко време след запис; всяко четене връща най-новата стойност. Аналогия: всички гледат един и същи часовник.
- **Eventual Consistency** – С течение на времето всички копия на данните ще се изравнят, но за кратки периоди може да има разминавания. Аналогия: група хора, които в крайна сметка се събират на едно място, но не едновременно.
- **Causal Consistency** – Ако една операция е причинена от друга (например, отговор на съобщение), всички възли ще видят тези операции в същия ред. Аналогия: ако някой зададе въпрос, а друг отговори, всички трябва първо да видят въпроса, после отговора.
- **Consistency Model** – Формално описание на правилата, които определят кога и как актуализациите на данните стават видими в системата.
- **Replication Lag** – Времето, необходимо за синхронизиране на данните между възлите.
- **Partition Tolerance** – Способността на системата да продължи да работи, дори ако има мрежови разделения между възли.

## 4. Step-by-step Learning Path

1. **Разгледайте различните модели на консистентност**  
   - Фокус: Разберете дефинициите и основните разлики между strong, eventual и causal consistency.
   - Практическа задача: Създайте таблица, сравняваща трите модела по гаранции, latency и типични приложения.
   - Retrieval: Какво означава strong consistency? Каква е основната разлика между eventual и causal consistency?

2. **Изследвайте реални сценарии за прилагане на всеки модел**  
   - Фокус: Свържете моделите с конкретни технологии (напр. DynamoDB, Cassandra, MongoDB).
   - Практическа задача: Намерете документация на една база данни и определете кой модел на консистентност поддържа.
   - Retrieval: Коя база данни използва eventual consistency? Какви са плюсовете на causal consistency?

3. **Симулирайте конфликтни операции**  
   - Фокус: Разберете как системите се справят с едновременни записи и четения.
   - Практическа задача: Напишете малък скрипт, който симулира две конкурентни актуализации и наблюдавайте резултата при различни модели.
   - Retrieval: Какво би се случило при strong consistency? А при eventual?

4. **Анализирайте компромисите между консистентност, наличност и производителност**  
   - Фокус: Приложете CAP теоремата към избора на модел.
   - Практическа задача: Опишете сценарий, в който бихте избрали eventual пред strong consistency.
   - Retrieval: Как CAP теоремата ограничава избора на консистентност?

## 5. Examples

### Пример 1: Strong Consistency в банкови транзакции

В банково приложение, когато клиент изтегли пари, всички възли трябва веднага да отразят новия баланс. Това изисква strong consistency.

```python
# Примерен псевдокод
account.withdraw(100)
assert account.get_balance() == 900  # Винаги вярно на всички възли
```

### Пример 2: Eventual Consistency в социални мрежи

Публикация във Facebook може да се появи с леко закъснение при някои потребители, но в крайна сметка всички ще я видят.

### Пример 3: Causal Consistency в чат приложения

Ако потребител изпрати съобщение, а друг отговори, всички участници трябва да видят първо въпроса, после отговора, дори ако има мрежови закъснения.

```python
# Потребител А: "Как си?"
# Потребител Б: "Добре съм!"
# Всички клиенти виждат съобщенията в този ред
```

## 6. Common Pitfalls

- **Предположение за strong consistency по подразбиране** – Много инженери очакват, че всички системи са силно консистентни, което не е вярно за повечето мащабируеми решения.
- **Подценяване на replication lag** – При eventual consistency може да има значително закъснение, което води до объркване или грешки.
- **Неправилно разбиране на causal dependencies** – Пропускането на причинно-следствени връзки може да доведе до неочакван ред на операциите.
- **Избор на неподходящ модел за критични приложения** – Използването на eventual consistency за финансови или критични данни може да доведе до сериозни проблеми.

## 7. Short Retrieval Quiz

1. Каква е основната гаранция на strong consistency?
2. Какво означава eventual consistency?
3. Каква е разликата между eventual и causal consistency?
4. Дайте пример за приложение, където causal consistency е по-добра от strong consistency.
5. Как replication lag влияе на потребителското преживяване?
6. Как CAP теоремата ограничава избора на консистентност?
7. Какво би се случило, ако използвате eventual consistency за банкови транзакции?

## 8. Quick Recap

- Консистентността определя кога и как актуализациите стават видими в разпределени системи.
- Strong consistency гарантира, че всички виждат най-новите данни веднага.
- Eventual consistency допуска временни разминавания, но всички възли в крайна сметка се изравняват.
- Causal consistency гарантира, че причинно-свързани операции се виждат в правилния ред.
- Изборът на модел зависи от нуждите на приложението и компромисите между производителност и надеждност.
- CAP теоремата показва, че не можем да имаме едновременно силна консистентност, наличност и устойчивост на разделения.
- Неправилният избор на модел може да доведе до сериозни грешки или лошо потребителско преживяване.

## 9. Spaced Review Plan

| Review Time | Prompt                                           |
|-------------|--------------------------------------------------|
| 1 day       | Обяснете разликата между strong, eventual и causal consistency с пример. |
| 3 days      | Кои приложения изискват strong consistency и защо? |
| 1 week      | Как бихте обяснили causal consistency на колега? |
| 1 month     | Как CAP теоремата влияе върху избора на консистентност в реални системи? |