# 12 - Service discovery and API gateway design

## 1. Activate Prior Knowledge

- Как бихте описали процеса, по който различни микросервизи намират и комуникират един с друг в голяма система?
- Какви предизвикателства възникват, когато множество клиенти трябва да достъпват множество бекенд услуги?
- Можете ли да дадете пример за централизирана точка на достъп до API в реален проект?

## 2. Overview

Service discovery и API gateway са два ключови компонента в съвременните дистрибутирани системи, особено при микросервизни архитектури. Service discovery позволява на услугите да намират и комуникират една с друга динамично, без твърдо зададени адреси. Това е критично важно, когато услугите се мащабират автоматично или се разполагат динамично в облак.

API gateway действа като централен вход за всички клиентски заявки към бекенд услугите. Той опростява клиентската логика, предоставяйки единен интерфейс, и често се грижи за задачи като удостоверяване, ограничаване на трафика, маршрутизиране и агрегация на отговори.

Тези два компонента са фундаментални за изграждането на надеждни, мащабируеми и лесни за поддръжка системи, особено когато се използват контейнери, Kubernetes или други облачни платформи. Те позволяват на екипите да внедряват нови услуги по-лесно и да управляват сложността на разпределените среди.

## 3. Key Concepts

- **Service Discovery** – Механизъм, чрез който услугите автоматично намират местоположението (IP/порт) на други услуги в системата. Може да бъде централизирано (като Consul, Eureka) или децентрализирано.
- **API Gateway** – Централизирана точка за вход на всички API заявки, която маршрутизира, валидира и обработва трафика към бекенд услугите. Може да се сравни с рецепционист, който насочва посетителите към правилните отдели.
- **Service Registry** – База данни или услуга, в която се регистрират всички налични услуги и техните адреси. Подобно на телефонен указател за услуги.
- **Load Balancing** – Разпределяне на входящите заявки между множество инстанции на услуга, за да се осигури висока достъпност и производителност.
- **Circuit Breaker** – Механизъм, който предотвратява претоварването на неработещи услуги, като временно прекъсва заявките към тях.
- **Reverse Proxy** – Сървър, който приема клиентски заявки и ги препраща към подходящите бекенд услуги, често използван като част от API gateway.

## 4. Step-by-step Learning Path

1. **Разберете нуждата от service discovery**
   - Фокус: Защо статичните адреси не работят в динамични среди?
   - Практическа задача: Опишете сценарий, в който дадена услуга се мащабира автоматично и как това влияе на комуникацията между услугите.
   - Retrieval: Какви са основните проблеми при статично конфигурирани адреси? Как service discovery ги решава?

2. **Изучете основните типове service discovery**
   - Фокус: Централизирано vs. децентрализирано откриване.
   - Практическа задача: Проучете и сравнете Consul и DNS-based service discovery.
   - Retrieval: Какви са предимствата на централизираното откриване? Кога бихте използвали DNS подход?

3. **Разберете ролята на API gateway**
   - Фокус: Какви задачи изпълнява един API gateway?
   - Практическа задача: Начертайте схема на система с API gateway между клиенти и бекенд услуги.
   - Retrieval: Какви са основните ползи от използването на API gateway? Какви функции може да изпълнява?

4. **Имплементирайте базов service discovery**
   - Фокус: Регистрация и откриване на услуги.
   - Практическа задача: Използвайте Docker Compose или Kubernetes, за да регистрирате и откриете услуга.
   - Retrieval: Как се регистрира услуга? Как другите услуги я намират?

5. **Настройте прост API gateway**
   - Фокус: Маршрутизиране и проксиране на заявки.
   - Практическа задача: Конфигурирайте NGINX или Kong като API gateway за две тестови услуги.
   - Retrieval: Как API gateway маршрутизира заявките? Как може да се добави удостоверяване?

## 5. Examples

### Пример 1: Service Discovery с Consul

```yaml
# docker-compose.yml
version: '3'
services:
  consul:
    image: consul
    ports:
      - "8500:8500"
  web:
    image: my-web-service
    environment:
      - CONSUL_HTTP_ADDR=consul:8500
```
Услугата `web` се регистрира автоматично в Consul и други услуги могат да я открият чрез API на Consul.

### Пример 2: API Gateway с NGINX

```nginx
http {
  upstream backend {
    server service1:8080;
    server service2:8080;
  }

  server {
    listen 80;
    location /api/ {
      proxy_pass http://backend;
    }
  }
}
```
NGINX приема всички заявки към `/api/` и ги разпределя между `service1` и `service2`.

### Пример 3: API Gateway с удостоверяване

```yaml
# Kong declarative config
services:
  - name: example-service
    url: http://service1:8080
routes:
  - name: example-route
    paths:
      - /api/
plugins:
  - name: key-auth
```
Kong изисква API ключ за достъп до бекенд услугата.

## 6. Common Pitfalls

- **Твърдо кодирани адреси** – Използването на статични IP адреси или портове води до чупливи системи. Винаги използвайте service discovery.
- **Претоварване на API gateway** – Ако gateway-ът не е мащабиран или защитен, може да стане bottleneck или single point of failure.
- **Липса на здравословни проверки** – Без health checks, service registry може да съдържа остарели или неработещи услуги.
- **Прекалено сложни правила за маршрутизиране** – Сложната конфигурация затруднява поддръжката и увеличава риска от грешки.
- **Пропускане на сигурността** – Ако не се добавят удостоверяване и rate limiting, gateway-ът става уязвим.

## 7. Short Retrieval Quiz

1. Каква е основната роля на service discovery в микросервизни архитектури?
2. Какви задачи изпълнява един API gateway?
3. Какво е service registry и защо е важно?
4. Какви са рисковете при използване на твърдо кодирани адреси между услугите?
5. Как API gateway може да подобри сигурността на системата?
6. Каква е разликата между централизирано и децентрализирано service discovery?
7. Какви са основните предимства на използването на reverse proxy като API gateway?

## 8. Quick Recap

- Service discovery позволява динамично откриване на услуги в дистрибутирани среди.
- API gateway централизира достъпа до бекенд услуги и опростява клиентската логика.
- Service registry съхранява информация за наличните услуги и техните адреси.
- Load balancing и health checks са критични за надеждността.
- Reverse proxy често се използва като API gateway.
- Пропуските в сигурността и мащабирането са чести проблеми.
- Добрият дизайн улеснява внедряването и поддръжката на сложни системи.

## 9. Spaced Review Plan

| Time      | Review Prompt                                               |
|-----------|------------------------------------------------------------|
| 1 day     | Обяснете разликата между service discovery и API gateway.   |
| 3 days    | Начертайте схема на система с API gateway и service registry.|
| 1 week    | Дайте пример за реална грешка при service discovery и как да я избегнете. |
| 1 month   | Обобщете основните предимства и рискове на API gateway архитектурата. |