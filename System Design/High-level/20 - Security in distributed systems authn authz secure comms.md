# 20 - Security in distributed systems authn authz secure comms

## 1. Activate Prior Knowledge

- Какви са основните разлики между автентикация (authentication) и оторизация (authorization) в контекста на уеб приложения или API?
- Какви рискове възникват, когато комуникацията между отделни компоненти на разпределена система не е защитена?
- Можете ли да дадете пример за протокол или технология, която осигурява сигурна комуникация между сървъри или услуги?

## 2. Overview

Сигурността в разпределените системи е критична, защото множество независими компоненти комуникират помежду си, често през ненадеждни мрежи. Основните аспекти на тази сигурност са автентикацията (идентифициране на участниците), оторизацията (управление на достъпа до ресурси) и защитената комуникация (гарантиране на поверителност и цялост на данните).

В разпределените системи, като микросървисни архитектури или AI платформи, всеки компонент трябва да може да се довери на останалите, че са това, за което се представят, и че комуникацията не може да бъде подслушвана или манипулирана от трети страни. Това изисква интеграция на стандартизирани протоколи и добри практики.

Без правилно прилагане на тези принципи, системата става уязвима към атаки като подправяне на самоличност, неоторизиран достъп, man-in-the-middle и изтичане на чувствителна информация. Сигурността трябва да бъде вградена на всички нива на архитектурата.

## 3. Key Concepts

- Authentication (AuthN) – Процесът на проверка на идентичността на потребител или услуга. Представете си го като проверка на лична карта на входа.
- Authorization (AuthZ) – Определя какви действия или ресурси са позволени за дадена идентичност. Може да се сравни с това дали имате ключ за определена врата в сграда.
- Secure Communication – Използване на криптографски протоколи (като TLS) за защита на данните при пренос между компоненти.
- Token – Криптографски подписан маркер, който удостоверява самоличност и права (например JWT).
- Mutual TLS (mTLS) – Двустранна автентикация чрез сертификати между клиент и сървър.
- Principle of Least Privilege – Всеки компонент има достъп само до това, което му е необходимо.
- Man-in-the-Middle Attack – Атака, при която трета страна прихваща или променя комуникацията между две страни.
- OAuth 2.0 – Протокол за делегирана оторизация, често използван за API достъп.

## 4. Step-by-step Learning Path

1. **Разграничете автентикация и оторизация**
   - Фокус: Разберете разликата между двете понятия и защо са нужни и двете.
   - Задача: Опишете с две изречения какво проверява автентикацията и какво – оторизацията.
   - Въпроси: Какво се случва, ако имате автентикация, но не и оторизация? Може ли да имате оторизация без автентикация?

2. **Изучете основните протоколи за сигурна комуникация**
   - Фокус: TLS, mTLS, HTTPS.
   - Задача: Настройте локален HTTPS сървър или клиент с самоподписан сертификат.
   - Въпроси: Как TLS защитава данните? Каква е разликата между TLS и mTLS?

3. **Работа с токени за автентикация и оторизация**
   - Фокус: JWT, OAuth 2.0, OpenID Connect.
   - Задача: Генерирайте и валидирайте JWT токен с библиотека по избор.
   - Въпроси: Какво съдържа един JWT? Как се използва в OAuth 2.0 flow?

4. **Прилагане на принципа на най-малките привилегии**
   - Фокус: Ограничаване на достъпа до ресурси.
   - Задача: Определете роли и права за примерна микросървисна система.
   - Въпроси: Какви са рисковете, ако дадете прекалено много права на един компонент?

5. **Тест и мониторинг на сигурността**
   - Фокус: Инструменти за анализ на трафика и откриване на уязвимости.
   - Задача: Използвайте инструмент като Wireshark, за да видите разликата между криптиран и некриптиран трафик.
   - Въпроси: Как може да разберете дали комуникацията е защитена? Какви индикатори търсите?

## 5. Examples

### Пример 1: OAuth 2.0 за API достъп

```python
# Python пример с библиотеката requests и OAuth2 токен
import requests

token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
headers = {"Authorization": f"Bearer {token}"}
response = requests.get("https://api.example.com/data", headers=headers)
print(response.json())
```

### Пример 2: Настройка на HTTPS сървър (Node.js)

```javascript
const https = require('https');
const fs = require('fs');

const options = {
  key: fs.readFileSync('server.key'),
  cert: fs.readFileSync('server.cert')
};

https.createServer(options, (req, res) => {
  res.writeHead(200);
  res.end("Hello Secure World!");
}).listen(443);
```

### Пример 3: Проверка на JWT токен

```python
import jwt

token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
secret = "mysecret"
try:
    payload = jwt.decode(token, secret, algorithms=["HS256"])
    print("Valid token:", payload)
except jwt.InvalidTokenError:
    print("Invalid token")
```

## 6. Common Pitfalls

- Смесване на автентикация и оторизация – Не приемайте, че щом някой е автентикиран, има право на всички действия.
- Използване на некриптирана комуникация – Използвайте винаги TLS/mTLS, дори за вътрешни услуги.
- Лошо управление на токени – Не съхранявайте токени в незащитени места и ги инвалидайте при нужда.
- Прекалено широки права – Давайте минимално необходимите права на всеки компонент.
- Пренебрегване на ротацията на ключове и сертификати – Редовно обновявайте и ревокирайте ключове.

## 7. Short Retrieval Quiz

1. Каква е основната разлика между authentication и authorization?
2. Какво е предназначението на TLS в разпределените системи?
3. Какво съдържа един JWT токен?
4. Какво представлява man-in-the-middle атака?
5. Как mutual TLS (mTLS) се различава от стандартния TLS?
6. Защо принципът на най-малките привилегии е важен?
7. Какви са рисковете при съхранение на токени в незащитени места?

## 8. Quick Recap

- Authentication и authorization са различни, но взаимно допълващи се процеси.
- Защитената комуникация предотвратява подслушване и манипулация на данни.
- Токените (напр. JWT) са стандартен начин за удостоверяване и делегиране на права.
- TLS и mTLS са основни протоколи за криптиране на трафика между компоненти.
- Принципът на най-малките привилегии намалява риска от злоупотреби.
- Лошото управление на ключове и токени води до сериозни уязвимости.
- Сигурността трябва да се прилага на всички нива на разпределената система.

## 9. Spaced Review Plan

| Време    | Преговори/Въпроси                                      |
|----------|--------------------------------------------------------|
| 1 ден    | Опишете разликата между AuthN и AuthZ.                 |
| 3 дни    | Как работи TLS/mTLS и защо е нужен?                    |
| 1 седмица| Какви са добрите практики при управление на токени?    |
| 1 месец  | Кои са най-честите грешки при имплементиране на сигурност? |