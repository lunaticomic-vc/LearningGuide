# 14 - Service discovery and DNS-based load distribution

## 1. Activate Prior Knowledge

- Как бихте намерили и свързали различни услуги в една мащабна AI система, без да знаете предварително техните IP адреси?
- Какво знаете за DNS и как се използва той за намиране на ресурси в интернет?
- Можете ли да си представите сценарий, в който множество сървъри обслужват една и съща услуга? Как клиентите избират към кой сървър да се свържат?

## 2. Overview

Service discovery и DNS-базираното разпределение на натоварването са ключови компоненти в съвременните разпределени системи и микросървисни архитектури. Те позволяват на различни части от системата да намират и комуникират една с друга динамично, без твърдо зададени адреси или ръчни конфигурации. Това е особено важно при автоматично скалиране на услуги или при чести промени в инфраструктурата.

DNS (Domain Name System) е най-разпространеният механизъм за откриване на услуги, тъй като предоставя централизирана и добре позната система за разрешаване на имена към IP адреси. Чрез DNS-базирано разпределение на натоварването, множество инстанции на една услуга могат да бъдат достъпни чрез едно и също име, а клиентите автоматично се насочват към различни сървъри.

В контекста на AI системи, където често има множество работещи компоненти (напр. inference сървъри, бази данни, кешове), service discovery улеснява автоматизацията, гъвкавостта и устойчивостта на системата. Това намалява риска от грешки и улеснява поддръжката.

## 3. Key Concepts

- **Service Discovery** – Механизъм, чрез който приложенията автоматично намират местоположението (IP, порт) на други услуги в системата. Представете си го като телефонен указател за услуги.
- **DNS (Domain Name System)** – Глобална система за превръщане на имена (като www.example.com) в IP адреси. Мислете за него като за интернет "адресна книга".
- **Load Balancing** – Разпределение на клиентските заявки между множество сървъри, за да се избегне претоварване и да се увеличи надеждността.
- **DNS-based Load Distribution** – Използване на DNS за връщане на множество IP адреси за едно име, като клиентите се насочват към различни сървъри (обикновено чрез "round-robin").
- **SRV Record** – Вид DNS запис, който предоставя информация за услугата, протокола, домейна, порта и приоритета. Позволява по-гъвкаво откриване на услуги.
- **Health Checking** – Механизъм за проверка дали дадена услуга/инстанция работи коректно, преди да бъде включена в списъка за откриване.

## 4. Step-by-step Learning Path

1. **Разберете основите на DNS**
   - Фокус: Как работи DNS и как се използва за разрешаване на имена.
   - Задача: Използвайте командата `nslookup` или `dig`, за да намерите IP адресите на даден домейн.
   - Въпроси: Какво връща DNS при заявка? Какво е A-запис?

2. **Изучете DNS-базираното разпределение на натоварването**
   - Фокус: Как DNS може да връща множество IP адреси за едно име.
   - Задача: Създайте локален DNS запис с няколко IP адреса и наблюдавайте как клиентите се разпределят.
   - Въпроси: Как DNS избира кой IP адрес да върне? Какво е round-robin?

3. **Запознайте се с SRV записите и тяхното приложение**
   - Фокус: Как SRV записите позволяват откриване на услуги по порт и протокол.
   - Задача: Добавете SRV запис във вашия DNS сървър и го разрешете с `dig`.
   - Въпроси: Каква информация съдържа един SRV запис? Защо е полезен?

4. **Интегрирайте service discovery във ваше приложение**
   - Фокус: Как приложенията могат динамично да откриват други услуги.
   - Задача: Конфигурирайте приложение да използва DNS за намиране на backend сървъри.
   - Въпроси: Какво се случва, ако една инстанция отпадне? Как се обновява информацията?

5. **Разберете ограниченията и алтернативите на DNS-базираното откриване**
   - Фокус: Кога DNS не е достатъчен и какви други подходи съществуват (напр. Consul, etcd, Eureka).
   - Задача: Проучете и сравнете един алтернативен инструмент за service discovery.
   - Въпроси: Какви са предимствата и недостатъците на DNS спрямо специализираните решения?

## 5. Examples

### Пример 1: DNS round-robin load balancing

DNS запис за услуга с три backend сървъра:
```
service.example.com.   IN  A   10.0.0.1
service.example.com.   IN  A   10.0.0.2
service.example.com.   IN  A   10.0.0.3
```
Клиентите, които правят DNS заявки, ще получават различен IP адрес на ротационен принцип.

### Пример 2: SRV запис за откриване на услуга

```
_service._tcp.example.com. 3600 IN SRV 10 60 8080 server1.example.com.
_service._tcp.example.com. 3600 IN SRV 20 20 8080 server2.example.com.
```
Това указва, че услугата е достъпна на порт 8080 на два различни сървъра, с различни приоритети и тегла.

### Пример 3: Python код за DNS-based service discovery

```python
import dns.resolver

answers = dns.resolver.resolve('service.example.com', 'A')
for rdata in answers:
    print("Service instance IP:", rdata.address)
```

## 6. Common Pitfalls

- **DNS кеширане:** Прекалено дългото кеширане (TTL) може да доведе до остаряла информация за услугите. Използвайте подходящи стойности за TTL.
- **Липса на health checking:** DNS не знае дали дадена инстанция е "жива". Използвайте външни механизми за health checking или интегрирайте с load balancer.
- **Недостатъчна скалируемост:** DNS не е проектиран за много динамични среди с чести промени. Помислете за специализирани решения при нужда.
- **Round-robin не е винаги "балансиран":** Клиентите може да кешират IP адреси и да не разпределят натоварването равномерно.

## 7. Short Retrieval Quiz

1. Каква е основната роля на service discovery в разпределените системи?
2. Как работи DNS-базираното разпределение на натоварването?
3. Какво съдържа един SRV DNS запис?
4. Какви са ограниченията на DNS при откриване на услуги?
5. Как може да се избегне проблемът с остарялата информация в DNS?
6. Какво е health checking и защо е важно?
7. Дайте пример за реална ситуация, в която service discovery е критично необходимо.

## 8. Quick Recap

- Service discovery позволява автоматично намиране на услуги в динамични среди.
- DNS е най-разпространеният механизъм за базово откриване и разпределение на натоварването.
- DNS може да връща множество IP адреси за едно име (round-robin).
- SRV записите позволяват по-гъвкаво и детайлно откриване на услуги.
- DNS има ограничения при динамични промени и липса на health checking.
- За по-сложни нужди се използват специализирани инструменти като Consul, etcd, Eureka.
- Правилната конфигурация на TTL и интеграция с health checking са критични за надеждността.

## 9. Spaced Review Plan

| Review Time | Prompt                                               |
|-------------|------------------------------------------------------|
| 1 day       | Обяснете как DNS подпомага service discovery.        |
| 3 days      | Дайте пример за SRV запис и опишете неговата роля.   |
| 1 week      | Избройте ограниченията на DNS-базираното откриване.  |
| 1 month     | Сравнете DNS с алтернативни инструменти за discovery.|