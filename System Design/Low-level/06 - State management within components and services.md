# 06 - State management within components and services

## 1. Activate Prior Knowledge

- Какво разбирате под „състояние“ (state) в контекста на един софтуерен компонент или услуга?
- Можете ли да дадете пример, когато неправилното управление на състоянието е довело до бъг или неочаквано поведение в дадено приложение?
- Как според вас се различава управлението на състояние в малки компоненти спрямо големи, разпределени системи (например в AI системи)?

## 2. Overview

Управлението на състоянието (state management) е процесът на съхраняване, актуализиране и синхронизиране на данните, които определят текущото поведение на даден компонент или услуга. В съвременните софтуерни системи, особено в уеб и AI приложения, състоянието може да включва всичко – от потребителски вход до резултати от изчисления или междинни данни.

В рамките на един компонент състоянието често е локално и се използва за управление на изгледа или логиката. Когато обаче няколко компонента или услуги трябва да споделят или синхронизират състояние, възникват допълнителни предизвикателства, свързани с последователността, производителността и предсказуемостта.

Ефективното управление на състоянието е ключово за изграждането на надеждни, мащабируеми и лесни за поддръжка приложения. Грешки в управлението на състоянието често водят до труднооткриваеми бъгове, проблеми със синхронизацията и нежелани странични ефекти.

## 3. Key Concepts

- State (Състояние) – Данните, които описват текущото положение или конфигурация на даден компонент или услуга. Може да се сравни с моментна снимка на вътрешния свят на системата.
- Local State (Локално състояние) – Състояние, което се поддържа вътре в един компонент и не се споделя директно с други компоненти. Мислете за това като за личен бележник на компонента.
- Shared State (Споделено състояние) – Състояние, което се използва от множество компоненти или услуги. Подобно на общ документ, който няколко души редактират.
- State Mutation (Мутация на състоянието) – Процесът на промяна на състоянието. Важно е да се контролира кога и как се случва, за да се избегнат неочаквани резултати.
- State Synchronization (Синхронизация на състоянието) – Поддържане на съгласуваност между различни части на системата, които използват едно и също състояние.
- Stateless vs. Stateful (Безсъстояние срещу със състояние) – Stateless компонентите не съхраняват информация между отделните извиквания, докато stateful компонентите пазят състояние през времето.
- Service (Услуга) – Независим модул или обект, който може да управлява или съхранява състояние, често използван за споделяне на данни между компоненти.

## 4. Step-by-step Learning Path

1. **Разберете локалното състояние**
   - Фокус: Как се дефинира и използва състоянието вътре в един компонент.
   - Практическа задача: Създайте прост UI компонент (например брояч), който увеличава стойността си при натискане на бутон.
   - Въпроси: Как се съхранява стойността на брояча? Какво ще се случи, ако компонентът се презареди?

2. **Използване на услуги за споделено състояние**
   - Фокус: Как услугите могат да съхраняват и предоставят състояние на множество компоненти.
   - Практическа задача: Имплементирайте услуга, която пази списък със задачи, и два компонента, които го използват (един за добавяне, друг за показване).
   - Въпроси: Как компонентите получават достъп до състоянието? Как се гарантира, че и двата виждат актуалното състояние?

3. **Мутация и синхронизация на състоянието**
   - Фокус: Как се променя състоянието и как се уведомяват другите компоненти.
   - Практическа задача: Добавете възможност за изтриване на задача и се уверете, че всички компоненти се обновяват.
   - Въпроси: Как се разпространяват промените? Какво се случва, ако два компонента променят състоянието едновременно?

4. **Избягване на странични ефекти**
   - Фокус: Как да се предотвратят неочаквани промени или бъгове при управление на състоянието.
   - Практическа задача: Въведете логика за валидиране на входа преди промяна на състоянието.
   - Въпроси: Какви проверки са нужни преди да се промени състоянието? Какво може да се обърка, ако не се валидира входът?

5. **Мащабиране и оптимизация**
   - Фокус: Как се управлява състоянието в по-големи системи или при множество потребители.
   - Практическа задача: Помислете как бихте синхронизирали състоянието между няколко клиента (например чрез WebSocket или централен сървър).
   - Въпроси: Какви са предизвикателствата при споделяне на състояние в разпределена среда? Как може да се минимизират конфликтите?

## 5. Examples

### Пример 1: Локално състояние в React компонент

```jsx
function Counter() {
  const [count, setCount] = useState(0);
  return (
    <button onClick={() => setCount(count + 1)}>
      Брой: {count}
    </button>
  );
}
```

### Пример 2: Споделено състояние чрез услуга (Angular)

```typescript
@Injectable({ providedIn: 'root' })
export class TaskService {
  private tasks: string[] = [];
  getTasks() { return this.tasks; }
  addTask(task: string) { this.tasks.push(task); }
}
```

### Пример 3: Синхронизация на състояние между компоненти

```javascript
// EventEmitter за уведомяване на компоненти
class StateService {
  constructor() {
    this.state = {};
    this.listeners = [];
  }
  setState(newState) {
    this.state = { ...this.state, ...newState };
    this.listeners.forEach(cb => cb(this.state));
  }
  subscribe(cb) {
    this.listeners.push(cb);
  }
}
```

## 6. Common Pitfalls

- **Мутация на състоянието директно** – В много рамки (например React) директната промяна на state може да доведе до неочаквано поведение. Винаги използвайте предоставените методи за актуализация.
- **Липса на синхронизация** – Ако няколко компонента използват споделено състояние, но не се уведомяват за промени, може да се появят несъответствия.
- **Прекалено централизиране на състоянието** – Съхраняването на твърде много данни в един глобален state може да направи системата трудна за поддръжка.
- **Неясна граница между локално и споделено състояние** – Ясно дефинирайте кое състояние трябва да е локално и кое – споделено.
- **Липса на валидиране при промяна на състоянието** – Винаги проверявайте входните данни преди да ги запишете в state.

## 7. Short Retrieval Quiz

1. Каква е разликата между локално и споделено състояние?
2. Какво е основното предимство на използването на услуга за управление на състояние?
3. Какво може да се случи, ако директно модифицирате state в React?
4. Какви са рисковете при липса на синхронизация между компоненти?
5. Дайте пример за страничен ефект при неправилно управление на състоянието.
6. Какво означава „stateless“ компонент?
7. Как може да се избегнат конфликти при едновременна промяна на споделено състояние?

## 8. Quick Recap

- Състоянието определя текущото поведение на компонент или услуга.
- Локалното състояние се използва вътре в един компонент, докато споделеното се използва от няколко.
- Услугите често се използват за централизиране и споделяне на състояние между компоненти.
- Мутацията на състоянието трябва да се контролира и валидира.
- Синхронизацията е ключова при споделено състояние, за да се избегнат несъответствия.
- Прекалената централизация или липсата на ясна структура води до трудна поддръжка.
- Добро управление на състоянието прави приложенията по-надеждни и предвидими.

## 9. Spaced Review Plan

| Кога    | Преговори/Приложи следното:                                             |
|---------|-------------------------------------------------------------------------|
| 1 ден   | Обяснете разликата между локално и споделено състояние с пример.        |
| 3 дни   | Имплементирайте прост stateful компонент и услуга за споделено състояние.|
| 1 седмица | Анализирайте реален бъг, свързан с управление на състоянието.         |
| 1 месец | Обсъдете стратегии за мащабиране на state management в големи системи.   |