# 12 - Metrics collection and distributed tracing

## 1. Activate Prior Knowledge

- Как бихте открили и анализирали забавяне или грешка в сложна AI система, която използва множество микросървиси?
- Какви видове данни за производителност или състояние събирате обикновено от софтуерни системи?
- Можете ли да си представите сценарий, в който проследяването на отделни заявки през различни компоненти би било критично важно?

## 2. Overview

Metrics collection и distributed tracing са два основни подхода за наблюдение и анализ на поведението на сложни софтуерни системи, особено такива, изградени от множество взаимодействащи си услуги (микросървиси). Metrics предоставят агрегирана, количествена информация за системата – например брой заявки, време за отговор, използване на ресурси. Distributed tracing позволява проследяване на конкретни заявки или операции през различни компоненти, като така се разбира къде възникват забавяния или грешки.

Тези техники са особено важни при AI системи, където обработката често преминава през различни слоеве – от API gateway, през inference сървъри, до бази данни. Без подходящо събиране на метрики и проследяване, диагностицирането на проблеми става почти невъзможно.

В съвременните DevOps практики, metrics и tracing се интегрират с инструменти като Prometheus, Grafana, Jaeger или OpenTelemetry, които автоматизират събирането, визуализацията и анализа на данните. Това позволява по-бърза реакция при инциденти и оптимизация на производителността.

## 3. Key Concepts

- **Metric** – Квантитативна мярка за състоянието или производителността на система (например latency, throughput). Мислете за това като за "здравен пулс" на системата.
- **Instrumentation** – Процесът на добавяне на код или агенти, които събират метрики или trace данни. Подобно на поставяне на сензори по важни точки.
- **Distributed trace** – Запис на пътя, който заявка изминава през множество услуги, с времеви отпечатъци за всяка стъпка. Като следа от стъпки в сняг, която показва откъде е минала заявката.
- **Span** – Отделна операция или сегмент в trace-а, с начало и край. Представете си го като един етап от пътуване.
- **Tag/Label** – Допълнителна информация, прикрепена към метрика или span (напр. user_id, endpoint), която улеснява филтрирането и анализа.
- **Aggregation** – Обобщаване на сурови метрики (напр. средно време за отговор за последната минута).
- **Sampling** – Избор на подмножество от заявки за tracing, за да се намали натоварването.

## 4. Step-by-step Learning Path

1. **Разберете разликата между metrics и tracing**
   - Фокус: Какво измерват метриките и какво показва tracing-а.
   - Практическа задача: Опишете с думи как бихте използвали метрики и tracing за анализ на бавна AI inference заявка.
   - Retrieval: Каква е основната разлика между метрика и trace? Кога бихте използвали едното пред другото?

2. **Изберете подходящ инструмент за metrics**
   - Фокус: Запознайте се с Prometheus или друг инструмент за събиране на метрики.
   - Практическа задача: Инсталирайте Prometheus и съберете базова метрика (напр. CPU usage) от локален сървър.
   - Retrieval: Какви типове метрики са най-полезни за наблюдение на AI inference сървър?

3. **Инструментирайте код за събиране на метрики**
   - Фокус: Добавете код за събиране на latency и throughput метрики.
   - Практическа задача: Използвайте библиотека (напр. Prometheus client) и измерете latency на примерна функция.
   - Retrieval: Как бихте добавили метрика за брой обработени заявки в Python приложение?

4. **Въведете distributed tracing**
   - Фокус: Разберете как работи tracing и как се интегрира с код.
   - Практическа задача: Интегрирайте Jaeger или OpenTelemetry в demo приложение и визуализирайте trace на заявка.
   - Retrieval: Какво е span и как се различава от trace?

5. **Анализирайте и визуализирайте данните**
   - Фокус: Използвайте Grafana или Jaeger UI за анализ на събраните данни.
   - Практическа задача: Създайте dashboard с latency и error rate; намерете "bottleneck" в trace.
   - Retrieval: Как визуализацията помага при диагностика на проблеми?

## 5. Examples

### Пример 1: Събиране на latency метрика с Prometheus в Python

```python
from prometheus_client import Summary, start_http_server
import time

REQUEST_LATENCY = Summary('request_latency_seconds', 'Latency of requests')

@REQUEST_LATENCY.time()
def process_request():
    time.sleep(0.5)  # Симулира бавна операция

if __name__ == '__main__':
    start_http_server(8000)
    while True:
        process_request()
```

### Пример 2: Distributed tracing с OpenTelemetry

```python
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import SimpleSpanProcessor, ConsoleSpanExporter

trace.set_tracer_provider(TracerProvider())
tracer = trace.get_tracer(__name__)
span_processor = SimpleSpanProcessor(ConsoleSpanExporter())
trace.get_tracer_provider().add_span_processor(span_processor)

with tracer.start_as_current_span("inference_request") as span:
    # Симулирайте обработка
    time.sleep(0.2)
    span.set_attribute("model", "resnet50")
    span.set_attribute("status", "success")
```

### Пример 3: Визуализация на trace в Jaeger

- След интеграция на Jaeger, trace-овете се визуализират като времеви линии, където всеки span показва колко време е отнела дадена операция (например "API call", "DB query", "Model inference").

## 6. Common Pitfalls

- **Събиране на твърде много данни:** Прекомерното instrumentation води до голямо натоварване и труден анализ. Изберете ключови метрики и trace-ове.
- **Липса на контекст в trace-овете:** Ако не добавяте тагове (напр. user_id, request_id), трудно ще филтрирате и анализирате trace-ове.
- **Неправилно агрегиране:** Грешно конфигурирани агрегации могат да скрият проблеми (напр. използване само на средни стойности вместо percentiles).
- **Липса на автоматизация:** Ръчното събиране и анализ е неустойчиво – използвайте инструменти за автоматизация и визуализация.
- **Пренебрегване на sampling:** Без sampling tracing-ът може да натовари сериозно продукционната система.

## 7. Short Retrieval Quiz

1. Каква е основната разлика между метрика и trace?
2. Какво е span в контекста на distributed tracing?
3. Какви инструменти се използват за събиране и визуализация на метрики?
4. Защо е важно да добавяме тагове към метрики и trace-ове?
5. Какво е sampling и защо се използва при tracing?
6. Как може да се използва distributed tracing за откриване на bottleneck?
7. Какви са рисковете при събиране на твърде много метрики?

## 8. Quick Recap

- Metrics collection и distributed tracing са ключови за наблюдение и диагностика на сложни системи.
- Метриките дават агрегирана картина на производителността, докато tracing-ът показва пътя на отделна заявка.
- Инструменти като Prometheus, Grafana, Jaeger и OpenTelemetry автоматизират процеса.
- Instrumentation е процесът на добавяне на код за събиране на данни.
- Таговете и агрегациите улесняват анализа и филтрирането.
- Sampling намалява натоварването от tracing.
- Визуализацията подпомага бързото откриване на проблеми и оптимизация.

## 9. Spaced Review Plan

| Време      | Преговори/Въпроси за припомняне                                 |
|------------|---------------------------------------------------------------|
| 1 ден      | Каква е разликата между метрика и trace?                      |
| 3 дни      | Как бихте инструментировали AI inference endpoint?             |
| 1 седмица  | Кои са най-важните метрики и тагове за вашата система?        |
| 1 месец    | Опишете процеса на откриване на bottleneck с tracing.         |