# 21 - Architectural patterns CQRS event sourcing layered hexagonal

## 1. Activate Prior Knowledge

- Какви са основните предимства и недостатъци на традиционната трислойна (three-tier) архитектура при изграждане на сложни софтуерни системи?
- Кога и защо бихте разделили операциите за четене и запис в една система? Можете ли да дадете пример от реален проект или система?
- Какви са предизвикателствата при проследяване на всички промени в данните във времеемки или критични системи (например финансови или AI системи)?

## 2. Overview

Архитектурните шаблони като CQRS, Event Sourcing, Layered и Hexagonal са фундаментални за изграждането на мащабируеми, поддържани и адаптивни софтуерни системи. Те предоставят различни начини за структуриране на кода, обработка на заявки и управление на състоянието, което е особено важно при сложни домейни и динамично променящи се изисквания.

CQRS (Command Query Responsibility Segregation) разделя операциите за четене и запис, което позволява оптимизация и независима еволюция на всяка страна. Event Sourcing записва всички промени като събития, което осигурява пълна история и възможност за възстановяване на състоянието във всеки момент. Layered архитектурата структурира системата на слоеве с ясни отговорности, докато Hexagonal (или Ports and Adapters) архитектурата насърчава изолацията на бизнес логиката от външните интерфейси.

Тези шаблони често се комбинират, за да се постигне по-голяма гъвкавост, тестируемост и устойчивост на промените – качества, които са критични за съвременните AI системи и сложни бизнес приложения.

## 3. Key Concepts

- CQRS (Command Query Responsibility Segregation) – Разделя операциите за модифициране на състоянието (Commands) и операциите за извличане на данни (Queries) в отделни модели. Мислете за това като за две различни "пътеки" към една и съща система.
- Event Sourcing – Съхранява всички промени в системата като неизменяеми събития, вместо да пази само текущото състояние. Подобно на история на версиите в Git.
- Layered Architecture – Организира кода в слоеве (например: презентационен, бизнес, данни), всеки със своя отговорност. Аналогия: като етажи в сграда, всеки със собствена функция.
- Hexagonal Architecture (Ports and Adapters) – Изолира бизнес логиката от инфраструктурата чрез "портове" и "адаптери", което улеснява тестването и интеграцията. Представете си ядро, защитено от външни влияния чрез интерфейси.
- Command – Операция, която променя състоянието на системата (например: "създай поръчка").
- Query – Операция, която само чете данни, без да ги променя (например: "вземи списък с поръчки").
- Domain Model – Представяне на бизнес логиката и правилата на системата.
- Adapter – Компонент, който свързва външни системи или интерфейси с вътрешната логика.

## 4. Step-by-step Learning Path

1. **Разбери Layered архитектурата**
   - Фокус: Как се разделят отговорностите между слоевете.
   - Практическа задача: Нарисувай схема на трислойна архитектура за проста система (напр. онлайн магазин).
   - Retrieval въпроси: Какви са основните слоеве? Какви са предимствата на този подход?

2. **Изучи Hexagonal архитектурата**
   - Фокус: Как се изолират бизнес логиката и инфраструктурата.
   - Практическа задача: Идентифицирай портове и адаптери в съществуващ проект или пример.
   - Retrieval въпроси: Каква е ролята на портовете? Какво печелим от тази изолация?

3. **Овладей CQRS**
   - Фокус: Разделяне на четене и запис; кога и защо се използва.
   - Практическа задача: Имплементирай отделни класове или функции за Commands и Queries в малък модул (напр. управление на потребители).
   - Retrieval въпроси: Какви са ползите от разделянето? Какви са потенциалните усложнения?

4. **Разбери Event Sourcing**
   - Фокус: Как се записват и възстановяват събитията.
   - Практическа задача: Напиши прост Event Store за записване и възстановяване на събития (може и с масив в паметта).
   - Retrieval въпроси: Какви са предимствата на Event Sourcing? Как се възстановява състоянието?

5. **Комбинирай шаблоните**
   - Фокус: Как работят заедно CQRS, Event Sourcing и Hexagonal архитектурата.
   - Практическа задача: Опиши или имплементирай малка система, която използва всички тези шаблони (например: система за резервации).
   - Retrieval въпроси: Как се интегрират CQRS и Event Sourcing? Как Hexagonal архитектурата помага при тестове?

## 5. Examples

### Пример 1: CQRS в система за поръчки

```csharp
// Command: Създай поръчка
public class CreateOrderCommand {
    public string CustomerId { get; set; }
    public List<string> ProductIds { get; set; }
}

// Query: Вземи поръчки за клиент
public class GetOrdersQuery {
    public string CustomerId { get; set; }
}
```

### Пример 2: Event Sourcing – Записване на събития

```python
# Събитие: Поръчка създадена
class OrderCreatedEvent:
    def __init__(self, order_id, customer_id, product_ids):
        self.order_id = order_id
        self.customer_id = customer_id
        self.product_ids = product_ids

# Event Store (ин-мемори)
event_store = []
event_store.append(OrderCreatedEvent(1, 'C123', ['P1', 'P2']))
```

### Пример 3: Hexagonal Architecture – Порт и адаптер

```java
// Порт (интерфейс)
public interface PaymentPort {
    void processPayment(Order order);
}

// Адаптер за PayPal
public class PaypalAdapter implements PaymentPort {
    public void processPayment(Order order) {
        // интеграция с PayPal API
    }
}
```

## 6. Common Pitfalls

- Смесване на четене и запис в един и същи модел при CQRS, което води до сложност и трудна поддръжка.
- Липса на идемпотентност при Event Sourcing – повторно прилагане на събития може да доведе до неконсистентно състояние.
- Прекалено сложна архитектура за малки или прости системи – тези шаблони не винаги са оправдани.
- Недостатъчно тестване на адаптерите при Hexagonal архитектура, което води до неоткрити интеграционни грешки.
- Проблеми със синхронизацията между Command и Query страните при CQRS, особено при eventual consistency.

## 7. Short Retrieval Quiz

1. Какво означава CQRS и какво разделя?
2. Как Event Sourcing съхранява промените в системата?
3. Каква е основната цел на Hexagonal архитектурата?
4. Какви са основните слоеве в Layered архитектурата?
5. Каква е разликата между Command и Query?
6. Какво е Adapter в Hexagonal архитектурата?
7. Кога CQRS и Event Sourcing са особено полезни?

## 8. Quick Recap

- CQRS разделя четене и запис за по-голяма гъвкавост и мащабируемост.
- Event Sourcing съхранява историята на всички промени като събития.
- Layered архитектурата структурира системата на слоеве с ясни отговорности.
- Hexagonal архитектурата изолира бизнес логиката от инфраструктурата чрез портове и адаптери.
- Command променя състоянието, Query само чете данни.
- Комбинирането на тези шаблони води до по-устойчиви и лесни за поддръжка системи.
- Важно е да се избере подходящата архитектура според сложността и нуждите на проекта.

## 9. Spaced Review Plan

| Време      | Преговори/Примери за припомняне                       |
|------------|------------------------------------------------------|
| 1 ден      | Опиши с думи CQRS и Event Sourcing.                  |
| 3 дни      | Нарисувай схема на Hexagonal архитектура.            |
| 1 седмица  | Дай пример за Command и Query в реална система.      |
| 1 месец    | Обясни кога би комбинирал всички шаблони и защо.      |