# 13 - Reverse proxying, API gateways, and ingress controllers

## 1. Activate Prior Knowledge

- Какви са основните разлики между клиент-сървър и peer-to-peer архитектури в съвременните уеб приложения?
- Как бихте защитили и управлявали достъпа до множество микросървиси в една голяма AI система?
- Кога и защо бихте използвали посредник (proxy) между клиент и сървър?

## 2. Overview

Reverse proxy, API gateway и ingress controller са ключови компоненти в съвременните софтуерни архитектури, особено при микросървисни и облачни среди. Те служат като посредници между клиентите и вътрешните услуги, като предоставят контрол върху трафика, сигурност, баланс на натоварването и централизирано управление на достъпа.

В контекста на AI системи и мащабируеми уеб приложения, тези компоненти позволяват ефективно маршрутизиране на заявки, скриване на вътрешната инфраструктура и прилагане на политики за сигурност и автентикация. Те са критични за устойчивостта, наблюдаемостта и лесната интеграция на нови услуги.

Reverse proxy обикновено се използва за пренасочване на заявки към един или повече бекенд сървъри, докато API gateway предоставя по-широк набор от функционалности като rate limiting, трансформация на заявки и централизирана автентикация. Ingress controller е специфичен за Kubernetes и управлява външния достъп до услуги в клъстера.

Разбирането и правилното използване на тези компоненти е фундаментално за изграждане на сигурни, мащабируеми и лесни за управление системи.

## 3. Key Concepts

- **Reverse Proxy** – Сървър, който приема клиентски заявки и ги препраща към един или повече бекенд сървъри. Може да се сравни с рецепционист, който насочва посетителите към правилния офис.
- **API Gateway** – Централен вход за всички API заявки, който управлява маршрутизация, сигурност, лимитиране и трансформация на данни. Подобно на портиер, който проверява и насочва посетителите според техните нужди.
- **Ingress Controller** – Kubernetes компонент, който управлява външния HTTP/HTTPS достъп до услуги в клъстера чрез Ingress ресурси.
- **Load Balancing** – Разпределяне на входящите заявки между множество сървъри за оптимална производителност и надеждност.
- **TLS Termination** – Процес, при който криптираната връзка (HTTPS) се разкодира на proxy/gateway, а към бекенда се предава некриптиран трафик.
- **Service Discovery** – Механизъм за автоматично откриване на наличните услуги в динамична среда.
- **Rate Limiting** – Ограничаване на броя заявки за определен период, за да се предотврати претоварване или злоупотреба.

## 4. Step-by-step Learning Path

1. **Разберете ролята на reverse proxy**
   - Фокус: Как работи reverse proxy и кога се използва.
   - Практическа задача: Инсталирайте и конфигурирайте Nginx като reverse proxy за прост уеб сървър.
   - Въпроси: Каква е разликата между forward и reverse proxy? Какви са ползите от използването на reverse proxy?

2. **Изследвайте API gateways**
   - Фокус: Основни функции на API gateway и разликите с reverse proxy.
   - Практическа задача: Настройте Kong или API Gateway на AWS за маршрутизиране на две различни API услуги.
   - Въпроси: Как API gateway подобрява сигурността? Какви допълнителни функции предлага спрямо reverse proxy?

3. **Научете за ingress controllers в Kubernetes**
   - Фокус: Как ingress controller управлява външния достъп до Kubernetes услуги.
   - Практическа задача: Деплойнете ingress controller (например NGINX Ingress) и създайте Ingress ресурс за вашето приложение.
   - Въпроси: Каква е разликата между service type LoadBalancer и Ingress? Какви са предимствата на използването на Ingress?

4. **Практикувайте интеграция и наблюдение**
   - Фокус: Интегриране на логване, мониторинг и rate limiting.
   - Практическа задача: Добавете логиране и rate limiting към reverse proxy или API gateway.
   - Въпроси: Как се следи трафикът през proxy/gateway? Как се настройва rate limiting?

## 5. Examples

### Пример 1: Nginx като Reverse Proxy
```nginx
server {
    listen 80;
    server_name example.com;

    location / {
        proxy_pass http://localhost:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```
*Този конфиг насочва всички заявки към локален бекенд сървър на порт 5000.*

### Пример 2: Kong API Gateway Route
```yaml
routes:
  - name: example-route
    paths:
      - /api/v1
    service:
      name: example-service
```
*Тази конфигурация маршрутизира всички заявки към `/api/v1` към определена услуга.*

### Пример 3: Kubernetes Ingress Resource
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: example-ingress
spec:
  rules:
    - host: app.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: my-app-service
                port:
                  number: 80
```
*Ingress ресурс, който насочва трафика към Kubernetes услуга.*

## 6. Common Pitfalls

- **Неправилна маршрутизация** – Грешни правила или липса на host header може да доведе до неправилно насочване на трафика.
- **Липса на сигурност** – Пропускане на TLS termination или автентикация на gateway/proxy излага услугите на риск.
- **Претоварване на proxy/gateway** – Недостатъчно ресурси или липса на rate limiting може да доведе до отказ на услуги.
- **Неправилна интеграция с Kubernetes** – Грешна конфигурация на ingress controller или Ingress ресурси води до недостъпност на услугите.
- **Липса на мониторинг** – Без логиране и наблюдение е трудно да се открият проблеми или атаки.

## 7. Short Retrieval Quiz

1. Каква е основната функция на reverse proxy?
2. Какви допълнителни възможности предоставя API gateway спрямо reverse proxy?
3. Какво е ingress controller и къде се използва?
4. Какво представлява TLS termination и защо е важно?
5. Каква е ролята на rate limiting в API gateway?
6. Какви са рисковете при липса на централизирана автентикация?
7. Как се различава service type LoadBalancer от Ingress в Kubernetes?

## 8. Quick Recap

- Reverse proxy насочва клиентски заявки към бекенд сървъри и осигурява сигурност и баланс на натоварването.
- API gateway централизира управлението на API заявки, сигурност, rate limiting и трансформация на данни.
- Ingress controller управлява външния достъп до Kubernetes услуги чрез Ingress ресурси.
- Тези компоненти са критични за мащабируемост, сигурност и гъвкавост на съвременните системи.
- TLS termination и rate limiting са важни за сигурността и устойчивостта на инфраструктурата.
- Правилната конфигурация и мониторинг предотвратяват често срещани проблеми.
- Изборът между reverse proxy, API gateway и ingress controller зависи от архитектурата и нуждите на системата.

## 9. Spaced Review Plan

| Review Time | Prompt                                                                 |
|-------------|------------------------------------------------------------------------|
| 1 day       | Обяснете разликата между reverse proxy и API gateway с пример.         |
| 3 days      | Опишете как работи ingress controller в Kubernetes и кога се използва. |
| 1 week      | Избройте основните ползи от използването на API gateway.               |
| 1 month     | Дайте пример за типична грешка при конфигуриране на reverse proxy и как се избягва. |