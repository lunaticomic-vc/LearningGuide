# 11 - Replication and failover mechanisms

## 1. Activate Prior Knowledge

- Какво се случва, ако основният сървър на база данни спре да работи по време на важна AI задача?
- Как бихте осигурили, че критична услуга остава достъпна дори при хардуерен отказ?
- Какви техники познавате за синхронизиране на данни между различни сървъри или локации?

## 2. Overview

Replication и failover механизмите са основни техники за осигуряване на надеждност, устойчивост и непрекъсваемост на софтуерни и AI системи. Replication означава създаване и поддържане на копия на данни или услуги на различни сървъри или локации. Failover е процесът, при който системата автоматично превключва към резервен компонент при отказ на основния.

Тези механизми са критични в мащабируеми и високонадеждни архитектури, като облачни услуги, бази данни и AI inference платформи. Те минимизират риска от загуба на данни и прекъсване на услуги, което е особено важно при обработка на чувствителни или големи обеми от данни.

В контекста на AI системите, replication и failover гарантират, че обучението, предсказването и съхранението на модели могат да продължат дори при хардуерни или софтуерни проблеми. Това позволява на екипите да предоставят стабилни и надеждни решения на потребителите.

## 3. Key Concepts

- Replication – Процесът на създаване на едно или повече копия на данни или услуги. Може да се сравни с правенето на резервни копия на важни документи на различни места.
- Failover – Автоматично или ръчно превключване към резервен компонент при отказ на основния. Представете си, че имате резервен генератор, който се включва при спиране на тока.
- Primary/Secondary (Master/Slave) – Модел, при който един сървър е основен (primary), а другите са резервни (secondary), които копират данните от основния.
- Synchronous vs. Asynchronous Replication – Синхронната репликация изисква всички копия да се актуализират едновременно, докато асинхронната позволява закъснения между копията.
- Quorum – Механизъм за определяне на валидността на операция въз основа на броя на съгласуващите се възли (nodes).
- Heartbeat – Периодичен сигнал между сървъри за проверка на тяхната наличност.
- Split-brain – Ситуация, при която два или повече сървъра смятат, че са основни, което може да доведе до конфликтни данни.

## 4. Step-by-step Learning Path

1. **Разберете основите на replication**
   - Фокус: Какво представлява replication и защо е необходима.
   - Практическа задача: Намерете и опишете два реални примера за replication в облачни услуги.
   - Въпроси: Как replication предотвратява загуба на данни? Какви са типовете replication?

2. **Изучете failover механизмите**
   - Фокус: Как работи failover и кога се използва.
   - Практическа задача: Конфигурирайте прост failover сценарий с два уеб сървъра и един load balancer (може да използвате Docker).
   - Въпроси: Какви са предимствата на автоматичния failover? Какви рискове крие ръчният failover?

3. **Различавайте синхронна и асинхронна репликация**
   - Фокус: Разлики, предимства и недостатъци.
   - Практическа задача: Създайте диаграма, която показва потока на данни при двата типа replication.
   - Въпроси: Кога бихте избрали асинхронна репликация? Какви са рисковете при синхронната?

4. **Изследвайте реални инструменти и платформи**
   - Фокус: Как се реализират replication и failover в популярни системи (напр. PostgreSQL, MongoDB, Kubernetes).
   - Практическа задача: Настройте репликация в избрана база данни или контейнерна платформа.
   - Въпроси: Какви конфигурационни параметри са критични за надеждността? Как се следи състоянието на репликите?

5. **Анализирайте сценарии за split-brain и quorum**
   - Фокус: Как се предотвратяват и разрешават конфликти между възли.
   - Практическа задача: Симулирайте split-brain ситуация и опишете как се възстановява консистентността.
   - Въпроси: Какво е quorum? Как split-brain може да доведе до загуба на данни?

## 5. Examples

### Пример 1: Репликация в PostgreSQL

```bash
# Настройка на primary и standby сървър
# На primary:
wal_level = replica
max_wal_senders = 3

# На standby:
standby_mode = on
primary_conninfo = 'host=primary_host user=replicator password=secret'
```

### Пример 2: Автоматичен failover с Kubernetes

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: my-app
        image: my-app:latest
```
Kubernetes автоматично пренасочва трафика към работещите подове при отказ.

### Пример 3: Heartbeat мониторинг

```python
import time
import requests

while True:
    try:
        r = requests.get("http://secondary-server/heartbeat")
        if r.status_code == 200:
            print("Secondary is alive")
    except:
        print("Secondary is down!")
    time.sleep(5)
```

## 6. Common Pitfalls

- **Липса на тестове за failover** – Не разчитайте само на конфигурацията; винаги тествайте сценарии за отказ.
- **Неправилно конфигурирана асинхронна репликация** – Може да доведе до загуба на данни при срив на основния сървър.
- **Split-brain ситуации** – Ако не е осигурен quorum, може да има конфликтни данни.
- **Пренебрегване на latency** – Високата латентност между реплики може да забави синхронизацията.
- **Недостатъчен monitoring** – Без мониторинг не може да се реагира навреме при отказ.

## 7. Short Retrieval Quiz

1. Каква е основната цел на replication?
2. Какво представлява failover и кога се използва?
3. Каква е разликата между синхронна и асинхронна репликация?
4. Какво е split-brain и защо е опасно?
5. Какво е quorum и каква е ролята му при replication?
6. Дайте пример за реална система, използваща replication.
7. Как можете да проверите дали failover е сработил успешно?

## 8. Quick Recap

- Replication създава копия на данни/услуги за устойчивост.
- Failover осигурява автоматично превключване при отказ.
- Съществуват синхронна и асинхронна репликация с различни trade-off-и.
- Split-brain води до конфликтни данни и трябва да се избягва.
- Quorum гарантира валидността на операциите в разпределени системи.
- Monitoring и редовното тестване са критични за надеждността.
- Реалните платформи (PostgreSQL, Kubernetes) имат вградени механизми за replication и failover.

## 9. Spaced Review Plan

| Време      | Преговори/Въпроси                                      |
|------------|--------------------------------------------------------|
| 1 ден      | Обяснете разликата между replication и failover.       |
| 3 дни      | Опишете сценарий за split-brain и как се избягва.      |
| 1 седмица  | Настройте replication в избрана система и тествайте.   |
| 1 месец    | Анализирайте реален инцидент с failover и решенията.   |