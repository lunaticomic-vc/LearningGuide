# 25 - Multi-region database architecture

## 1. Activate Prior Knowledge

- Какви са основните предизвикателства при съхранението на данни в големи, разпределени системи?
- Какви са разликите между репликация и шардване на база данни?
- Какви проблеми могат да възникнат, ако потребителите на AI система са разпределени по целия свят, но данните се съхраняват само в един регион?

## 2. Overview

Мултирегионалната архитектура на бази данни е подход за проектиране и внедряване на бази данни, които са разпределени географски в няколко региона или центрове за данни. Този модел е от ключово значение за съвременните глобални приложения, които обслужват потребители по целия свят и изискват висока наличност, ниска латентност и устойчивост на сривове.

В контекста на AI системи и мащабни софтуерни платформи, мултирегионалните бази данни позволяват данните да бъдат по-близо до крайните потребители, което намалява времето за достъп и подобрява потребителското изживяване. Освен това, те осигуряват устойчивост при сривове на цял регион и позволяват съответствие с регулации за локализация на данните.

Този подход обаче въвежда нови предизвикателства, като синхронизация на данните между регионите, управление на консистентността и сложност при конфигуриране и поддръжка. Разбирането на тези аспекти е критично за всеки софтуерен инженер, който изгражда или поддържа глобални системи.

## 3. Key Concepts

- Region – Географски разположен център за данни. Може да се мисли като отделен град или държава, където се съхраняват и обработват данни.
- Replication – Копиране на данни между различни региони за повишаване на наличността и устойчивостта. Представете си го като правене на резервни копия на различни места.
- Latency – Времето, необходимо за пренос на данни между потребителя и базата данни. Колкото по-близо са данните до потребителя, толкова по-ниска е латентността.
- Consistency – Степента, до която всички копия на данните са синхронизирани. Може да се сравни с това дали всички клонове на банка показват една и съща наличност по сметката.
- Failover – Автоматично превключване към резервен регион при срив на основния. Подобно на резервен генератор при спиране на тока.
- Data sovereignty – Изискване данните да се съхраняват в определена държава или регион поради законови или регулаторни причини.
- Partitioning (Sharding) – Разделяне на данните на части, които се съхраняват в различни региони или сървъри, за по-добра мащабируемост.

## 4. Step-by-step Learning Path

1. **Разберете нуждата от мултирегионална архитектура**
   - Фокус: Кога и защо се използва този подход.
   - Практическа задача: Намерете реален пример за глобално приложение (например Netflix или Google Maps) и опишете защо би имало нужда от мултирегионална база данни.
   - Въпроси: Какви са основните ползи от мултирегионалната архитектура? Какви рискове адресира тя?

2. **Изучете основните модели на репликация**
   - Фокус: Разлика между синхронна и асинхронна репликация.
   - Практическа задача: Начертайте схема на синхронна и асинхронна репликация между два региона.
   - Въпроси: Кога бихте избрали синхронна пред асинхронна репликация? Какви са компромисите?

3. **Разберете CAP теоремата в мултирегионален контекст**
   - Фокус: Какви ограничения налага CAP теоремата при разпределени бази данни.
   - Практическа задача: Дайте пример за ситуация, в която трябва да изберете между консистентност и наличност.
   - Въпроси: Какво означава "partition tolerance"? Как мултирегионалността влияе на избора между C и A?

4. **Практикувайте конфигуриране на мултирегионална база данни**
   - Фокус: Настройки на мултирегионална база данни в облачна платформа (например Google Cloud Spanner, AWS Aurora Global).
   - Практическа задача: Създайте тестова мултирегионална база данни в избрана облачна платформа.
   - Въпроси: Какви настройки трябва да се направят за репликация? Как се управлява failover?

5. **Мониторинг и оптимизация**
   - Фокус: Как да следите латентност, консистентност и наличност.
   - Практическа задача: Настройте мониторинг за мултирегионална база данни и анализирайте отчетите.
   - Въпроси: Какви метрики са най-важни? Как бихте реагирали при увеличена латентност между регионите?

## 5. Examples

### Пример 1: Глобална AI платформа за препоръки

Компания с потребители в Европа, Азия и Америка използва мултирегионална база данни, за да съхранява потребителските профили близо до всеки регион. Това намалява времето за отговор на AI препоръките и осигурява устойчивост при срив на регион.

### Пример 2: AWS Aurora Global Database

```sql
-- Създаване на глобална база данни в AWS Aurora
CREATE GLOBAL DATABASE myglobaldb
  PRIMARY REGION 'eu-central-1'
  SECONDARY REGIONS 'us-east-1', 'ap-southeast-1';
```
Това позволява автоматична репликация и failover между регионите.

### Пример 3: Google Cloud Spanner

```python
# Python код за запис в мултирегионална Spanner база
import google.cloud.spanner

spanner_client = google.cloud.spanner.Client()
instance = spanner_client.instance('my-instance')
database = instance.database('my-db')

with database.batch() as batch:
    batch.insert(
        table='Users',
        columns=('UserId', 'Name'),
        values=[('123', 'Ivan Petrov')],
    )
```
Този запис ще бъде достъпен във всички региони, където е разположена базата.

## 6. Common Pitfalls

- **Подценяване на латентността между регионите** – Дори при бързи връзки, закъсненията могат да повлияят на потребителското изживяване.
- **Неправилен избор на модел за консистентност** – Прекалено стриктната консистентност може да намали производителността, а твърде слабата – да доведе до объркване на данните.
- **Липса на автоматичен failover** – Ако не е конфигуриран, срив в основния регион може да доведе до дълъг downtime.
- **Пренебрегване на законови изисквания за локализация на данните** – Може да доведе до глоби или правни проблеми.
- **Сложност при поддръжка и обновления** – Промените трябва да се координират между всички региони.

## 7. Short Retrieval Quiz

1. Каква е основната цел на мултирегионалната база данни?
2. Каква е разликата между синхронна и асинхронна репликация?
3. Какво означава failover в мултирегионален контекст?
4. Как CAP теоремата влияе на избора на архитектура?
5. Какви са основните предизвикателства при поддържане на консистентност между региони?
6. Защо е важно да се спазват изискванията за data sovereignty?
7. Какви метрики бихте следили при мониторинг на мултирегионална база данни?

## 8. Quick Recap

- Мултирегионалната архитектура позволява разпределено съхранение и достъп до данни в различни географски региони.
- Основните ползи са по-ниска латентност, висока наличност и устойчивост на сривове.
- Репликацията може да бъде синхронна или асинхронна, всяка с различни компромиси.
- CAP теоремата поставя ограничения при избора между консистентност, наличност и устойчивост на разделяне.
- Failover механизмите са критични за минимизиране на downtime.
- Законодателството за локализация на данните трябва да се взема предвид при проектиране.
- Мониторингът и оптимизацията са ключови за поддържане на производителността и надеждността.

## 9. Spaced Review Plan

| Кога     | Преговори/Въпроси за себе си                                      |
|----------|-------------------------------------------------------------------|
| 1 ден    | Мога ли да обясня разликата между синхронна и асинхронна репликация? |
| 3 дни    | Как бих конфигурирал failover между два региона?                  |
| 1 седмица| Какви са основните предизвикателства при мониторинг на мултирегионална база? |
| 1 месец  | Мога ли да дам пример за реална мултирегионална архитектура и нейните ползи? |