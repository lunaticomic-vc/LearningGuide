# 04 - Database normalization and denormalization

## 1. Activate Prior Knowledge

- Какво представлява релационната база данни и какви са основните ѝ компоненти (таблици, редове, колони)?
- Срещали ли сте проблеми с дублиране на данни или трудности при актуализиране на информация в база данни?
- Как мислите, че структурата на базата данни влияе върху производителността и поддръжката на софтуерни системи, особено при мащабни AI приложения?

## 2. Overview

Database normalization и denormalization са фундаментални техники за проектиране и оптимизация на релационни бази данни. Normalization представлява процес на организиране на данните така, че да се минимизират излишъците и да се избегнат аномалии при обновяване, вмъкване или изтриване на данни. Това се постига чрез разделяне на данните в свързани таблици, следвайки определени "нормални форми".

Denormalization, от друга страна, е процесът на умишлено въвеждане на излишъци (redundancy) с цел подобряване на производителността при четене, особено в системи с голям обем заявки за четене, като аналитични или AI системи.

Тези техники са критични при проектиране на бази данни за сложни софтуерни системи, където балансът между целостта на данните и бързодействието е от решаващо значение. В контекста на AI системи, правилната нормализация или денормализация може да ускори обработката на данни и да намали риска от грешки.

## 3. Key Concepts

- Normalization – Процес на структуриране на база данни чрез разделяне на таблици и дефиниране на връзки между тях, с цел минимизиране на излишъците и избягване на аномалии.
- Denormalization – Умишлено комбиниране на данни от различни таблици в една, за да се намали броят на JOIN операциите и да се ускори достъпът до данни.
- Normal Forms (NF) – Степени на нормализация (1NF, 2NF, 3NF, BCNF и др.), всяка със свои изисквания за структурата на таблиците.
- Anomaly – Нежелано поведение при обновяване, вмъкване или изтриване на данни, което може да възникне при лошо проектирана база данни (например update anomaly).
- Redundancy – Излишно дублиране на данни, което увеличава риска от несъответствия и усложнява поддръжката.
- Functional Dependency – Връзка между атрибути, при която стойността на един атрибут определя стойността на друг.
- JOIN – Операция за комбиниране на данни от две или повече таблици въз основа на общи атрибути.

## 4. Step-by-step Learning Path

1. **Разберете основните аномалии (insert, update, delete)**
   - Фокус: Какви проблеми възникват при дублиране на данни.
   - Задача: Опишете примерна таблица с дублирани данни и идентифицирайте потенциални аномалии.
   - Въпроси: Какво е update anomaly? Как може да се избегне?

2. **Изучете първите три нормални форми (1NF, 2NF, 3NF)**
   - Фокус: Какви са изискванията на всяка нормална форма.
   - Задача: Вземете проста таблица и я преобразувайте до 3NF.
   - Въпроси: Какви са разликите между 2NF и 3NF? Защо е важно да се стигне поне до 3NF?

3. **Практикувайте нормализация върху реален сценарий**
   - Фокус: Приложете наученото върху примерна база данни (напр. система за поръчки).
   - Задача: Разделете таблица с поръчки и клиенти на отделни таблици, дефинирайте ключове и връзки.
   - Въпроси: Какви функционални зависимости откривате? Какви ключове използвате?

4. **Разберете кога и защо се използва денормализация**
   - Фокус: Баланс между производителност и целостта на данните.
   - Задача: Идентифицирайте сценарий, където денормализация би ускорила заявки.
   - Въпроси: Какви са рисковете при денормализация? Как бихте ги контролирали?

5. **Измерете ефекта от нормализация и денормализация**
   - Фокус: Как се отразяват тези процеси на скоростта на заявки и поддръжката.
   - Задача: Направете сравнение между нормализирана и денормализирана схема с няколко примерни заявки.
   - Въпроси: Кога бихте предпочели денормализация пред нормализация?

## 5. Examples

### Пример 1: Нормализация на таблица с поръчки

Първоначална таблица:

| OrderID | CustomerName | ProductName | Quantity |
|---------|-------------|-------------|----------|
| 1       | Иван Иванов | Лаптоп      | 2        |
| 2       | Мария Петрова | Мишка     | 1        |
| 3       | Иван Иванов | Мишка       | 3        |

След нормализация (до 3NF):

**Customers**
| CustomerID | CustomerName   |
|------------|---------------|
| 1          | Иван Иванов    |
| 2          | Мария Петрова  |

**Products**
| ProductID | ProductName |
|-----------|-------------|
| 1         | Лаптоп      |
| 2         | Мишка       |

**Orders**
| OrderID | CustomerID |
|---------|------------|
| 1       | 1          |
| 2       | 2          |
| 3       | 1          |

**OrderDetails**
| OrderID | ProductID | Quantity |
|---------|-----------|----------|
| 1       | 1         | 2        |
| 2       | 2         | 1        |
| 3       | 2         | 3        |

---

### Пример 2: Денормализация за бързи отчети

Вместо да JOIN-вате няколко таблици, може да създадете денормализирана таблица:

| OrderID | CustomerName | ProductName | Quantity |
|---------|-------------|-------------|----------|
| 1       | Иван Иванов | Лаптоп      | 2        |
| 2       | Мария Петрова | Мишка     | 1        |
| 3       | Иван Иванов | Мишка       | 3        |

Това ускорява заявки за отчети, но увеличава риска от несъответствия при промяна на името на клиента или продукта.

---

### Пример 3: SQL JOIN при нормализирана база

```sql
SELECT c.CustomerName, p.ProductName, od.Quantity
FROM Orders o
JOIN Customers c ON o.CustomerID = c.CustomerID
JOIN OrderDetails od ON o.OrderID = od.OrderID
JOIN Products p ON od.ProductID = p.ProductID;
```

## 6. Common Pitfalls

- **Пренормализация**: Твърде много разделяне на таблици води до сложни заявки и влошена производителност. Балансирайте между нормализация и реални нужди.
- **Липса на нормализация**: Оставянето на всички данни в една таблица увеличава риска от аномалии и затруднява поддръжката.
- **Грешно разбиране на функционалните зависимости**: Пропускането на ключови зависимости води до непълна нормализация.
- **Денормализация без контрол**: Въвеждането на излишъци без механизми за синхронизация може да доведе до несъответствия и грешки.
- **Неправилно избрани ключове**: Липса на ясно дефинирани първични и външни ключове води до загуба на връзки между данните.

## 7. Short Retrieval Quiz

1. Каква е основната цел на нормализацията?
2. Какво представлява "update anomaly"?
3. Кога е подходящо да използваме денормализация?
4. Какво е функционална зависимост?
5. Какви са разликите между 1NF, 2NF и 3NF?
6. Какви са рисковете при денормализация?
7. Защо е важно да се дефинират първични и външни ключове?

## 8. Quick Recap

- Нормализацията минимизира излишъците и предотвратява аномалии в базите данни.
- Денормализацията ускорява заявки за четене, но увеличава риска от несъответствия.
- Основните нормални форми (1NF, 2NF, 3NF) осигуряват структурна цялост.
- Функционалните зависимости са в основата на нормализацията.
- JOIN операциите са чести при нормализирани схеми, но могат да бъдат тежки при големи обеми данни.
- Балансът между нормализация и денормализация зависи от конкретните нужди на системата.
- Добре дефинираните ключове и зависимости са критични за качествен дизайн.

## 9. Spaced Review Plan

| Review Time | Prompt                                                                 |
|-------------|------------------------------------------------------------------------|
| 1 day       | Обяснете разликата между нормализация и денормализация с пример.       |
| 3 days      | Избройте основните аномалии и как се решават чрез нормализация.        |
| 1 week      | Приложете нормализация до 3NF върху примерна таблица.                  |
| 1 month     | Анализирайте сценарий, в който денормализация подобрява производителността. |