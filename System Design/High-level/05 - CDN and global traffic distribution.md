# 05 - CDN and global traffic distribution

## 1. Activate Prior Knowledge

- Какво се случва, когато потребител от България се опита да достъпи уебсайт, чийто сървър е разположен в САЩ? Какви проблеми могат да възникнат?
- Какви техники познавате за ускоряване на зареждането на уеб страници и намаляване на латентността?
- Как мислите, че големи AI системи или SaaS приложения осигуряват бърз достъп до данни за потребители по целия свят?

## 2. Overview

Content Delivery Networks (CDN) са разпределени системи от сървъри, които доставят съдържание (статични файлове, видео, API отговори) до потребителите възможно най-близо до тяхната географска локация. Основната цел на CDN е да намали латентността, да увеличи скоростта на зареждане и да подобри надеждността на уеб приложенията, особено при глобален трафик.

В контекста на съвременните AI системи и облачни услуги, глобалното разпределение на трафика е критично важно. То позволява на приложенията да мащабират ефективно, да се справят с пикови натоварвания и да осигурят равномерно потребителско изживяване, независимо от местоположението на клиента.

CDN-ите работят чрез кеширане на съдържание в множество точки по света (edge locations). Когато потребител поиска ресурс, заявката се насочва към най-близкия edge сървър, което минимизира времето за пренос и натоварването върху основния (origin) сървър.

Този подход е фундаментален за модерното уеб инженерство, особено когато се работи с приложения с висока посещаемост, стрийминг услуги или AI inference endpoints, които трябва да обслужват глобална аудитория.

## 3. Key Concepts

- CDN (Content Delivery Network) – Мрежа от географски разпределени сървъри, които доставят съдържание до потребителите възможно най-близо до тях. Мислете за CDN като за "логистична мрежа" за данни.
- Edge Server – Сървър, разположен близо до крайните потребители, който кешира и доставя съдържание. Подобно на местен склад, който държи най-търсените стоки.
- Origin Server – Основният сървър, където се намира оригиналното съдържание. Edge сървърите се обръщат към него само при нужда.
- Latency – Забавяне между заявката и отговора. CDN намалява латентността като скъсява разстоянието между потребителя и съдържанието.
- Global Load Balancing – Разпределяне на трафика между различни сървъри или региони, за да се оптимизира производителността и надеждността.
- Caching – Временна локална съхранение на данни за по-бърз достъп при следващи заявки.
- Purge/Invalidate – Процес на изчистване на остаряло или променено съдържание от edge сървърите.

## 4. Step-by-step Learning Path

1. **Разберете основната архитектура на CDN**
   - Фокус: Как работят CDN, какви са основните компоненти.
   - Практическа задача: Намерете архитектурна схема на популярен CDN (напр. Cloudflare, AWS CloudFront).
   - Retrieval questions: Каква е ролята на edge сървърите? Какво е origin server?

2. **Настройте базов CDN за статичен уебсайт**
   - Фокус: Интегриране на CDN с реален сайт.
   - Практическа задача: Свържете малък статичен сайт с безплатен CDN (напр. Cloudflare).
   - Retrieval questions: Как се променя URL на ресурсите? Как да проверите дали съдържанието се кешира?

3. **Изследвайте глобалното разпределение на трафика**
   - Фокус: Как се насочват заявките към най-близкия edge сървър.
   - Практическа задача: Използвайте инструменти като traceroute или CDN тестове, за да видите откъде се зарежда съдържанието.
   - Retrieval questions: Как CDN определя най-близкия сървър? Какви DNS техники се използват?

4. **Работа с кеширане и инвалидация**
   - Фокус: Кеширане, TTL, изчистване на съдържание.
   - Практическа задача: Променете файл на сайта и направете purge през CDN конзолата.
   - Retrieval questions: Какво е TTL? Какво се случва при purge?

5. **Мониторинг и оптимизация**
   - Фокус: Анализ на трафика, latency, cache hit ratio.
   - Практическа задача: Прегледайте статистики за трафик и кеширане в CDN dashboard.
   - Retrieval questions: Какво е cache hit ratio? Как да разберете дали CDN работи ефективно?

## 5. Examples

### Пример 1: Използване на Cloudflare за статичен сайт

1. Регистрирате домейна си в Cloudflare.
2. Променяте DNS настройките да сочат към Cloudflare.
3. Cloudflare автоматично кешира статичните файлове (CSS, JS, изображения) на edge сървърите си.

### Пример 2: CDN за AI inference endpoint

```python
# Пример с AWS API Gateway + CloudFront
import requests

# Потребител от Азия прави заявка към AI endpoint:
response = requests.get("https://api.example.com/inference")
print(response.json())
# Заявката се обслужва от най-близкия CloudFront edge location, което намалява latency.
```

### Пример 3: Purge на кеширано съдържание

```bash
# Изчистване на кеширано изображение през Cloudflare API
curl -X POST "https://api.cloudflare.com/client/v4/zones/<ZONE_ID>/purge_cache" \
     -H "Authorization: Bearer <API_TOKEN>" \
     -H "Content-Type: application/json" \
     --data '{"files":["https://example.com/image.png"]}'
```

## 6. Common Pitfalls

- **Кеширане на чувствителни или динамични данни:** Не кеширайте персонализирани или чувствителни данни, за да избегнете изтичане на информация.
- **Забравен purge при обновяване:** Ако не изчистите кеша след промяна на съдържание, потребителите ще виждат остарели версии.
- **Неправилна конфигурация на TTL:** Прекалено дълъг TTL може да задържи стари данни, прекалено кратък – да натовари origin сървъра.
- **Липса на мониторинг:** Без наблюдение не може да разберете дали CDN реално подобрява производителността.
- **DNS propagation delays:** Промени в DNS за CDN може да отнемат време да се разпространят глобално.

## 7. Short Retrieval Quiz

1. Каква е основната цел на CDN?
2. Какво е edge server и каква е неговата роля?
3. Как CDN намалява латентността?
4. Какво означава purge в контекста на CDN?
5. Какви рискове има при кеширане на динамично съдържание?
6. Как се определя кой edge сървър ще обслужи дадена заявка?
7. Какво е cache hit ratio и защо е важно?

## 8. Quick Recap

- CDN разпределя съдържание чрез мрежа от edge сървъри по света.
- Основната цел е намаляване на латентността и ускоряване на зареждането.
- Кеширането е ключов механизъм за ефективност, но изисква правилна конфигурация.
- Глобалното разпределение на трафика осигурява надеждност и мащабируемост.
- Purge/Invalidate е важен процес при обновяване на съдържание.
- Мониторингът и анализът на трафика са критични за оптимизация.
- CDN е фундаментален компонент в съвременните AI и облачни системи.

## 9. Spaced Review Plan

| Review Time | Prompt                                                                 |
|-------------|------------------------------------------------------------------------|
| 1 day       | Опишете с една изречение как работи CDN и какво е edge server.         |
| 3 days      | Дайте пример за purge на кеширано съдържание и обяснете кога е нужен.  |
| 1 week      | Обяснете как CDN подобрява latency и какви са рисковете при кеширане.  |
| 1 month     | Избройте основните компоненти на CDN и опишете глобалното разпределение на трафика. |