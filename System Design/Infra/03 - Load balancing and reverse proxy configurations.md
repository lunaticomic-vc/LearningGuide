# 03 - Load balancing and reverse proxy configurations

## 1. Activate Prior Knowledge

- Какви са основните предизвикателства при обслужването на голям брой заявки към уеб приложение или AI система?
- Какво означава един сървър да бъде „претоварен“ и какви са последствията за потребителите?
- Можете ли да си представите сценарий, в който искате да скриете вътрешната структура на вашата система от външния свят?

## 2. Overview

Load balancing и reverse proxy са ключови техники за управление на трафика и оптимизация на производителността в съвременните уеб и AI системи. Load balancer-ът разпределя входящите заявки между множество сървъри, така че никой от тях да не бъде претоварен и системата да остане стабилна и бърза. Reverse proxy действа като посредник между клиентите и вътрешните сървъри, скривайки реалната инфраструктура и често предоставяйки допълнителни функционалности като кеширане, сигурност и SSL терминaция.

Тези технологии са фундаментални за изграждането на скалируеми, надеждни и сигурни приложения. В контекста на AI системи, където изчисленията често са тежки, load balancing позволява ефективно използване на хардуерните ресурси и минимизиране на времето за отговор. Reverse proxy улеснява интеграцията на различни компоненти и защитава вътрешната логика на системата.

В реални условия, правилната конфигурация на тези компоненти може да бъде разликата между система, която се справя с милиони потребители, и такава, която се срива при първия пик на трафика. Затова разбирането им е критично за всеки софтуерен инженер или AI специалист.

## 3. Key Concepts

- **Load Balancer** – Софтуер или хардуер, който разпределя входящите заявки между множество сървъри. Представете си го като диспечер на летище, който насочва пътниците към различни гишета, за да няма опашки.
- **Reverse Proxy** – Сървър, който приема заявки от клиенти и ги препраща към един или повече бекенд сървъри. Може да се мисли като рецепционист, който приема посетителите и ги насочва към правилния офис.
- **Round Robin** – Прост алгоритъм за разпределяне на заявки, при който всяка следваща заявка отива към следващия сървър в списъка.
- **Health Check** – Механизъм, чрез който load balancer-ът проверява дали даден бекенд сървър работи коректно, преди да му изпрати заявка.
- **SSL Termination** – Процесът на декриптиране на SSL трафика на reverse proxy, така че вътрешните сървъри да работят с некриптирани данни.
- **Sticky Sessions** – Техника, при която заявките от един и същ клиент винаги се насочват към един и същ бекенд сървър, например заради състояние на сесията.

## 4. Step-by-step Learning Path

1. **Разберете основната роля на load balancer и reverse proxy**
   - Фокус: Какво правят и защо са нужни.
   - Практическа задача: Нарисувайте схема на проста уеб система с и без load balancer/reverse proxy.
   - Retrieval: Каква е разликата между load balancer и reverse proxy? Какво би се случило без тях?

2. **Изучете основните алгоритми за разпределяне на трафика**
   - Фокус: Round Robin, Least Connections, IP Hash.
   - Практическа задача: Опишете с думи или псевдокод как работи Round Robin.
   - Retrieval: Кога бихте избрали Least Connections пред Round Robin?

3. **Конфигурирайте reverse proxy с Nginx**
   - Фокус: Основни директиви (proxy_pass, upstream).
   - Практическа задача: Напишете базова Nginx конфигурация за reverse proxy към два backend сървъра.
   - Retrieval: Каква е ролята на upstream блока в Nginx?

4. **Добавете health checks и SSL termination**
   - Фокус: Как да гарантирате, че трафикът се насочва само към здрави сървъри; как се обработва HTTPS.
   - Практическа задача: Добавете health check и SSL termination към вашата Nginx конфигурация.
   - Retrieval: Защо health check-овете са важни? Какво е SSL termination?

5. **Тествайте и наблюдавайте поведението при натоварване**
   - Фокус: Как да симулирате трафик и да наблюдавате разпределението на заявките.
   - Практическа задача: Използвайте инструмент като `ab` или `wrk` за да тествате вашата конфигурация.
   - Retrieval: Как бихте разбрали, че load balancing-ът работи коректно?

## 5. Examples

### Пример 1: Reverse Proxy с Nginx

```nginx
http {
    upstream backend_servers {
        server 192.168.1.10;
        server 192.168.1.11;
    }

    server {
        listen 80;
        location / {
            proxy_pass http://backend_servers;
        }
    }
}
```

### Пример 2: Load Balancer с Health Checks

```nginx
upstream backend_servers {
    server 192.168.1.10 max_fails=3 fail_timeout=30s;
    server 192.168.1.11 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    location / {
        proxy_pass http://backend_servers;
    }
}
```

### Пример 3: SSL Termination

```nginx
server {
    listen 443 ssl;
    ssl_certificate /etc/ssl/certs/example.crt;
    ssl_certificate_key /etc/ssl/private/example.key;

    location / {
        proxy_pass http://backend_servers;
    }
}
```

## 6. Common Pitfalls

- **Пренебрегване на health checks** – Ако не се проверява състоянието на бекенд сървърите, заявките могат да се изпращат към неработещи инстанции.
- **Липса на SSL termination** – Ако SSL не се обработва на reverse proxy, може да се изложите на риск от некриптиран трафик или сложни конфигурации на бекендите.
- **Sticky sessions без нужда** – Използването им без реална необходимост може да доведе до неравномерно натоварване.
- **Недостатъчно наблюдение** – Без мониторинг не може да се открият проблеми с разпределението на трафика или производителността.
- **Грешки в конфигурацията** – Малки синтактични грешки в конфигурационните файлове могат да доведат до недостъпност на услугата.

## 7. Short Retrieval Quiz

1. Каква е основната разлика между load balancer и reverse proxy?
2. Как работи алгоритъмът Round Robin?
3. Защо са важни health check-овете при load balancing?
4. Какво представлява SSL termination?
5. Кога бихте използвали sticky sessions?
6. Какви са рисковете при липса на мониторинг на reverse proxy?
7. Какъв е ефектът от неправилно конфигуриран reverse proxy?

## 8. Quick Recap

- Load balancer разпределя трафика между множество сървъри за по-добра производителност и надеждност.
- Reverse proxy скрива вътрешната инфраструктура и предоставя допълнителни функции като кеширане и сигурност.
- Основни алгоритми за разпределяне са Round Robin, Least Connections и IP Hash.
- Health check-овете гарантират, че трафикът се насочва само към работещи сървъри.
- SSL termination опростява управлението на криптиран трафик.
- Правилната конфигурация и мониторинг са критични за стабилността на системата.
- Често срещани грешки са липса на health checks, неправилна конфигурация и недостатъчно наблюдение.

## 9. Spaced Review Plan

| Време      | Преговори/Примери за припомняне                      |
|------------|------------------------------------------------------|
| 1 ден      | Опишете с думи разликата между load balancer и reverse proxy. |
| 3 дни      | Нарисувайте схема на reverse proxy конфигурация.     |
| 1 седмица  | Обяснете защо health check-овете са критични.        |
| 1 месец    | Дайте пример за реална ситуация, в която load balancing предотвратява срив. |