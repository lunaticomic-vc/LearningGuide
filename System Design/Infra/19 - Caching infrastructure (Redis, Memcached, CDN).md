# 19 - Caching infrastructure (Redis, Memcached, CDN)

## 1. Activate Prior Knowledge

- Кога за последно сте се сблъсквали със забавяне при зареждане на уеб приложение или API? Какви решения бихте предложили за ускоряване на отговорите?
- Как мислите, че големи платформи като Facebook или Netflix доставят съдържание толкова бързо на милиони потребители едновременно?
- Какво знаете за кеширането като концепция и какви предимства и недостатъци има то в контекста на мащабируеми системи?

## 2. Overview

Кеширащата инфраструктура е ключова част от съвременните софтуерни и AI системи, която позволява значително ускоряване на достъпа до често използвани данни. Чрез съхраняване на резултати от скъпи операции (като заявки към база данни или изчисления) в бърза памет, системите могат да отговарят на потребителските заявки за части от секундата.

В по-широката архитектура кеширането се използва на различни нива: от локални кешове в процеса, през разпределени кешове като Redis и Memcached, до глобални CDN (Content Delivery Network) за статични ресурси. Всеки от тези инструменти има своя роля в оптимизацията на производителността и мащабируемостта.

Кеширането е особено важно за AI системи и мащабни уеб приложения, където латентността и натоварването са критични фактори. Добре проектираната кешираща инфраструктура намалява разходите, подобрява потребителското изживяване и осигурява устойчивост при високи натоварвания.

## 3. Key Concepts

- Cache (Кеш) – Бърза временна памет, в която се съхраняват често използвани данни за по-бърз достъп. Мислете за кеша като за чекмедже с най-използваните ви инструменти.
- Cache hit / miss – Кеш попадение (hit) е когато търсените данни вече са в кеша; пропуск (miss) – когато не са и трябва да се извлекат от източника.
- Redis – Разпределена in-memory база данни, често използвана като кеш заради бързодействието и поддръжката на различни типове данни.
- Memcached – Лек, високопроизводителен in-memory кеш, подходящ за съхранение на малки парчета данни като резултати от заявки.
- CDN (Content Delivery Network) – Глобална мрежа от сървъри, която доставя статично съдържание (като изображения, скриптове) близо до потребителя.
- TTL (Time To Live) – Времето, за което даден обект остава валиден в кеша, след което се изтрива.
- Eviction policy – Политика за изтриване на стари или ненужни данни от кеша (например LRU – Least Recently Used).
- Consistency (Съгласуваност) – Степента, до която кешираните данни отразяват актуалното състояние на източника.

## 4. Step-by-step Learning Path

1. **Разберете основите на кеширането**
   - Фокус: Какво е кеш, кога и защо се използва.
   - Практическа задача: Идентифицирайте 2 случая във ваше приложение, където кеширането би било полезно.
   - Въпроси: Какви са предимствата на кеширането? Какви рискове крие?

2. **Запознайте се с Redis и Memcached**
   - Фокус: Разлики, предимства и недостатъци на двата инструмента.
   - Практическа задача: Инсталирайте Redis или Memcached локално и съхранете/извлечете проста стойност.
   - Въпроси: Кога бихте избрали Redis пред Memcached? Какви типове данни поддържа Redis?

3. **Използвайте кеширане в код**
   - Фокус: Интеграция на кеш в бекенд приложение.
   - Практическа задача: Имплементирайте кеширане на резултат от скъпа операция (например заявка към база данни).
   - Въпроси: Как ще обновите кеша при промяна на данните? Как ще изберете TTL?

4. **Разберете и приложете CDN**
   - Фокус: Как работи CDN и кога се използва.
   - Практическа задача: Настройте безплатен CDN (например Cloudflare) за статичен сайт.
   - Въпроси: Как CDN намалява латентността? Какви типове съдържание са подходящи за CDN?

5. **Мониторинг и оптимизация на кеша**
   - Фокус: Как да следите ефективността на кеша и да настройвате eviction политики.
   - Практическа задача: Използвайте инструменти за мониторинг (например Redis CLI) и анализирайте cache hit/miss ratio.
   - Въпроси: Какво означава висок процент cache miss? Как бихте оптимизирали TTL?

## 5. Examples

### Пример 1: Кеширане на резултати от база данни с Redis (Python)

```python
import redis

r = redis.Redis(host='localhost', port=6379, db=0)

def get_user_profile(user_id):
    cache_key = f"user_profile:{user_id}"
    profile = r.get(cache_key)
    if profile:
        return profile  # Cache hit
    profile = db_query_user_profile(user_id)  # Скъпа операция
    r.setex(cache_key, 3600, profile)  # Кеширане за 1 час
    return profile
```

### Пример 2: Използване на Memcached за кеширане на сесии (PHP)

```php
$memcache = new Memcache;
$memcache->connect('localhost', 11211);

$session_id = 'abc123';
$session_data = $memcache->get($session_id);
if (!$session_data) {
    $session_data = fetch_session_from_db($session_id);
    $memcache->set($session_id, $session_data, 0, 600); // 10 минути
}
```

### Пример 3: Настройка на CDN за статични файлове

- Регистрирате домейна си в Cloudflare.
- Пренасочвате DNS записите през Cloudflare.
- Всички статични файлове (CSS, JS, изображения) автоматично се кешират и доставят от най-близкия до потребителя сървър.

## 6. Common Pitfalls

- **Кеширане на твърде динамични данни** – Води до остаряла информация. Решение: Кеширайте само стабилни или рядко променящи се данни.
- **Липса на стратегия за обновяване на кеша** – Данните в кеша могат да станат невалидни. Решение: Използвайте подходящ TTL или механизми за инвалидация.
- **Прекалено голям TTL** – Може да задържи стари данни твърде дълго. Решение: Балансирайте между производителност и актуалност.
- **Пренебрегване на мониторинга** – Без наблюдение не знаете дали кешът работи ефективно. Решение: Следете cache hit/miss ratio и натоварването.
- **Използване на кеш за чувствителни данни** – Може да доведе до изтичане на информация. Решение: Не кеширайте лични или секретни данни без нужната защита.

## 7. Short Retrieval Quiz

1. Каква е основната цел на кеширането в софтуерните системи?
2. Каква е разликата между Redis и Memcached?
3. Какво означава TTL в контекста на кеширането?
4. Как CDN ускорява доставката на съдържание до потребителите?
5. Какво е cache hit и cache miss?
6. Защо е важно да се следи cache hit/miss ratio?
7. Какви са рисковете при кеширане на чувствителни данни?

## 8. Quick Recap

- Кеширането ускорява достъпа до често използвани данни и намалява натоварването на източниците.
- Redis и Memcached са популярни in-memory кешове с различни характеристики.
- CDN доставя статично съдържание бързо и близо до потребителя.
- TTL и eviction политики контролират живота на обектите в кеша.
- Добрата кешираща стратегия балансира между производителност и актуалност на данните.
- Мониторингът е ключов за ефективността на кеша.
- Кеширането трябва да се прилага внимателно при чувствителни или често променящи се данни.

## 9. Spaced Review Plan

| Review Time | Prompt                                               |
|-------------|-----------------------------------------------------|
| 1 day       | Обяснете разликите между Redis, Memcached и CDN.    |
| 3 days      | Дайте пример за cache hit и cache miss в приложение.|
| 1 week      | Как бихте избрали TTL и eviction policy за кеш?     |
| 1 month     | Кои са основните рискове при кеширане и как се избягват? |