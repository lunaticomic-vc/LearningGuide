# 10 - Sharding and horizontal partitioning

## 1. Activate Prior Knowledge

- Какви са основните разлики между скалиране на база данни по вертикала (vertical scaling) и по хоризонтала (horizontal scaling)?
- Можете ли да си спомните ситуации, в които една база данни или система е станала твърде голяма, за да се управлява ефективно на един сървър?
- Какви предизвикателства възникват при обработката на огромни обеми данни в системи за машинно обучение или уеб приложения?

## 2. Overview

Sharding и хоризонталното партициониране са техники за разделяне на големи бази данни или масиви от данни на по-малки, по-лесно управляеми части. Това позволява на системите да обработват повече заявки едновременно, да намалят латентността и да се справят с растящия обем данни, без да се налага скъпо вертикално скалиране на хардуера.

В контекста на мащабируеми AI системи, уеб приложения или микросървисни архитектури, sharding е ключова стратегия за разпределяне на натоварването между множество сървъри (нодове). Това подобрява устойчивостта на системата и позволява по-лесно добавяне на ресурси при нужда.

Хоризонталното партициониране (horizontal partitioning) е общият принцип, а sharding е специфичен случай, при който данните се разделят между различни физически машини или бази данни. Този подход е особено важен при системи, които трябва да обработват милиони потребители или транзакции в реално време.

## 3. Key Concepts

- **Sharding** – Разделяне на данните на независими части (shards), които се съхраняват на различни сървъри. Аналогия: като да разделиш голяма библиотека на секции и всяка секция да е в отделна сграда.
- **Horizontal partitioning** – Разделяне на таблица или колекция на редове, които се съхраняват отделно. Всеки shard съдържа част от редовете, но всички колони.
- **Shard key** – Полето или комбинацията от полета, по които се определя къде ще се съхранява даден запис. Изборът на shard key е критичен за балансирано разпределение.
- **Replication** – Копиране на данни между shard-ове за устойчивост и висока наличност.
- **Rebalancing** – Процесът на преразпределяне на данни между shard-ове при промяна на натоварването или добавяне на нови сървъри.
- **Hotspot** – Когато един shard получава непропорционално голямо натоварване, често поради лош избор на shard key.

## 4. Step-by-step Learning Path

1. **Разбери нуждата от хоризонтално партициониране**
   - Фокус: Кога и защо хоризонталното партициониране е необходимо.
   - Задача: Намери пример за реална система, която използва sharding (напр. Twitter, MongoDB).
   - Въпроси: Какви са ограниченията на вертикалното скалиране? Какво печелим от хоризонтално партициониране?

2. **Научи как работи shard key**
   - Фокус: Как се избира подходящ shard key и как влияе на разпределението на данните.
   - Задача: Измисли три възможни shard ключа за таблица с потребители и анализирай плюсовете и минусите им.
   - Въпроси: Какво се случва при лош избор на shard key? Как shard key влияе на hotspot-ите?

3. **Имплементирай базово sharding решение**
   - Фокус: Реализирай прост sharding на масив от данни (напр. с hash функция).
   - Задача: Напиши малък скрипт, който разпределя записи по shard-ове според user_id.
   - Въпроси: Как се определя на кой shard да отиде даден запис? Какво става при добавяне на нов shard?

4. **Разбери репликация и rebalancing**
   - Фокус: Как се осигурява устойчивост и как се преразпределят данните.
   - Задача: Опиши сценарий, в който трябва да се добави нов shard и как ще се прехвърлят данните.
   - Въпроси: Какви са рисковете при rebalancing? Какво става при срив на един shard?

5. **Анализирай реални проблеми и оптимизации**
   - Фокус: Как се избягват hotspot-и и се оптимизира производителността.
   - Задача: Прочети case study за sharding в голяма система (напр. YouTube, Instagram) и обобщи основните предизвикателства.
   - Въпроси: Как се откриват hotspot-и? Какви са стратегиите за тяхното избягване?

## 5. Examples

### Пример 1: Sharding в MongoDB

MongoDB позволява sharding чрез избор на shard key. Например, ако имаме колекция с потребители:

```javascript
sh.shardCollection("mydb.users", { "user_id": 1 })
```
Това ще разпредели документите по user_id между различни shard-ове.

### Пример 2: Хеш-базиран sharding

В Python, разпределяне на записи по 4 shard-а:

```python
def get_shard(user_id, num_shards=4):
    return hash(user_id) % num_shards

user_id = 12345
shard = get_shard(user_id)
print(f"User {user_id} -> Shard {shard}")
```

### Пример 3: Range-based sharding

Ако имаме база с поръчки, може да разпределим по дата:

- Shard 1: 2020-2021
- Shard 2: 2022-2023
- Shard 3: 2024+

## 6. Common Pitfalls

- **Лош избор на shard key** – Води до неравномерно разпределение и hotspot-и. Избирайте ключове с висока кардиналност и равномерно разпределение.
- **Трудно rebalancing** – Ако shard-овете са твърде големи, прехвърлянето на данни става бавно и рисково. Планирайте rebalancing стратегии предварително.
- **Сложни заявки между shard-ове** – JOIN или агрегации между shard-ове са бавни. Дизайнът трябва да минимизира cross-shard операции.
- **Недостатъчна репликация** – Липсата на резервни копия води до загуба на данни при срив на shard.

## 7. Short Retrieval Quiz

1. Каква е основната разлика между вертикално и хоризонтално партициониране?
2. Какво представлява shard key и защо е важен?
3. Какво е hotspot в контекста на sharding?
4. Какви са основните предимства на хоризонталното партициониране?
5. Как се осигурява устойчивост при sharding?
6. Какви са рисковете при rebalancing на shard-ове?
7. Дайте пример за hash-based sharding.

## 8. Quick Recap

- Sharding е техника за разделяне на данни между множество сървъри за по-добра скалируемост.
- Horizontal partitioning разделя таблици на редове, които се съхраняват отделно.
- Shard key определя как се разпределят данните; изборът му е критичен.
- Репликацията осигурява устойчивост и висока наличност.
- Hotspot-и възникват при неравномерно разпределение на данните.
- Rebalancing е процес на преразпределяне на данни при промени в инфраструктурата.
- Добрият дизайн на sharding минимизира cross-shard операции и улеснява поддръжката.

## 9. Spaced Review Plan

| Време     | Преговори/Задачи                                               |
|-----------|---------------------------------------------------------------|
| 1 ден     | Прегледай ключовите понятия и примери за sharding.             |
| 3 дни     | Реши отново retrieval quiz и анализирай реален case study.     |
| 1 седмица | Имплементирай малък sharding скрипт и тествай hotspot-и.       |
| 1 месец   | Прегледай цялата тема, фокусирай се върху pitfalls и оптимизации.|