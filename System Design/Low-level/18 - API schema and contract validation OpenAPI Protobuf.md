# 18 - API schema and contract validation OpenAPI Protobuf

## 1. Activate Prior Knowledge

- Какво е API и каква е ролята му в комуникацията между различни софтуерни системи?
- Срещали ли сте ситуации, в които несъответствия в структурата на данните са причинили грешки или неочаквано поведение в дадена система?
- Какви са предимствата на използването на формални спецификации (като OpenAPI или Protobuf) при разработката на AI системи или микросървисни архитектури?

## 2. Overview

API схемата и валидацията на контрактите са ключови за гарантиране на надеждна комуникация между различни компоненти в съвременните софтуерни системи. Те дефинират какви данни се обменят, в какъв формат и какви са очакванията на всяка страна. Това е особено важно при изграждането на мащабируеми и поддържани системи, където множество екипи или услуги трябва да работят заедно без недоразумения.

OpenAPI и Protocol Buffers (Protobuf) са два популярни подхода за формализиране на API схемите. OpenAPI е широко използван за RESTful API-та и предоставя четим за хора формат (обикновено YAML/JSON), докато Protobuf е бинарен формат, предпочитан при високопроизводителни и езиково независими системи, често използван в AI и микросървисни среди.

Валидацията на контрактите (contract validation) гарантира, че имплементацията на API-то съответства на договорената схема. Това предотвратява грешки, улеснява интеграциите и ускорява разработката, тъй като всички страни работят по един и същи стандарт.

В контекста на AI системи, където често се обменят големи обеми от структурирани данни между различни услуги, строгата схема и валидация са критични за избягване на неочаквани сривове и за осигуряване на проследимост.

## 3. Key Concepts

- API Schema – Формално описание на структурата, типовете и формата на данните, които се обменят през API.
- Contract Validation – Процесът на проверка дали реалната имплементация на API-то съответства на предварително дефинираната схема (контракт).
- OpenAPI – Стандартизиран формат (обикновено YAML/JSON) за описание на RESTful API-та, който улеснява автоматизацията и документацията.
- Protobuf (Protocol Buffers) – Езиково независим, бинарен формат за сериализация на структурирани данни, създаден от Google; често използван за RPC и микросървиси.
- Backward/Forward Compatibility – Способността на API-то да приема по-стари или по-нови версии на съобщенията без грешки; мислете за това като за „разговор между поколения“.
- Code Generation – Автоматичното генериране на клиентски и сървърни библиотеки въз основа на схемата, което намалява риска от човешки грешки.
- Schema Evolution – Управление на промените в схемата без да се нарушава работата на съществуващите клиенти или сървъри.

## 4. Step-by-step Learning Path

1. **Разберете нуждата от формална API схема**
   - Фокус: Защо неформалните договорки не са достатъчни.
   - Практическа задача: Опишете с думи какво може да се обърка при липса на формална схема между два екипа.
   - Въпроси: Какви проблеми могат да възникнат без схема? Каква е ролята на схемата в екипната работа?

2. **Запознайте се с OpenAPI**
   - Фокус: Основна структура на OpenAPI спецификация.
   - Практическа задача: Създайте минимална OpenAPI спецификация за API, което връща списък с книги.
   - Въпроси: Какви са основните компоненти на OpenAPI? Как се описва един endpoint?

3. **Изучете Protobuf**
   - Фокус: Дефиниране на съобщения и услуги с Protobuf.
   - Практическа задача: Дефинирайте Protobuf schema за същото API (списък с книги).
   - Въпроси: Как се дефинират типове данни в Protobuf? Какви са разликите с OpenAPI?

4. **Валидация на контрактите**
   - Фокус: Инструменти и подходи за автоматична валидация.
   - Практическа задача: Използвайте инструмент (например Swagger или protoc) за валидация на схема спрямо имплементация.
   - Въпроси: Как се откриват несъответствия между схема и код? Какво се случва при нарушение на контракта?

5. **Schema Evolution и съвместимост**
   - Фокус: Как да променяме схеми без да чупим съществуващи интеграции.
   - Практическа задача: Добавете ново поле към схемата и анализирайте ефекта върху съществуващите клиенти.
   - Въпроси: Какво означава backward compatibility? Как се управляват версиите на API?

## 5. Examples

### Пример 1: Минимална OpenAPI спецификация

```yaml
openapi: 3.0.0
info:
  title: Book API
  version: 1.0.0
paths:
  /books:
    get:
      summary: Get list of books
      responses:
        '200':
          description: A list of books
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Book'
components:
  schemas:
    Book:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        author:
          type: string
```

### Пример 2: Protobuf schema за същото API

```proto
syntax = "proto3";

message Book {
  int32 id = 1;
  string title = 2;
  string author = 3;
}

message BookList {
  repeated Book books = 1;
}

service BookService {
  rpc ListBooks (Empty) returns (BookList);
}

message Empty {}
```

### Пример 3: Contract validation с Swagger

- Използвайте `swagger-cli validate openapi.yaml` за да проверите дали вашата OpenAPI спецификация е валидна.
- Ако има несъответствия, инструментът ще ги изведе с описание на проблема.

## 6. Common Pitfalls

- **Пропускане на валидация:** Не се използват автоматични инструменти за проверка на съответствието между схема и имплементация.
- **Неправилна еволюция на схемата:** Добавяне или премахване на полета без да се мисли за съвместимост с по-стари клиенти.
- **Липса на документация:** Схемата не е добре документирана, което води до грешки при интеграция.
- **Ръчно писане на код:** Не се използва автоматично генериране на код, което увеличава риска от грешки.
- **Пренебрегване на типове данни:** Използване на неясни или прекалено общи типове, което затруднява валидацията и интеграцията.

## 7. Short Retrieval Quiz

1. Каква е основната разлика между OpenAPI и Protobuf?
2. Какво представлява contract validation и защо е важна?
3. Какво означава backward compatibility при API схемите?
4. Как може автоматично да се провери дали имплементацията отговаря на схемата?
5. Какви са предимствата на използването на code generation при работа със схеми?
6. Какви типове грешки могат да възникнат при липса на формална API схема?
7. Как се дефинира масив от обекти в Protobuf?

## 8. Quick Recap

- API схемите формализират структурата на обменяните данни между системите.
- OpenAPI е стандарт за описание на RESTful API-та, четим за хора и машини.
- Protobuf е бинарен формат, подходящ за високопроизводителни и езиково независими среди.
- Contract validation гарантира, че имплементацията следва договорената схема.
- Автоматичната валидация и code generation намаляват риска от грешки.
- Съвместимостта на схемите е критична при еволюция на API-та.
- Добрата документация и спазването на стандартите улесняват интеграциите.

## 9. Spaced Review Plan

| Review Time | Prompt                                      |
|-------------|---------------------------------------------|
| 1 day       | Обяснете разликите между OpenAPI и Protobuf.|
| 3 days      | Опишете процеса на contract validation.     |
| 1 week      | Дайте пример за schema evolution и анализирайте ефекта. |
| 1 month     | Избройте основните ползи от формалната API схема и валидация. |