# 22 - Performance and latency optimization at system level

## 1. Activate Prior Knowledge

- Какви са основните причини за забавяне (latency) в една типична AI система или софтуерен стек?
- Можете ли да дадете пример, когато оптимизацията на производителността на едно ниво (например код) не води до подобрение на цялостната система?
- Какви инструменти или подходи сте използвали досега за измерване и анализ на производителността?

## 2. Overview

Оптимизацията на производителността и латентността на системно ниво е критичен аспект в дизайна и поддръжката на съвременни софтуерни и AI системи. Тя включва анализ и подобрение на всички компоненти – от хардуерни ресурси, през операционна система, до мрежови комуникации и приложения.

Вместо да се фокусираме само върху отделни функции или модули, системното ниво изисква цялостен поглед: как отделните части си взаимодействат, къде възникват тесни места (bottlenecks), и как да се постигне баланс между скорост, разход на ресурси и надеждност.

Този подход е особено важен при мащабируеми AI приложения, real-time системи и облачни среди, където дори малки забавяния могат да доведат до значителни загуби или влошено потребителско изживяване.

## 3. Key Concepts

- Throughput (Пропускателна способност) – Количеството обработени задачи или данни за единица време. Представете си го като броя коли, които могат да преминат през магистрала за час.
- Latency (Латентност) – Времето, необходимо за обработка на една единична задача от началото до края. Аналогия: времето, което отнема на една кола да измине разстоянието от точка А до точка Б.
- Bottleneck (Тясно място) – Компонент или процес, който ограничава цялостната производителност на системата, подобно на тясна част на пътя, където се образува задръстване.
- Profiling (Профилиране) – Систематично измерване и анализ на производителността на различни части от системата.
- Resource contention (Конфликт за ресурси) – Когато няколко процеса или нишки се борят за един и същ ресурс (CPU, памет, мрежа), което води до забавяния.
- Parallelism & Concurrency (Паралелизъм и конкурентност) – Използване на множество изчислителни ресурси за едновременна обработка на задачи.
- Caching (Кеширане) – Запазване на често използвани данни в по-бърза памет за ускоряване на достъпа.

## 4. Step-by-step Learning Path

1. **Разберете архитектурата на системата**
   - Фокус: Картографирайте основните компоненти и техните взаимодействия.
   - Практическа задача: Начертайте диаграма на потока от данни във вашата система.
   - Въпроси: Кои са основните точки на комуникация? Къде може да възникне забавяне?

2. **Измерете производителността**
   - Фокус: Използвайте инструменти за профилиране и мониторинг.
   - Практическа задача: Използвайте `htop`, `perf` или профайлър на езика за да измерите натоварването на CPU и памет.
   - Въпроси: Кой компонент използва най-много ресурси? Какви са типичните стойности за latency и throughput?

3. **Идентифицирайте тесните места**
   - Фокус: Анализирайте данните от профилирането.
   - Практическа задача: Направете списък с топ 3 тясни места във вашата система.
   - Въпроси: Какво причинява най-голямо забавяне? Може ли да се елиминира или оптимизира?

4. **Приложете техники за оптимизация**
   - Фокус: Изберете подходящи стратегии (кеширане, паралелизъм, оптимизация на алгоритми).
   - Практическа задача: Имплементирайте кеширане или паралелна обработка на най-критичния компонент.
   - Въпроси: Как се промени latency след оптимизацията? Има ли странични ефекти?

5. **Тествайте и валидирайте**
   - Фокус: Измерете отново производителността след оптимизациите.
   - Практическа задача: Направете A/B тест или сравнете метриките преди и след промяната.
   - Въпроси: Постигнато ли е очакваното подобрение? Има ли нови тесни места?

## 5. Examples

### Пример 1: Оптимизация на latency при AI inference

```python
import time
import torch

model = torch.load('model.pt')
input_data = torch.randn(1, 3, 224, 224)

start = time.time()
with torch.no_grad():
    output = model(input_data)
end = time.time()

print(f"Latency: {end - start:.4f} seconds")
```
*След измерване се въвежда batch processing и се намалява latency чрез паралелна обработка.*

### Пример 2: Кеширане на резултати от скъпи изчисления

```python
from functools import lru_cache

@lru_cache(maxsize=128)
def expensive_computation(x):
    # Скъпа операция
    return x ** 2

print(expensive_computation(100))
```
*Чрез кеширане се избягва повторно изчисление за същите входни данни.*

### Пример 3: Намаляване на мрежова латентност

- Използване на CDN (Content Delivery Network) за статични ресурси в уеб приложение.
- Преместване на AI inference сървъра по-близо до крайния потребител (edge computing).

## 6. Common Pitfalls

- **Оптимизация без измерване:** Опитите за подобрение без реални данни често водят до неефективни или ненужни промени.
- **Фокус само върху един слой:** Пренебрегването на системното взаимодействие може да остави скрити тесни места.
- **Прекомерна оптимизация (premature optimization):** Ранното оптимизиране на незначителни части може да усложни поддръжката.
- **Игнориране на странични ефекти:** Оптимизации като кеширане могат да доведат до проблеми с консистентността или изчерпване на паметта.
- **Недостатъчно тестване:** Липсата на валидиране след промени може да въведе нови проблеми или регресии.

## 7. Short Retrieval Quiz

1. Каква е разликата между latency и throughput?
2. Какво е bottleneck и как влияе на системата?
3. Защо е важно да се използва профилиране преди оптимизация?
4. Дайте пример за техника за намаляване на latency.
5. Какви са потенциалните рискове при прекомерно кеширане?
6. Как паралелизмът може да подобри производителността?
7. Какво означава resource contention?

## 8. Quick Recap

- Оптимизацията на системно ниво изисква цялостен анализ на всички компоненти.
- Latency и throughput са основни метрики за производителност.
- Bottlenecks ограничават максималната производителност на системата.
- Профилирането е задължителна стъпка преди всяка оптимизация.
- Кеширането и паралелизмът са мощни, но трябва да се използват внимателно.
- Винаги валидирайте ефекта от оптимизациите с реални измервания.
- Избягвайте преждевременна или изолирана оптимизация.

## 9. Spaced Review Plan

| Review Interval | Review Prompt                                               |
|-----------------|------------------------------------------------------------|
| 1 day           | Назовете основните метрики за производителност и дайте пример за bottleneck във вашата система. |
| 3 days          | Обяснете как бихте профилирали и оптимизирали latency в real-time приложение. |
| 1 week          | Избройте често срещани грешки при оптимизация на системно ниво и как да ги избегнете. |
| 1 month         | Опишете цялостен процес за системна оптимизация от анализ до валидиране на резултатите. |