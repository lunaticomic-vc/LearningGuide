# 17 - Idempotency and retry logic design

## 1. Activate Prior Knowledge

- Какво се случва, ако една и съща заявка към API се изпрати два пъти поради мрежова грешка? Какви са възможните последствия?
- Кога сте използвали или чували за retry механизми в софтуерни системи? Какви проблеми решават те?
- Можете ли да си представите ситуация, в която повторното изпълнение на една операция би довело до нежелани странични ефекти?

## 2. Overview

Idempotency и retry logic са фундаментални концепции в дизайна на надеждни софтуерни системи, особено при работа с разпределени системи и външни API-та. Idempotency гарантира, че независимо колко пъти дадена операция бъде изпълнена, резултатът ще бъде същият, сякаш е изпълнена само веднъж. Това е критично важно при мрежови грешки, където повторното изпращане на заявка може да се случи неволно.

Retry logic се използва, за да се справим с временни (transient) грешки, като например прекъсване на връзката или временно недостъпен сървър. Добре проектираният retry механизъм увеличава устойчивостта на системата, но трябва да се използва внимателно, за да не доведе до дублиране на операции или претоварване на услугата.

В контекста на AI системи и мащабни облачни услуги, тези концепции са особено важни за постигане на висока надеждност, консистентност и предвидимост на поведението при неочаквани ситуации.

## 3. Key Concepts

- Idempotency – Свойство на операция, при което многократното ѝ изпълнение има същия ефект като еднократното. Може да се сравни с натискане на бутон за включване на лампа: независимо колко пъти го натиснете, лампата ще остане включена.
- Retry logic – Механизъм за автоматично повторение на операция при временна грешка. Подобно на опитите да се свържете по телефона, ако линията е заета.
- Idempotency key – Уникален идентификатор, използван за разпознаване на повтарящи се заявки, за да се предотврати дублиране на операции.
- Transient error – Временна грешка, която често може да бъде разрешена чрез повторен опит (например timeout или краткотрайна недостъпност на услуга).
- Backoff strategy – Алгоритъм, който определя колко време да се изчака между повторните опити, често с увеличаващи се интервали (exponential backoff).
- Side effect – Промяна в състоянието на системата, която може да се случи при изпълнение на операция (например запис в база данни).

## 4. Step-by-step Learning Path

1. **Разберете какво е idempotency**
   - Фокус: Дефиниция и примери за идемпотентни операции.
   - Задача: Идентифицирайте кои HTTP методи са идемпотентни (GET, PUT, POST, DELETE).
   - Въпроси: Какво означава една операция да е идемпотентна? Дайте пример за неидемпотентна операция.
2. **Изследвайте retry logic**
   - Фокус: Кога и защо се използва retry механизъм.
   - Задача: Напишете псевдокод за функция, която прави до 3 опита да извика външен API.
   - Въпроси: Какви грешки са подходящи за retry? Какви рискове крие безконтролното повторение?
3. **Комбинирайте idempotency и retry logic**
   - Фокус: Как двете концепции работят заедно за надеждност.
   - Задача: Добавете idempotency key към заявка за създаване на ресурс и имплементирайте проверка за дублиране.
   - Въпроси: Как idempotency предпазва от странични ефекти при retry? Как се използва idempotency key?
4. **Приложете backoff стратегии**
   - Фокус: Използване на exponential backoff за избягване на претоварване.
   - Задача: Имплементирайте exponential backoff в retry логиката си.
   - Въпроси: Защо е важно да има изчакване между опитите? Какво би станало без backoff?
5. **Оценете и тествайте решенията**
   - Фокус: Тестове за коректност и устойчивост.
   - Задача: Симулирайте мрежови грешки и наблюдавайте поведението на retry логиката.
   - Въпроси: Как бихте тествали дали вашата система е устойчива на дублирани заявки? Какви метрики бихте следили?

## 5. Examples

### Пример 1: Idempotent PUT заявка

```python
import requests

data = {"user_id": 123, "email": "user@example.com"}
response = requests.put("https://api.example.com/users/123", json=data)
# Независимо колко пъти изпратим тази заявка, резултатът ще е един и същ.
```

### Пример 2: Retry logic с exponential backoff

```python
import time
import requests

def call_api_with_retry(url, max_attempts=5):
    delay = 1
    for attempt in range(max_attempts):
        try:
            response = requests.get(url)
            if response.status_code == 200:
                return response.json()
        except requests.exceptions.RequestException:
            pass
        time.sleep(delay)
        delay *= 2  # Exponential backoff
    raise Exception("API not available after retries")
```

### Пример 3: Idempotency key при POST заявка

```python
import uuid
import requests

idempotency_key = str(uuid.uuid4())
headers = {"Idempotency-Key": idempotency_key}
data = {"amount": 100, "currency": "BGN"}

response = requests.post("https://api.payments.com/charge", json=data, headers=headers)
# Ако заявката се повтори със същия ключ, няма да се създаде ново плащане.
```

## 6. Common Pitfalls

- **Липса на idempotency при критични операции** – Може да доведе до дублирани плащания или записи. Винаги използвайте idempotency key при чувствителни POST операции.
- **Безконтролно повторение (retry) без backoff** – Може да претовари системата и да влоши проблема. Използвайте backoff стратегии.
- **Retry на неидемпотентни операции** – Може да причини нежелани странични ефекти. Уверете се, че операциите са идемпотентни или използвайте idempotency key.
- **Игнориране на перманентни грешки** – Не всички грешки са временни; избягвайте безкрайни опити при грешки като 400 Bad Request.
- **Неправилно съхранение на idempotency key** – Ако ключовете не се пазят достатъчно дълго, може да се получи дублиране при забавени заявки.

## 7. Short Retrieval Quiz

1. Какво е idempotency и защо е важно при retry logic?
2. Кои HTTP методи са по дефиниция идемпотентни?
3. Каква е ролята на idempotency key?
4. Какво представлява exponential backoff и защо се използва?
5. Какви рискове крие retry logic без idempotency?
6. Как бихте разпознали transient error?
7. Защо не трябва да се правят безкрайни retry опити при всички видове грешки?

## 8. Quick Recap

- Idempotency гарантира, че многократното изпълнение на операция води до един и същ резултат.
- Retry logic повишава устойчивостта на системите при временни грешки.
- Idempotency key предпазва от дублиране на чувствителни операции при повторни заявки.
- Exponential backoff намалява риска от претоварване при повторни опити.
- Не всички операции са идемпотентни – внимавайте при POST, PATCH и други.
- Тествайте системите си за устойчивост на мрежови грешки и дублирани заявки.
- Комбинирането на idempotency и добре проектиран retry logic е ключово за надеждни услуги.

## 9. Spaced Review Plan

| Review Time | Prompt                                                                 |
|-------------|------------------------------------------------------------------------|
| 1 day       | Обяснете с пример какво е idempotency и кога се използва idempotency key. |
| 3 days      | Опишете стъпките за имплементиране на retry logic с exponential backoff. |
| 1 week      | Дайте пример за проблем, който може да възникне при липса на idempotency. |
| 1 month     | Разграничете transient и permanent errors и обяснете как се третират при retry. |