# 11 - Monitoring, logging, and alerting (Prometheus, Grafana, ELK stack)

## 1. Activate Prior Knowledge

- Как бихте разбрали, че даден AI модел или услуга работи некоректно или е претоварен в продукционна среда?
- Какви инструменти или техники сте използвали досега за събиране на информация за състоянието на дадена система?
- Каква е разликата между логване (logging) и мониторинг (monitoring), и защо и двете са важни за надеждността на софтуерните системи?

## 2. Overview

В съвременните софтуерни и AI системи, мониторингът, логването и алармирането са основни процеси за поддържане на надеждност, производителност и сигурност. Те позволяват на инженерите да наблюдават състоянието на системите в реално време, да откриват и анализират проблеми, както и да реагират бързо при инциденти.

Мониторингът събира и визуализира метрики като натоварване на процесора, използване на памет, брой заявки и други показатели за здравето на системата. Логването записва детайлни събития и грешки, които помагат при отстраняване на проблеми и анализ на поведението. Алармирането автоматично уведомява екипите при отклонения от нормалното функциониране.

Инструменти като Prometheus (за мониторинг), Grafana (за визуализация) и ELK stack (за логване и анализ) са индустриални стандарти, които се интегрират лесно и осигуряват мащабируемост и гъвкавост. Тяхното правилно използване е критично за стабилността на всяка AI или cloud-базирана система.

## 3. Key Concepts

- Monitoring – Събиране и анализ на метрики за състоянието на системата. Може да се сравни с таблото на автомобил, което показва скорост, температура и ниво на гориво.
- Logging – Записване на събития, грешки и действия в системата. Подобно на черната кутия в самолет, логовете пазят историята на случилото се.
- Alerting – Автоматично известяване при настъпване на определени условия или аномалии. Може да се мисли като аларма за дим, която се включва при пожар.
- Prometheus – Система за мониторинг и събиране на метрики, базирана на pull модел.
- Grafana – Платформа за визуализация на данни и изграждане на dashboard-и.
- ELK Stack (Elasticsearch, Logstash, Kibana) – Комплект инструменти за събиране, индексиране, анализ и визуализация на логове.
- Metrics – Квантитативни показатели за състоянието на системата (напр. CPU usage, latency).
- Logs – Текстови записи на събития, грешки или действия в системата.
- Dashboard – Визуален интерфейс за наблюдение на ключови показатели.
- Incident Response – Процес на реагиране при инциденти, базиран на аларми и логове.

## 4. Step-by-step Learning Path

1. **Разберете разликата между мониторинг и логване**  
   - Фокус: Кога и защо се използват метрики и логове.  
   - Задача: Направете списък с 3 метрики и 3 типа логове, които бихте следили в AI система.  
   - Въпроси: Какво е метрика? Каква е основната цел на логовете?

2. **Инсталирайте и стартирайте Prometheus**  
   - Фокус: Основна конфигурация и събиране на метрики от примерен сървър.  
   - Задача: Инсталирайте Prometheus локално и добавете един exporter (напр. node_exporter).  
   - Въпроси: Как Prometheus събира данни? Какво е exporter?

3. **Визуализирайте данни с Grafana**  
   - Фокус: Свързване на Grafana с Prometheus и създаване на dashboard.  
   - Задача: Създайте dashboard, който показва CPU и RAM usage.  
   - Въпроси: Какво е dashboard? Какви видове визуализации предлага Grafana?

4. **Съберете и анализирайте логове с ELK stack**  
   - Фокус: Основна архитектура на ELK и потока на данните.  
   - Задача: Инсталирайте Elasticsearch, Logstash и Kibana; изпратете примерни логове и ги визуализирайте.  
   - Въпроси: Каква е ролята на Logstash? Защо е важно логовете да са структурирани?

5. **Настройте алармиране (alerting)**  
   - Фокус: Дефиниране на правила за аларми и интеграция с email или Slack.  
   - Задача: Настройте alert в Prometheus за високо CPU натоварване.  
   - Въпроси: Какво е alert rule? Какви действия могат да се предприемат при аларма?

6. **Интерпретирайте данни и реагирайте на инциденти**  
   - Фокус: Анализ на dashboard и логове при симулиран проблем.  
   - Задача: Симулирайте проблем (напр. високо натоварване) и проследете как се отразява в метриките и логовете.  
   - Въпроси: Как бихте използвали логовете за root cause analysis? Какви метрики са най-важни при инцидент?

## 5. Examples

### Пример 1: Мониторинг на AI inference сървър с Prometheus и Grafana

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'ai-inference'
    static_configs:
      - targets: ['localhost:9100']
```
- Добавяте node_exporter към AI сървъра, за да следите CPU, RAM и мрежов трафик.
- В Grafana създавате графика за latency на inference заявките.

### Пример 2: Анализ на логове с ELK stack

- Logstash приема JSON логове от AI приложение, филтрира ги и ги изпраща към Elasticsearch.
- В Kibana създавате dashboard за грешки (error rate) и времеви анализ на заявки.

```json
{
  "timestamp": "2024-06-01T12:00:00Z",
  "level": "ERROR",
  "message": "Model loading failed",
  "model": "resnet50"
}
```

### Пример 3: Аларма за високо натоварване

```yaml
# alert.rules.yml
groups:
- name: cpu_alerts
  rules:
  - alert: HighCPUUsage
    expr: avg(rate(node_cpu_seconds_total{mode="user"}[5m])) > 0.8
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "CPU usage is above 80% for 5 minutes"
```
- При достигане на 80% CPU за повече от 5 минути, се изпраща известие към дежурния инженер.

## 6. Common Pitfalls

- **Липса на стандартизация на логовете** – Неструктурираните логове затрудняват анализа. Използвайте JSON или друг структуриран формат.
- **Твърде много или твърде малко аларми** – Прекомерните аларми водят до "alert fatigue", а липсата на аларми – до пропуснати инциденти. Настройвайте праговете внимателно.
- **Недостатъчно мониторирани компоненти** – Пропускането на важни части от системата може да скрие критични проблеми. Уверете се, че всички ключови услуги са покрити.
- **Пренебрегване на визуализацията** – Dashboard-и без ясни и релевантни визуализации затрудняват бързата диагностика. Използвайте подходящи графики и филтри.
- **Неактуализирани конфигурации** – Промени в инфраструктурата често остават неотразени в мониторинг системите.

## 7. Short Retrieval Quiz

1. Каква е основната разлика между мониторинг и логване?
2. Какво е ролята на Prometheus в един мониторинг стек?
3. За какво се използва Grafana?
4. Какво означава "alerting" и защо е важно?
5. Какви са основните компоненти на ELK stack?
6. Какво е exporter в контекста на Prometheus?
7. Какви са рисковете при твърде много аларми?

## 8. Quick Recap

- Мониторингът следи метрики и здравето на системите в реално време.
- Логването записва детайлна история на събития и грешки.
- Алармирането автоматично уведомява при аномалии или инциденти.
- Prometheus, Grafana и ELK stack са водещи инструменти за тези задачи.
- Структурираните логове улесняват анализа и root cause investigation.
- Dashboard-ите помагат за бърза визуална диагностика.
- Добрата конфигурация на аларми и покритие на всички компоненти е критична за надеждността.

## 9. Spaced Review Plan

| Review Time | Prompt                                                      |
|-------------|-------------------------------------------------------------|
| 1 day       | Обяснете разликата между мониторинг, логване и алармиране.  |
| 3 days      | Опишете как бихте интегрирали Prometheus и Grafana за AI система. |
| 1 week      | Какви са предимствата на ELK stack при анализ на логове?    |
| 1 month     | Дайте пример за инцидент и как бихте го открили с тези инструменти. |