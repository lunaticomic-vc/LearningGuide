# 16 - Transaction boundaries and atomic operations

## 1. Activate Prior Knowledge

- Какво означава една операция да бъде „атомарна“ в контекста на бази данни или многопоточни системи?
- Можете ли да си спомните ситуация, в която прекъсване на процес или грешка е довела до неконсистентно състояние на данните?
- Как мислите, че транзакциите и техните граници влияят върху надеждността и сигурността на софтуерните системи, особено при AI приложения?

## 2. Overview

Транзакционните граници и атомарните операции са фундаментални концепции за изграждане на надеждни и устойчиви софтуерни системи. Те гарантират, че група от операции се изпълняват като едно цяло — или всички операции се извършват успешно, или нито една не се прилага, което предпазва данните от частични или неконсистентни промени.

В по-широк контекст, транзакциите са особено важни при работа с бази данни, разпределени системи и многопоточни приложения, където множество процеси могат да достъпват и променят едни и същи ресурси. Ясното дефиниране на границите на транзакциите позволява на системите да поддържат консистентност и да се възстановяват след сривове.

В AI системите, където често се обработват големи обеми от данни и се изисква висока степен на надеждност, разбирането на тези концепции е ключово за предотвратяване на загуба на данни или неочаквани резултати.

## 3. Key Concepts

- Transaction (Транзакция) – Последователност от операции, които се третират като едно логическо цяло. Ако някоя операция се провали, всички промени се отменят.
- Transaction Boundary (Граница на транзакция) – Точката, в която започва и завършва една транзакция. Може да се мисли като началото и края на „невидим сейф“ за операциите.
- Atomic Operation (Атомарна операция) – Операция, която е неделима: или се изпълнява изцяло, или изобщо не се изпълнява. Представете си я като превключвател, който е или включен, или изключен, но никога не е наполовина.
- Commit (Потвърждение) – Действието, с което всички промени в рамките на транзакцията стават постоянни.
- Rollback (Връщане назад) – Отмяна на всички промени, направени по време на транзакцията, ако възникне грешка.
- Consistency (Консистентност) – Гаранция, че системата преминава само през валидни състояния.
- Isolation (Изолация) – Принцип, според който едновременните транзакции не трябва да влияят една на друга.

## 4. Step-by-step Learning Path

1. **Разберете какво е транзакция и защо е нужна**
   - Фокус: Дефиниция и роля на транзакциите в системите.
   - Практическа задача: Опишете с думи или схема какво би се случило, ако банков трансфер не е транзакционен.
   - Въпроси: Какво е транзакция? Какво може да се обърка без транзакции?

2. **Изучете атомарните операции**
   - Фокус: Какво прави една операция атомарна и защо това е важно.
   - Практическа задача: Напишете пример за атомарна операция в Python с използване на threading.Lock.
   - Въпроси: Какво означава „атомарност“? Може ли операция да бъде частично изпълнена?

3. **Разграничете границите на транзакциите**
   - Фокус: Как се определят началото и краят на транзакция.
   - Практическа задача: В SQL, напишете BEGIN TRANSACTION, няколко UPDATE/INSERT, и COMMIT/ROLLBACK.
   - Въпроси: Как се определя границата на транзакция? Какво става при грешка в средата на транзакцията?

4. **Използвайте транзакции в реални системи**
   - Фокус: Имплементация на транзакции в база данни или многопоточна среда.
   - Практическа задача: Имплементирайте прост банков трансфер с транзакции в избрана СУБД.
   - Въпроси: Как транзакциите предпазват от загуба на данни? Какво е rollback?

5. **Анализирайте изолацията и консистентността**
   - Фокус: Как транзакциите се изолират една от друга и поддържат консистентност.
   - Практическа задача: Експериментирайте с два едновременни update-а върху една и съща база данни.
   - Въпроси: Какво е изолация? Как се гарантира консистентност?

## 5. Examples

### Пример 1: Транзакция в SQL

```sql
BEGIN TRANSACTION;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
COMMIT;
```
Ако някоя от операциите се провали, може да се използва `ROLLBACK;` за да се върнат всички промени.

### Пример 2: Атомарна операция с threading.Lock в Python

```python
import threading

balance = 0
lock = threading.Lock()

def deposit(amount):
    global balance
    with lock:
        balance += amount  # Тази операция е атомарна в рамките на lock-а
```

### Пример 3: Граница на транзакция в MongoDB

```python
with client.start_session() as session:
    with session.start_transaction():
        collection1.insert_one({"x": 1}, session=session)
        collection2.insert_one({"y": 2}, session=session)
    # Ако някоя операция се провали, и двете няма да се запишат
```

## 6. Common Pitfalls

- **Забравяне на commit или rollback:** Ако транзакцията не бъде изрично потвърдена или върната назад, може да остане в неопределено състояние.
- **Прекалено големи транзакции:** Големите транзакции могат да блокират ресурси и да доведат до deadlock или лоша производителност.
- **Липса на изолация:** Ако транзакциите не са правилно изолирани, може да се получат race conditions или неконсистентни данни.
- **Неправилно дефинирани граници:** Ако границите на транзакцията са неясни, може да се загубят или дублират данни.

## 7. Short Retrieval Quiz

1. Какво е транзакция и защо е важна?
2. Какво означава една операция да бъде атомарна?
3. Какво се случва, ако възникне грешка по средата на транзакция?
4. Каква е ролята на commit и rollback?
5. Какво представлява изолацията при транзакциите?
6. Дайте пример за реална ситуация, в която транзакционните граници са критични.
7. Какво може да се случи, ако забравите да използвате commit в транзакция?

## 8. Quick Recap

- Транзакциите групират операции така, че всички да се изпълнят или нито една.
- Атомарните операции са неделими и не могат да бъдат прекъснати.
- Границите на транзакциите определят кога започва и свършва една транзакция.
- Commit потвърждава, а rollback отменя промените в транзакцията.
- Изолацията предпазва транзакциите от взаимно влияние.
- Консистентността гарантира валидни състояния на системата.
- Правилното използване на транзакции предотвратява загуба и неконсистентност на данни.

## 9. Spaced Review Plan

| Време      | Преговори/Въпроси за припомняне                          |
|------------|---------------------------------------------------------|
| 1 ден      | Какво е транзакция? Какво е атомарна операция?          |
| 3 дни      | Как се определя границата на транзакция?                |
| 1 седмица  | Как commit и rollback влияят на данните?                |
| 1 месец    | Дайте пример за транзакция и обяснете защо е важна.      |