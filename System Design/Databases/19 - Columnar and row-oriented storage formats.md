# 19 - Columnar and row-oriented storage formats

## 1. Activate Prior Knowledge

- Какви са основните начини за съхранение на данни в релационни бази данни и как това влияе на скоростта на заявки?
- Кога бихте предпочели да четете или обработвате само определени колони от голяма таблица, например при анализ на данни или машинно обучение?
- Какви предизвикателства могат да възникнат при обработка на големи обеми данни в AI системи, свързани с формата на съхранение?

## 2. Overview

Columnar и row-oriented storage formats са два основни подхода за физическо съхранение на таблични данни. При row-oriented (редово ориентирано) съхранение, всички стойности за даден ред се пазят заедно, докато при columnar (колонно ориентирано) – всички стойности за дадена колона са съхранени последователно.

Тези формати са от ключово значение при избора на подходяща архитектура за бази данни, data warehouses и аналитични системи. Изборът между тях влияе директно върху производителността на заявки, компресията на данни и ефективността на анализи, особено при големи обеми информация.

В контекста на AI и софтуерното инженерство, правилният избор на формат може да ускори ETL процеси, тренировка на модели и интерактивни анализи. Разбирането на разликите и приложенията им е фундаментално за изграждане на мащабируеми и ефективни системи за управление на данни.

## 3. Key Concepts

- Row-oriented storage – Данните за всеки ред се съхраняват заедно. Подходящо за OLTP (онлайн транзакционни) системи, където често се работи с цели записи.
- Columnar storage – Всички стойности за дадена колона се съхраняват последователно. Идеално за аналитични заявки, които обработват малко на брой колони, но много редове.
- OLTP (Online Transaction Processing) – Системи, фокусирани върху бързи, чести транзакции (напр. банкови операции).
- OLAP (Online Analytical Processing) – Системи за аналитична обработка, често работещи с големи обеми данни и агрегации.
- Data compression – Компресията на данни често е по-ефективна при columnar storage, тъй като стойностите в една колона са по-хомогенни.
- Scan efficiency – Ефективността на сканиране на данни; columnar форматът позволява по-бързо четене на конкретни колони.
- Write amplification – При columnar storage записите на нови редове могат да бъдат по-неефективни, тъй като се разделят по колони.

## 4. Step-by-step Learning Path

1. **Разгледайте структурата на таблични данни**
   - Фокус: Разберете как се съхраняват редове и колони в паметта.
   - Задача: Начертайте на хартия как изглежда една таблица в row-oriented и columnar формат.
   - Въпроси: Как се съхранява един ред в двата формата? Какво се случва, ако трябва да прочетете само една колона?

2. **Изследвайте типични заявки и натоварвания**
   - Фокус: Разберете разликата между OLTP и OLAP заявки.
   - Задача: Класифицирайте примерни SQL заявки като подходящи за row- или columnar storage.
   - Въпроси: Коя заявка би била по-бърза при columnar storage? Защо?

3. **Експериментирайте с реални формати**
   - Фокус: Запознайте се с формати като Parquet (columnar) и CSV (row-oriented).
   - Задача: Създайте малък dataset и го запишете в Parquet и CSV. Измерете размера на файловете.
   - Въпроси: Кой файл е по-малък? Защо?

4. **Измерете производителността**
   - Фокус: Изпълнете селективни и агрегиращи заявки върху двата формата.
   - Задача: Използвайте Pandas или Apache Arrow, за да заредите и филтрирате данни от двата формата.
   - Въпроси: Кой формат е по-бърз при четене на една колона? А при четене на всички колони?

5. **Приложете наученото към AI/ML задачи**
   - Фокус: Разберете как изборът на формат влияе на feature engineering и тренировка на модели.
   - Задача: Заредете само нужните колони за ML задача от columnar формат.
   - Въпроси: Как columnar storage ускорява подготовката на данни за ML?

## 5. Examples

### Пример 1: Row-oriented storage (CSV)

```csv
id,name,age
1,Anna,23
2,Ivan,31
3,Petar,28
```
Тук всеки ред съдържа всички стойности за даден запис.

### Пример 2: Columnar storage (Parquet)

В Parquet файл, стойностите за всяка колона се съхраняват заедно:
- Колона "id": 1, 2, 3
- Колона "name": Anna, Ivan, Petar
- Колона "age": 23, 31, 28

### Пример 3: Pandas четене на конкретна колона

```python
import pandas as pd

# Четене само на колоната 'age' от Parquet файл
df = pd.read_parquet('data.parquet', columns=['age'])
```
Това е много по-ефективно при columnar storage, отколкото при row-oriented.

## 6. Common Pitfalls

- Да се използва row-oriented storage за аналитични заявки с големи таблици – води до излишно четене на ненужни данни.
- Да се избира columnar storage за OLTP системи – записите на нови редове са по-бавни и сложни.
- Пренебрегване на компресията – columnar форматите често позволяват по-добра компресия, но тя трябва да се конфигурира правилно.
- Липса на съвместимост – някои инструменти не поддържат всички формати еднакво добре.

## 7. Short Retrieval Quiz

1. Каква е основната разлика между row-oriented и columnar storage?
2. Кой формат е по-подходящ за OLAP заявки и защо?
3. Как columnar storage подобрява компресията на данни?
4. Какъв е недостатъкът на columnar storage при чести записи на нови редове?
5. Дайте пример за реален columnar storage формат.
6. Какъв е ефектът върху производителността при четене само на една колона от голяма таблица в columnar формат?
7. Защо row-oriented storage е предпочитан при транзакционни системи?

## 8. Quick Recap

- Row-oriented storage съхранява всички стойности за даден ред заедно; columnar storage – всички стойности за дадена колона.
- Columnar storage е по-ефективен за аналитични заявки и агрегации.
- Row-oriented storage е подходящ за OLTP системи с чести, малки транзакции.
- Columnar форматите позволяват по-добра компресия на данни.
- Изборът на формат влияе на скоростта на заявки и използването на ресурси.
- Неправилен избор на формат може да доведе до сериозни спадове в производителността.
- В AI/ML задачи columnar storage ускорява подготовката и анализа на данни.

## 9. Spaced Review Plan

| Time      | Review Prompt                                               |
|-----------|------------------------------------------------------------|
| 1 day     | Обяснете разликата между row- и columnar storage с пример. |
| 3 days    | Кога бихте избрали columnar storage пред row-oriented?     |
| 1 week    | Как компресията работи по-добре при columnar storage?      |
| 1 month   | Как изборът на формат влияе на ML/AI процесите?            |