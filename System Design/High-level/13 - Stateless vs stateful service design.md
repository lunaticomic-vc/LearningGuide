# 13 - Stateless vs stateful service design

## 1. Activate Prior Knowledge

- Какво означава един уеб сървър да "помни" предишни заявки на потребителя? Можете ли да дадете пример от реален уебсайт или приложение?
- Кога вие или вашият екип сте се сблъсквали с проблеми, свързани със съхранението на данни между различни сесии или заявки?
- Защо мислите, че в системи с изкуствен интелект (AI) или мащабируеми облачни услуги е важно да се разбира разликата между stateless и stateful дизайн?

## 2. Overview

Stateless и stateful са два основни подхода към дизайна на софтуерни услуги и приложения. Stateless (без състояние) означава, че всяка заявка към услугата се обработва независимо, без да се съхранява информация за предишни взаимодействия. Stateful (със състояние) означава, че услугата пази информация за предишни заявки или сесии, което ѝ позволява да "помни" контекста на потребителя.

Тези концепции са от решаващо значение при изграждането на мащабируеми, надеждни и лесни за поддръжка системи, особено в облачни среди и AI приложения. Изборът между двата подхода влияе върху архитектурата, производителността, сигурността и възможността за разширяване на системата.

В контекста на съвременните микросервизни архитектури, cloud-native приложения и AI системи, правилното разбиране и прилагане на stateless и stateful дизайн е ключово за успеха на проекта. Това знание помага на инженерите да вземат информирани решения относно баланс между удобство за потребителя, сложност на инфраструктурата и разходи.

## 3. Key Concepts

- Stateless Service – Услуга, която не съхранява никаква информация за предишни заявки. Може да се сравни с автомата за билети: всяка покупка е независима от предишните.
- Stateful Service – Услуга, която пази информация за състоянието на клиента между заявките. Прилича на банков служител, който помни историята на вашите транзакции.
- Session – Временен контекст, който съхранява данни за потребителя или процеса по време на взаимодействие със системата.
- Persistence – Механизъм за съхранение на данни извън паметта на услугата, например в база данни, за да се запази състоянието между рестартирания или сривове.
- Scalability – Способността на системата да се разширява, като добавя или премахва ресурси. Stateless услугите обикновено се мащабират по-лесно.
- Load Balancer – Компонент, който разпределя заявките между множество инстанции на услуга. Работи по-ефективно със stateless услуги.

## 4. Step-by-step Learning Path

1. **Разберете разликата между stateless и stateful**
   - Фокус: Прочетете дефинициите и основните характеристики.
   - Задача: Направете таблица с плюсове и минуси за двата подхода.
   - Въпроси: Каква е основната разлика между stateless и stateful услуга? Кога бихте избрали едната пред другата?

2. **Анализирайте реални сценарии**
   - Фокус: Разгледайте примери от уеб приложения, API, AI системи.
   - Задача: Идентифицирайте дали дадена услуга (например login система) е stateless или stateful.
   - Въпроси: Защо login системите често са stateful? Какво би се случило, ако бяха stateless?

3. **Практикувайте с код**
   - Фокус: Имплементирайте прост stateless и stateful API.
   - Задача: Напишете два малки RESTful сервиса – единият да пази състояние в паметта, другият да не пази.
   - Въпроси: Какво се случва при рестарт на stateful услугата? Как се мащабира stateless услугата?

4. **Изследвайте мащабируемост и устойчивост**
   - Фокус: Разберете как state влияе на load balancing и failover.
   - Задача: Симулирайте разпределяне на заявки между няколко инстанции на stateless и stateful услуга.
   - Въпроси: Коя архитектура е по-лесна за автоматично възстановяване? Какви са рисковете при stateful дизайн?

5. **Свържете с AI и облачни системи**
   - Фокус: Как state management влияе на AI inference и training pipelines.
   - Задача: Опишете как бихте проектирали inference service за AI модел – stateless или stateful?
   - Въпроси: Какви са предимствата на stateless inference service? Кога stateful е необходим?

## 5. Examples

### Пример 1: Stateless REST API

```python
# Python Flask пример за stateless endpoint
from flask import Flask, request, jsonify

app = Flask(__name__)

@app.route('/add', methods=['GET'])
def add():
    a = int(request.args.get('a'))
    b = int(request.args.get('b'))
    return jsonify({'result': a + b})

# Всеки път се обработва само текущата заявка, без да се пази история.
```

### Пример 2: Stateful Chat Session

```python
# Python Flask пример за stateful endpoint с in-memory session
from flask import Flask, session, request

app = Flask(__name__)
app.secret_key = 'secret'

@app.route('/message', methods=['POST'])
def message():
    msg = request.form['msg']
    if 'history' not in session:
        session['history'] = []
    session['history'].append(msg)
    return {'history': session['history']}

# Сесията пази историята на съобщенията за всеки потребител.
```

### Пример 3: Load Balancer и Stateless Microservices

В облачна среда, load balancer разпределя заявки към няколко инстанции на stateless услуга. Тъй като няма състояние, всяка инстанция може да обработи всяка заявка, което улеснява скалирането и автоматичното възстановяване.

## 6. Common Pitfalls

- **Грешно съхранение на state в stateless услуга** – Понякога разработчиците неволно добавят състояние в stateless услуга, което води до проблеми при скалиране.
- **Зависимост от локална памет** – Държането на state само в RAM прави услугата уязвима при срив или рестарт.
- **Неправилен избор на архитектура** – Използване на stateful услуги там, където stateless би бил по-ефективен (например за прости API-та).
- **Лошо управление на сесии** – Недостатъчно защитени или неправилно синхронизирани сесии могат да доведат до загуба на данни или пробиви в сигурността.
- **Пренебрегване на persistence** – Неосигуряване на устойчиво съхранение за важен state води до загуба на информация.

## 7. Short Retrieval Quiz

1. Какво е основното предимство на stateless услугите при мащабиране?
2. Дайте пример за stateful услуга от ежедневието.
3. Какво се случва със stateful услуга при рестарт, ако state не се пази извън RAM?
4. Как load balancer работи по различен начин със stateless и stateful услуги?
5. Защо е важно да се използва persistence при stateful услуги?
6. Какво би се случило, ако login система е напълно stateless?
7. Кога бихте избрали stateful дизайн пред stateless?

## 8. Quick Recap

- Stateless услугите не пазят информация за предишни заявки – всяка заявка е независима.
- Stateful услугите пазят контекст или история за потребителя или процеса.
- Stateless архитектурата улеснява скалирането, автоматичното възстановяване и разпределението на натоварването.
- Stateful услугите са нужни, когато трябва да се пази контекст, например при сесии, чатове или транзакции.
- Persistence е критично важно за надеждността на stateful услуги.
- Грешното смесване на stateful и stateless подходи може да доведе до сериозни проблеми.
- Изборът между двата подхода зависи от конкретните нужди на системата.

## 9. Spaced Review Plan

| Време     | Преговори/Задачи                                 |
|-----------|--------------------------------------------------|
| 1 ден     | Прегледайте разликите и примери за двата подхода.|
| 3 дни     | Решете отново retrieval quiz и анализирайте грешките.|
| 1 седмица | Направете малък проект с REST API (stateless и stateful).|
| 1 месец   | Обяснете темата на колега и приложете в реален проект.|