# 14 - Distributed transactions and two-phase commit

## 1. Activate Prior Knowledge

- Какво означава транзакция в контекста на база данни или софтуерна система? Какви свойства трябва да има една транзакция?
- Срещали ли сте ситуации, в които няколко различни системи или услуги трябва да работят заедно, за да изпълнят една задача? Какви предизвикателства възникват при координацията между тях?
- Как мислите, че се гарантира целостта на данните, когато множество участници са включени в една операция, особено в разпределени среди като микросървиси или AI системи?

## 2. Overview

Distributed transactions са операции, които обхващат повече от една база данни или услуга, често разположени на различни машини или в различни мрежи. За разлика от локалните транзакции, тук трябва да се гарантира, че всички участващи системи или никоя от тях няма да извършат промени, ако не е възможно всички да завършат успешно.

Двустепенното потвърждение (Two-Phase Commit, 2PC) е класически протокол, който осигурява атомарност на разпределените транзакции. Той координира участниците чрез централен координатор, който управлява фазите на гласуване и потвърждение.

В съвременните AI системи и микросървис архитектури, distributed transactions са особено важни, когато трябва да се гарантира консистентност между различни компоненти, например при обработка на плащания, резервации или критични бизнес процеси.

Разбирането на distributed transactions и 2PC е ключово за изграждане на надеждни, устойчиви и мащабируеми системи, където грешките и частичните откази са неизбежни.

## 3. Key Concepts

- Distributed Transaction – Транзакция, която включва множество независими ресурси (напр. бази данни, услуги), разпределени в различни системи.
- Atomicity – Свойството една транзакция да се изпълни изцяло или изобщо да не се изпълни. Мислете за това като за "всичко или нищо".
- Two-Phase Commit (2PC) – Протокол за координиране на разпределени транзакции, състоящ се от фаза на гласуване (prepare) и фаза на потвърждение (commit/abort).
- Coordinator – Централен компонент, който управлява процеса на commit между всички участници.
- Participant (Resource Manager) – Всеки от участващите ресурси, които трябва да изпълнят част от транзакцията.
- Prepare Phase – Фаза, в която координаторът пита всички участници дали могат да извършат commit.
- Commit Phase – Фаза, в която координаторът казва на всички участници да commit-нат или да abort-нат транзакцията.
- Blocking – Ситуация, при която участник или координатор "замръзва" и не може да продължи поради липса на информация или отказ.
- CAP Theorem – Принцип, който казва, че в разпределена система не могат едновременно да се гарантират консистентност, достъпност и устойчивост към разделяне на мрежата.

## 4. Step-by-step Learning Path

1. **Разберете основите на транзакциите**
   - Фокус: ACID свойства (Atomicity, Consistency, Isolation, Durability)
   - Задача: Опишете с ваши думи какво означава всяко ACID свойство.
   - Въпроси: Какво се случва, ако транзакцията не е атомарна? Как се гарантира изолация?

2. **Изучете предизвикателствата на разпределените транзакции**
   - Фокус: Защо транзакциите са по-трудни в разпределени системи?
   - Задача: Намерете пример от реалния свят, където няколко услуги трябва да координират промени.
   - Въпроси: Какви рискове има при частичен отказ? Как се справяме с мрежови забавяния?

3. **Запознайте се с Two-Phase Commit (2PC)**
   - Фокус: Как работи 2PC, какви са фазите и ролите.
   - Задача: Начертайте схема на 2PC с координатор и трима участници.
   - Въпроси: Какво се случва, ако един участник откаже commit? Какво става при срив на координатора?

4. **Практикувайте с примерна имплементация**
   - Фокус: Имплементирайте прост 2PC протокол (може и псевдокод).
   - Задача: Напишете функция, която симулира prepare и commit фази между няколко "участника".
   - Въпроси: Как ще обработите отказ на един участник? Как ще възстановите системата след срив?

5. **Анализирайте ограниченията и алтернативите**
   - Фокус: Какви са слабостите на 2PC и какви са алтернативите (напр. 3PC, Sagas)?
   - Задача: Направете таблица с плюсове и минуси на 2PC спрямо други подходи.
   - Въпроси: Кога бихте избрали 2PC, а кога – алтернативен подход?

## 5. Examples

### Пример 1: Банкова транзакция между две банки

- Клиент превежда пари от сметка в банка А към сметка в банка Б.
- И двете банки трябва да потвърдят, че могат да извършат операцията (prepare).
- Ако и двете са готови, координаторът казва "commit" и парите се прехвърлят.

### Пример 2: Микросървис архитектура – резервация на самолетен билет

```python
# Псевдокод за 2PC между три услуги: резервация на място, плащане, изпращане на билет
def two_phase_commit(services):
    # Phase 1: Prepare
    votes = [s.prepare() for s in services]
    if all(votes):
        # Phase 2: Commit
        for s in services:
            s.commit()
        return "Success"
    else:
        for s in services:
            s.abort()
        return "Failure"
```

### Пример 3: AI система, която записва резултати в няколко независими бази

- AI pipeline трябва да запише резултатите едновременно в база за логове и база за анализи.
- Използва се 2PC, за да се гарантира, че и двете бази ще получат резултатите или нито една.

## 6. Common Pitfalls

- **Блокиране при срив на координатора** – Ако координаторът спре между фазите, участниците могат да останат в неопределено състояние. Използвайте timeouts и recovery механизми.
- **Липса на idempotency** – Ако commit/abort съобщения се изпратят повече от веднъж, участниците трябва да могат да ги обработят безопасно.
- **Пренебрегване на мрежови проблеми** – Винаги предвиждайте загуба на съобщения, забавяния или разделяне на мрежата.
- **Използване на 2PC при висока латентност** – 2PC не е подходящ за системи с много участници или бавни мрежи поради блокиране и изчакване.

## 7. Short Retrieval Quiz

1. Какво е основната цел на two-phase commit протокола?
2. Какви са двете основни фази на 2PC?
3. Какво се случва, ако един от участниците откаже по време на prepare фазата?
4. Какви са основните рискове при използване на 2PC в разпределени системи?
5. Каква е ролята на координатора в 2PC?
6. Какво означава "atomicity" в контекста на транзакциите?
7. Кога бихте предпочели алтернативи на 2PC като Sagas?

## 8. Quick Recap

- Distributed transactions координират промени между множество независими ресурси.
- Two-phase commit (2PC) осигурява атомарност чрез две фази: prepare и commit/abort.
- Координатор управлява процеса, а участниците изпълняват инструкции.
- 2PC страда от блокиране при сривове и не е подходящ за всички сценарии.
- Идентитетността и обработката на грешки са критични за надеждността.
- Съществуват алтернативи като 3PC и Sagas за по-устойчиви системи.
- Разбирането на тези принципи е ключово за изграждане на надеждни разпределени системи.

## 9. Spaced Review Plan

| Review Time | Prompt                                               |
|-------------|------------------------------------------------------|
| 1 day       | Обяснете с ваши думи как работи two-phase commit.    |
| 3 days      | Начертайте схема на 2PC и опишете фазите.            |
| 1 week      | Дайте пример за реален проблем при 2PC и решение.    |
| 1 month     | Сравнете 2PC с алтернативни подходи (напр. Sagas).   |