# 06 - Transactions and isolation levels

## 1. Activate Prior Knowledge

- Какво означава една операция в база данни да бъде "атомарна"? Можете ли да дадете пример от реалния живот?
- Кога сте срещали проблеми със състезание (race conditions) или неконсистентни данни при паралелна обработка?
- Как мислите, че транзакциите и нивата на изолация могат да повлияят на надеждността на една AI система, която обработва големи обеми данни?

---

## 2. Overview

Транзакциите са основен механизъм в съвременните бази данни и софтуерни системи, който гарантира, че група от операции се изпълняват като едно цяло — или всички успешно, или нито една. Това е особено важно в среди с множество потребители или процеси, които могат да достъпват и променят едни и същи данни едновременно.

Нивата на изолация определят как транзакциите "виждат" промените, направени от други транзакции. Те балансират между производителност и консистентност, като позволяват на системата да избере подходящата степен на защита срещу аномалии като "мръсно четене" или "фантомни записи".

В контекста на AI системи или мащабни софтуерни архитектури, правилното използване на транзакции и изолационни нива е критично за предотвратяване на загуба на данни, неконсистентност и неочаквани грешки при паралелна обработка.

---

## 3. Key Concepts

- Transaction (Транзакция) – Група от операции, които се изпълняват като едно цяло: или всички се извършват успешно, или всички се отменят. Мислете за това като за банков превод – парите се изваждат от една сметка и се добавят към друга, или нищо не се случва.
- ACID – Четири основни свойства на транзакциите: Atomicity (Атомарност), Consistency (Консистентност), Isolation (Изолация), Durability (Устойчивост).
- Isolation Level (Ниво на изолация) – Определя доколко транзакциите са "изолирани" една от друга, т.е. какви междинни резултати могат да виждат.
- Dirty Read (Мръсно четене) – Когато една транзакция чете данни, които друга транзакция още не е потвърдила.
- Non-repeatable Read (Неповтаряемо четене) – Когато една транзакция чете едни и същи данни два пъти и получава различни резултати, защото друга транзакция е променила данните междувременно.
- Phantom Read (Фантомно четене) – Когато една транзакция вижда различен брой редове при две последователни заявки, защото друга транзакция е добавила или изтрила редове.
- Serializable – Най-високото ниво на изолация, при което транзакциите се изпълняват така, сякаш са една след друга (серийно).

---

## 4. Step-by-step Learning Path

1. **Запознайте се с основите на транзакциите и ACID**
   - Фокус: Какво представлява транзакцията и защо ACID е важен.
   - Практическа задача: Намерете пример за транзакция в любимата си база данни (напр. SQL BEGIN/COMMIT/ROLLBACK).
   - Въпроси: Какво означава атомарност? Какво би станало, ако една транзакция не е устойчива?

2. **Изследвайте различните нива на изолация**
   - Фокус: Различия между Read Uncommitted, Read Committed, Repeatable Read и Serializable.
   - Практическа задача: Създайте две паралелни транзакции и наблюдавайте какво се случва при различни нива на изолация.
   - Въпроси: Какво е мръсно четене? Кое ниво на изолация го предотвратява?

3. **Разберете аномалиите при паралелни транзакции**
   - Фокус: Как и защо възникват dirty reads, non-repeatable reads, phantom reads.
   - Практическа задача: Симулирайте non-repeatable read с две транзакции в тестова база.
   - Въпроси: Как се различава non-repeatable read от phantom read?

4. **Приложете наученото в реален проект**
   - Фокус: Изберете подходящо ниво на изолация според нуждите на конкретна система (например AI pipeline).
   - Практическа задача: Опишете сценарий, в който по-ниско ниво на изолация е приемливо, и такъв, в който е критично да се използва Serializable.
   - Въпроси: Какви компромиси правите между производителност и консистентност?

---

## 5. Examples

### Пример 1: Банков превод с транзакция (SQL)
```sql
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
COMMIT;
```
Тук и двете операции трябва да се изпълнят успешно, иначе се отменят.

### Пример 2: Мръсно четене (Dirty Read)
Транзакция А променя стойност, но не е commit-нала. Транзакция B чете тази стойност при Read Uncommitted изолация — ако A направи rollback, B е прочела невалидни данни.

### Пример 3: Изолационни нива в PostgreSQL
```sql
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
BEGIN;
SELECT * FROM orders WHERE status = 'pending';
-- В друга сесия: INSERT INTO orders ...
-- В първата сесия: SELECT * FROM orders WHERE status = 'pending';
-- Ще видите същите редове, без новите "phantom" записи.
COMMIT;
```

---

## 6. Common Pitfalls

- Използване на твърде ниско ниво на изолация, което води до неконсистентни или грешни данни.
- Пренебрегване на производителността: Serializable е най-сигурното ниво, но може да причини блокиране и намалена скорост.
- Забравяне за rollback при грешка — транзакцията остава "отворена" и заключва ресурси.
- Липса на разбиране за това как различните бази данни имплементират изолационните нива (някои имат оптимизации или различия).

---

## 7. Short Retrieval Quiz

1. Какво означава ACID в контекста на транзакциите?
2. Какво е "мръсно четене" и кое ниво на изолация го предотвратява?
3. Каква е разликата между non-repeatable read и phantom read?
4. Какво се случва, ако транзакция не бъде commit-ната?
5. Кое е най-високото ниво на изолация и какво гарантира то?
6. Кога може да е оправдано използването на по-ниско ниво на изолация?
7. Каква е ролята на rollback в транзакциите?

---

## 8. Quick Recap

- Транзакциите гарантират, че група операции се изпълняват като едно цяло (ACID).
- Изолационните нива определят как транзакциите взаимодействат и виждат промените на други транзакции.
- По-ниските нива на изолация увеличават производителността, но позволяват аномалии като мръсно четене.
- Най-високото ниво (Serializable) елиминира всички аномалии, но може да намали производителността.
- Изборът на изолационно ниво зависи от нуждите на конкретната система.
- Rollback връща всички промени, ако транзакцията не може да бъде завършена успешно.
- Различните бази данни могат да имплементират изолационните нива по различен начин.

---

## 9. Spaced Review Plan

| Време     | Преговори/Въпроси                                        |
|-----------|----------------------------------------------------------|
| 1 ден     | Опишете с примери разликите между изолационните нива.    |
| 3 дни     | Симулирайте dirty read и phantom read в тестова база.    |
| 1 седмица | Обяснете кога бихте избрали Serializable в реален проект.|
| 1 месец   | Дискутирайте компромисите между производителност и консистентност. |