# 28 - Trade-offs between consistency latency and throughput

## 1. Activate Prior Knowledge

- Какво означава "консистентност" в контекста на разпределени системи или бази данни? Можете ли да дадете пример от реална система?
- Кога сте се сблъсквали с бавна реакция (latency) или нисък капацитет (throughput) в софтуерна система? Какви бяха последствията?
- Как мислите, че изборът между консистентност, латентност и пропускателна способност влияе върху системи като банкови приложения или социални мрежи?

## 2. Overview

В разпределените системи често се налага да се прави избор между три ключови характеристики: консистентност (consistency), латентност (latency) и пропускателна способност (throughput). Тези характеристики определят как системата обработва заявки, колко бързо реагира и доколко данните са синхронизирани между различните компоненти.

Този баланс е известен като "trade-off" – подобряването на една характеристика често води до компромис с друга. Например, ако искаме винаги актуални данни (висока консистентност), може да се наложи да жертваме бързината на отговор (латентност) или броя заявки, които системата може да обработи (throughput).

Тези trade-off-и са особено важни при изграждането на мащабируеми и надеждни AI системи, облачни услуги и бази данни, където милиони потребители очакват едновременно бързина и точност.

## 3. Key Concepts

- **Consistency (Консистентност)** – Всички клиенти виждат едни и същи данни по едно и също време. Аналогия: всички гледат един и същи часовник.
- **Latency (Латентност)** – Времето, което отнема една операция (например четене или запис) да се изпълни. Представете си колко бързо получавате отговор на съобщение.
- **Throughput (Пропускателна способност)** – Колко операции може да обработи системата за единица време. Мислете за това като за броя коли, които могат да преминат през магистрала за един час.
- **CAP Theorem (Теорема на CAP)** – В разпределена система не могат да се постигнат едновременно консистентност, достъпност и устойчивост към разделяне на мрежата.
- **Eventual Consistency (Крайна консистентност)** – Системата гарантира, че с времето всички копия на данните ще се синхронизират, но не веднага.
- **Strong Consistency (Силна консистентност)** – Всяка операция вижда най-новото състояние на данните, без забавяне.

## 4. Step-by-step Learning Path

1. **Разберете CAP теоремата**
   - Фокус: Какво гласи CAP теоремата и какви са нейните ограничения.
   - Практическа задача: Намерете и опишете реална система (например Cassandra, MongoDB или банково приложение) и определете кои две от трите свойства (C, A, P) тя избира.
   - Въпроси: Какво означава "partition tolerance"? Може ли система да има и трите свойства едновременно?

2. **Изследвайте консистентността**
   - Фокус: Видове консистентност – силна, крайна, слаба.
   - Практическа задача: Направете малък експеримент с Redis или MongoDB, като симулирате запис и четене от различни клиенти.
   - Въпроси: Какво ще се случи, ако двама потребители четат и пишат едновременно? Какви са рисковете при слаба консистентност?

3. **Оценете латентността**
   - Фокус: Как латентността влияе на потребителското изживяване.
   - Практическа задача: Измерете времето за отговор на API заявка към публична услуга (например weather API) от различни локации.
   - Въпроси: Какво причинява висока латентност? Как може да се оптимизира?

4. **Измерете пропускателната способност**
   - Фокус: Как throughput се влияе от архитектурни решения.
   - Практическа задача: Напишете скрипт, който изпраща множество паралелни заявки към сървър и измерва колко от тях се обработват за секунда.
   - Въпроси: Какви фактори ограничават throughput? Какво се случва при претоварване?

5. **Анализирайте trade-off-и в реални сценарии**
   - Фокус: Как се взимат решения за баланс между трите характеристики.
   - Практическа задача: Изберете сценарий (например чат приложение или онлайн магазин) и опишете как бихте балансирали консистентност, латентност и пропускателна способност.
   - Въпроси: Кое е най-важното за вашия сценарий и защо?

## 5. Examples

### Пример 1: Банкова система (Strong Consistency)
Банковите транзакции изискват силна консистентност – балансът трябва да се актуализира веднага след всяка операция. Това може да увеличи латентността, тъй като системата изчаква потвърждение от всички сървъри.

### Пример 2: Социална мрежа (Eventual Consistency)
Публикуването на статус във Facebook може да се появи със закъснение при някои приятели – системата жертва силната консистентност за по-висока пропускателна способност и ниска латентност.

### Пример 3: Кодов фрагмент – Измерване на латентност
```python
import requests
import time

start = time.time()
response = requests.get('https://api.weatherapi.com/v1/current.json?key=YOUR_KEY&q=Sofia')
end = time.time()

print(f"Latency: {end - start:.3f} seconds")
```

## 6. Common Pitfalls

- **Пренебрегване на trade-off-ите** – Опитът да се постигнат всички свойства едновременно често води до нестабилна система.
- **Подценяване на латентността** – Дори малки забавяния могат да влошат потребителското изживяване, особено при реално време приложения.
- **Неправилен избор на консистентност** – Използване на силна консистентност там, където не е нужна, води до ненужно забавяне и нисък throughput.
- **Липса на мониторинг** – Без измерване на latency и throughput не може да се оптимизира системата ефективно.

## 7. Short Retrieval Quiz

1. Какво представлява консистентността в разпределена система?
2. Каква е разликата между латентност и пропускателна способност?
3. Какво гласи CAP теоремата?
4. Дайте пример за система, която използва eventual consistency.
5. Какви са рисковете при ниска консистентност?
6. Как може да се намали латентността в разпределена система?
7. Защо е важно да се прави компромис между тези три характеристики?

## 8. Quick Recap

- Консистентност, латентност и пропускателна способност са ключови характеристики на разпределените системи.
- Не може да се оптимизират и трите едновременно – винаги има компромис.
- CAP теоремата формализира този баланс.
- Изборът на подходяща консистентност зависи от бизнес нуждите.
- Латентността влияе директно на потребителското изживяване.
- Throughput определя колко заявки може да поеме системата.
- Мониторингът и разбирането на trade-off-ите са критични за добрия дизайн.

## 9. Spaced Review Plan

| Time      | Review Prompt                                              |
|-----------|-----------------------------------------------------------|
| 1 day     | Обяснете с примери какво е trade-off между C, L и T.      |
| 3 days    | Опишете CAP теоремата и дайте пример за нейната роля.     |
| 1 week    | Анализирайте реална система по отношение на трите фактора.|
| 1 month   | Обсъдете как бихте балансирали тези характеристики в нов проект. |