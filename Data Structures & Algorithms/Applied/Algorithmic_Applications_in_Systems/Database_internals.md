# Database_internals

## 1. Activate Prior Knowledge
- Какво представлява базата данни и какви видове данни съхранява в контекста на AI системи?
- Какви са основните разлики между файловата система и базата данни при съхранение и достъп до данни?
- Как мислите, че вътрешната организация на базата данни влияе върху скоростта и надеждността на AI приложения?

## 2. Overview
Вътрешната структура на базата данни описва как данните се съхраняват, организират и управляват на ниско ниво. Тя включва механизми за съхранение, индексиране, транзакции и възстановяване, които гарантират ефективност и надеждност. В контекста на AI системи, където обработката на големи обеми данни е критична, разбирането на тези механизми е ключово за оптимизиране на производителността.

Базата данни е сърцето на всяка софтуерна система, която работи с данни – от уеб приложения до сложни AI модели. Вътрешностите ѝ осигуряват абстракция, която позволява на разработчиците да се фокусират върху логиката, без да се тревожат за детайлите на съхранение и достъп. В същото време, за инженери, които искат да оптимизират системите, дълбокото разбиране на тези вътрешни процеси е незаменимо.

В този курс ще разгледаме основните компоненти и алгоритми, които стоят зад базите данни, ще анализираме как те влияят на производителността и надеждността, и ще приложим знанията на практика чрез задачи и примери.

## 3. Key Concepts
- **Storage Engine** – Компонентът, който отговаря за физическото съхранение и извличане на данни. Можем да го сравним с библиотекар, който знае точно къде се намира всяка книга.
- **Indexing** – Структура от данни, която ускорява търсенето, подобно на съдържанието в книга, което ни позволява бързо да намерим необходимата страница.
- **Transaction** – Група от операции, които се изпълняват като едно цяло, гарантирайки, че базата данни остава в консистентно състояние, дори при грешки.
- **ACID Properties** – Набор от правила (Atomicity, Consistency, Isolation, Durability), които гарантират надеждността на транзакциите.
- **Buffer Pool** – Кеш памет, която държи често използвани страници от диска в оперативната памет за бърз достъп.
- **Write-Ahead Logging (WAL)** – Механизъм за запис на промените в лог файл преди да бъдат приложени към базата, за да се осигури възстановяване при срив.
- **B-Tree** – Често използвана структура за индексиране, която поддържа балансирано дърво за бърз достъп и модификация.
- **MVCC (Multi-Version Concurrency Control)** – Техника за управление на конкурентен достъп до данните чрез съхраняване на множество версии на записите.

## 4. Step-by-step Learning Path
1. **Запознаване с основните компоненти на базата данни**  
   - Фокус: Разберете ролята на storage engine, buffer pool и transaction manager.  
   - Задача: Прочетете документацията на популярна база данни (напр. PostgreSQL) за storage engine.  
   - Въпроси: Какво е buffer pool? Защо транзакциите са важни?

2. **Изучаване на индексиране и структури от данни**  
   - Фокус: Научете как работят B-Tree и Hash индекси.  
   - Задача: Имплементирайте прост B-Tree на избран от вас език.  
   - Въпроси: Какво е предимството на B-Tree пред линейното търсене? Как индексите влияят на скоростта на заявки?

3. **Разбиране на транзакции и ACID свойства**  
   - Фокус: Изучете как се гарантира консистентност и изолация.  
   - Задача: Напишете примерна транзакция с rollback и commit в SQL.  
   - Въпроси: Какво означава атомарност? Какво е изолация?

4. **Изучаване на Write-Ahead Logging и възстановяване**  
   - Фокус: Разберете как се осигурява устойчивост при сривове.  
   - Задача: Анализирайте WAL лог от реална база данни и опишете процеса на възстановяване.  
   - Въпроси: Защо се записва лог преди промяната? Какво е възстановяване?

5. **Конкурентен достъп и MVCC**  
   - Фокус: Научете как се управлява едновременен достъп без блокиране.  
   - Задача: Симулирайте конфликтни транзакции и наблюдавайте поведението на MVCC.  
   - Въпроси: Как MVCC подобрява производителността? Как се справя с конфликтите?

## 5. Examples
### Пример 1: Създаване на B-Tree индекс в PostgreSQL
```sql
CREATE INDEX idx_user_email ON users USING btree(email);
```
Този индекс ускорява търсенето по имейл в таблицата users.

### Пример 2: Транзакция с rollback
```sql
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
-- Ако възникне грешка:
ROLLBACK;
-- В противен случай:
COMMIT;
```
Транзакцията гарантира, че парите не се губят при грешка.

### Пример 3: Примерен код за Write-Ahead Logging (псевдо-Python)
```python
def write_ahead_log(transaction):
    log_file.write(transaction)
    apply_transaction(transaction)
```
Първо записваме транзакцията в лог, след което я прилагаме.

## 6. Common Pitfalls
- **Игнориране на индекси** – Липсата на индекси води до бавни заявки и лоша производителност. Винаги анализирайте нуждите за индексиране.
- **Неправилно управление на транзакции** – Пропускане на commit или rollback може да доведе до неконсистентни данни.
- **Прекалено голям buffer pool** – Заетата памет може да доведе до swap и влошаване на производителността.
- **Неправилна конфигурация на WAL** – Липсата на подходящи настройки може да забави възстановяването след срив.
- **Пренебрегване на конкуренцията** – Неуправляваният конкурентен достъп води до deadlock или загуба на данни.

## 7. Short Retrieval Quiz
1. Какво представлява buffer pool и каква е неговата роля?  
2. Кои са четирите свойства на ACID?  
3. Какво е Write-Ahead Logging и защо е важен?  
4. Как B-Tree структурата ускорява търсенето?  
5. Как MVCC помага при конкурентен достъп?  
6. Какво се случва при rollback на транзакция?  
7. Защо индексирането е критично за производителността?

## 8. Quick Recap
- Вътрешната структура на базата данни управлява съхранението, индексирането и транзакциите.  
- Storage engine и buffer pool оптимизират достъпа до данните.  
- Индексите като B-Tree ускоряват търсенето значително.  
- Транзакциите гарантират консистентност чрез ACID свойства.  
- Write-Ahead Logging осигурява възстановяване при срив.  
- MVCC позволява ефективен конкурентен достъп без блокиране.  
- Правилната конфигурация и разбиране на тези механизми са ключови за надеждни и бързи системи.

## 9. Spaced Review Plan

| Време след учене | Промпт за преглед                                    |
|------------------|-----------------------------------------------------|
| 1 ден            | Обяснете ролята на buffer pool и Write-Ahead Logging. |
| 3 дни            | Опишете ACID свойствата и тяхното значение.          |
| 1 седмица        | Демонстрирайте как B-Tree индекс ускорява заявки.    |
| 1 месец          | Анализирайте как MVCC подобрява конкурентния достъп. |