# 24 - Schema migration and evolution techniques

## 1. Activate Prior Knowledge

- Какви са основните предизвикателства при промяна на структурата на база данни в работеща AI система?
- Какви рискове крие несъгласуваността между кода на приложението и схемата на данните?
- Можете ли да си спомните случай, когато промяна в структурата на данни е довела до неочаквани грешки или загуба на информация?

## 2. Overview

Схемата на база данни определя структурата на съхраняваните данни – таблици, полета, типове данни и връзки. В реални софтуерни системи, особено в AI приложения, изискванията към данните често се променят: добавят се нови полета, премахват се стари, или се променя типът на данните. Този процес на адаптиране на схемата към новите нужди се нарича миграция и еволюция на схемата.

Правилното управление на миграциите е критично за поддържане на целостта на данните, минимизиране на престоя и избягване на загуба на информация. Това е особено важно в среди с множество среди (development, staging, production) и екипи, които работят паралелно.

Техниките за миграция и еволюция на схемата позволяват плавно и контролирано въвеждане на промени, като гарантират, че данните остават достъпни и коректни през целия жизнен цикъл на системата. Те са ключови за устойчивостта и развитието на всяка съвременна AI или софтуерна платформа.

## 3. Key Concepts

- Schema Migration – Процесът на промяна на структурата на база данни, така че да отговаря на новите изисквания на приложението. Може да се сравни с реновиране на сграда, докато хората все още живеят в нея.
- Backward/Forward Compatibility – Способността на системата да работи с по-стари или по-нови версии на схемата. Аналогия: новите и старите ключове трябва да могат да отключват една и съща врата.
- Versioning – Отбелязване и проследяване на различните версии на схемата, за да се знае коя версия е в употреба и какви промени са направени.
- Migration Script – Скрипт, който автоматизира промяната на схемата (например добавяне на колона, промяна на тип). Подобно на рецепта, която гарантира, че всички готвачи приготвят едно и също ястие.
- Rollback – Възможност за връщане към предишна версия на схемата, ако нещо се обърка. Мислете за това като за „undo“ бутон в редактор.
- Zero-downtime Migration – Миграция, която не изисква спиране на системата. Като ремонт на път, докато движението продължава.

## 4. Step-by-step Learning Path

1. **Разберете текущата схема**
   - Фокус: Анализирайте съществуващата структура на данните.
   - Задача: Извлечете и документирайте схемата на база данни от работещ проект.
   - Въпроси: Какви са основните таблици и връзки? Кои полета са критични?

2. **Планирайте промяната**
   - Фокус: Определете какви промени са необходими и защо.
   - Задача: Направете списък с желаните промени (например: добавяне на поле, промяна на тип).
   - Въпроси: Как промяната ще повлияе на съществуващите данни? Има ли нужда от миграция на стойности?

3. **Създайте миграционен скрипт**
   - Фокус: Автоматизирайте промяната на схемата.
   - Задача: Напишете SQL миграционен скрипт за една от планираните промени.
   - Въпроси: Как ще се изпълни скриптът на production среда? Какво ще стане при грешка?

4. **Тествайте миграцията**
   - Фокус: Проверете дали скриптът работи коректно върху копие на реални данни.
   - Задача: Изпълнете миграцията в тестова среда и валидирайте резултата.
   - Въпроси: Има ли загубени или повредени данни? Всички приложения работят ли нормално?

5. **Внедрете и наблюдавайте**
   - Фокус: Изпълнете миграцията в production с план за rollback.
   - Задача: Документирайте процеса и наблюдавайте системата след промяната.
   - Въпроси: Как ще разберете, ако нещо се обърка? Как ще върнете промяната при нужда?

## 5. Examples

### Пример 1: Добавяне на ново поле

```sql
ALTER TABLE users ADD COLUMN last_login TIMESTAMP;
```
Този скрипт добавя поле за последно влизане на потребителя, без да засяга съществуващите данни.

### Пример 2: Промяна на тип на колона

```sql
ALTER TABLE orders ALTER COLUMN amount TYPE DECIMAL(10,2) USING amount::DECIMAL;
```
Тук типът на amount се променя от integer на decimal, което изисква преобразуване на стойностите.

### Пример 3: Rollback на миграция

```sql
ALTER TABLE users DROP COLUMN last_login;
```
Този скрипт връща схемата към предишното ѝ състояние, ако новото поле не е необходимо.

## 6. Common Pitfalls

- **Изпълнение на миграции директно в production** – Винаги тествайте върху копие на реални данни първо.
- **Липса на rollback план** – Винаги подгответе скрипт за връщане на промените.
- **Несъгласуваност между код и схема** – Синхронизирайте версиите на кода и схемата, за да избегнете runtime грешки.
- **Прекъсване на работата на системата** – Използвайте zero-downtime техники, когато е възможно.
- **Пропускане на миграция на стойности** – При промяна на тип или структура, осигурете коректно преобразуване на данните.

## 7. Short Retrieval Quiz

1. Какво представлява schema migration?
2. Какво означава rollback в контекста на миграциите?
3. Защо е важно миграциите да се тестват преди production?
4. Какво е zero-downtime migration?
5. Какви са рисковете при промяна на тип на колона?
6. Как се гарантира съвместимост между код и схема?
7. Какво е migration script?

## 8. Quick Recap

- Миграцията на схема е процесът на адаптиране на структурата на база данни към новите нужди.
- Важно е да се планира, тества и документира всяка промяна.
- Скриптовете за миграция автоматизират и уеднаквяват процеса.
- Rollback е ключов за безопасността при неуспешни миграции.
- Zero-downtime миграциите минимизират прекъсванията на услугата.
- Съвместимостта между код и схема е критична за стабилността на системата.
- Избягвайте директни промени без тестове и план за връщане.

## 9. Spaced Review Plan

| Review Time | Prompt                                           |
|-------------|--------------------------------------------------|
| 1 day       | Обяснете с примери какво е schema migration.      |
| 3 days      | Избройте стъпките за безопасна миграция на схема.|
| 1 week      | Какви са основните рискове и как се избягват?    |
| 1 month     | Споделете реален случай на schema evolution.     |