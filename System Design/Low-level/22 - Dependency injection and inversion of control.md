# 22 - Dependency injection and inversion of control

## 1. Activate Prior Knowledge

- Как обикновено създавате и използвате обекти и зависимости между тях в един софтуерен проект?
- Какви проблеми може да възникнат, ако един клас сам създава своите зависимости?
- Можете ли да си спомните случай, когато промяна в една част от системата е наложила промяна в много други части?

## 2. Overview

Dependency Injection (DI) и Inversion of Control (IoC) са фундаментални принципи в съвременното софтуерно инженерство, които улесняват създаването на гъвкави, разширяеми и лесни за тестване системи. Те позволяват на компонентите в една система да бъдат по-слабо свързани, като премахват твърдата зависимост между тях.

Вместо един клас сам да създава и управлява своите зависимости, чрез DI и IoC тези зависимости се предоставят отвън – например от специален контейнер или фабрика. Това улеснява подмяната на компоненти, повторната употреба и модулното тестване.

В контекста на големи системи, включително AI приложения, тези принципи са особено важни за управление на сложността, подобряване на поддръжката и ускоряване на разработката. DI и IoC са често използвани в рамки като Spring (Java), .NET Core (C#), както и в Python, JavaScript и други езици.

## 3. Key Concepts

- Dependency – Обект или ресурс, от който друг обект зависи, за да изпълни своята функция. Например, база данни или услуга за логване.
- Inversion of Control (IoC) – Принцип, при който контролът върху създаването и управлението на зависимости се прехвърля от самия обект към външен механизъм. Мислете за това като за "делегиране на отговорността".
- Dependency Injection (DI) – Конкретна реализация на IoC, при която зависимостите се "инжектират" в обекта чрез конструктор, метод или поле.
- IoC Container – Софтуерен компонент, който автоматично създава, конфигурира и предоставя зависимости на обекти.
- Tight Coupling – Когато класовете са силно зависими един от друг, което затруднява промяната и тестването.
- Loose Coupling – Когато класовете са слабо свързани и могат лесно да се заменят или тестват поотделно.

## 4. Step-by-step Learning Path

1. **Разберете проблема със силното свързване (Tight Coupling)**
   - Фокус: Анализирайте пример, където клас сам създава своите зависимости.
   - Задача: Напишете прост клас, който създава вътрешно инстанция на друга услуга (например Logger).
   - Въпроси: Какво се случва, ако трябва да смените Logger с друг? Как бихте тествали този клас?

2. **Изучете принципа на Inversion of Control**
   - Фокус: Разберете какво означава "обрат на контрола" и защо е полезен.
   - Задача: Препишете предишния клас така, че Logger да се подава отвън (например чрез конструктора).
   - Въпроси: Какво печелите от тази промяна? Какво става с тестването?

3. **Запознайте се с Dependency Injection**
   - Фокус: Разграничете видовете DI – чрез конструктор, метод, поле.
   - Задача: Имплементирайте DI чрез поне два различни начина във вашия пример.
   - Въпроси: Кой подход е най-ясен и защо? Какви са плюсовете и минусите?

4. **Работете с IoC контейнер**
   - Фокус: Разберете как работи IoC контейнерът и как автоматизира DI.
   - Задача: Използвайте прост IoC контейнер (например в Spring, .NET или Python) за автоматично инжектиране на зависимости.
   - Въпроси: Какво улеснява контейнерът? Какво трябва да конфигурирате?

5. **Приложете наученото в реален проект**
   - Фокус: Използвайте DI и IoC в малка част от по-голям проект (например REST API или AI pipeline).
   - Задача: Рефакторирайте съществуващ код, за да използва DI и IoC.
   - Въпроси: Как се промени структурата на кода? Какво улесни или усложни процеса?

## 5. Examples

### Пример 1: Без DI (Tight Coupling)
```python
class Service:
    def __init__(self):
        self.logger = Logger()  # Силно свързване

    def do_something(self):
        self.logger.log("Работя!")
```

### Пример 2: С DI (Loose Coupling)
```python
class Service:
    def __init__(self, logger):
        self.logger = logger  # Зависимостта се подава отвън

    def do_something(self):
        self.logger.log("Работя!")
```

### Пример 3: DI с IoC контейнер (Python)
```python
class Logger:
    def log(self, msg):
        print(msg)

class Service:
    def __init__(self, logger):
        self.logger = logger

def ioc_container():
    logger = Logger()
    service = Service(logger)
    return service

service = ioc_container()
service.do_something()
```

## 6. Common Pitfalls

- **Прекалено сложна конфигурация на IoC контейнера** – Опитайте се да поддържате конфигурацията ясна и документирана.
- **Инжектиране на твърде много зависимости** – Ако един клас има твърде много зависимости, вероятно нарушава принципа на единствената отговорност.
- **Злоупотреба с глобални или статични зависимости** – Това може да доведе до скрито свързване и трудности при тестване.
- **Липса на разбиране за жизнения цикъл на зависимостите** – Внимавайте дали зависимостите са singleton, prototype и т.н.

## 7. Short Retrieval Quiz

1. Какво представлява Inversion of Control?
2. Какви са основните ползи от Dependency Injection?
3. Каква е разликата между tight coupling и loose coupling?
4. Какви са основните начини за инжектиране на зависимости?
5. Какво е IoC контейнер и каква е неговата роля?
6. Какви проблеми могат да възникнат при прекомерно използване на DI?
7. Как DI улеснява тестването на софтуер?

## 8. Quick Recap

- Dependency Injection и Inversion of Control намаляват свързаността между компонентите.
- IoC прехвърля контрола върху зависимостите от обекта към външен механизъм.
- DI е конкретна техника за предоставяне на зависимости отвън.
- IoC контейнерите автоматизират процеса на създаване и инжектиране на зависимости.
- Loose coupling улеснява промяната, повторната употреба и тестването на код.
- Прекомерното използване на DI може да доведе до сложност и трудна поддръжка.
- Тези принципи са ключови за мащабируеми и поддържани системи.

## 9. Spaced Review Plan

| Време      | Преговори/Задачи                                          |
|------------|-----------------------------------------------------------|
| 1 ден      | Обяснете с примери разликата между tight и loose coupling. |
| 3 дни      | Имплементирайте DI в малък пример и обяснете IoC.          |
| 1 седмица  | Разгледайте IoC контейнер и анализирайте неговите ползи.   |
| 1 месец    | Рефакторирайте реален код с DI и оценете резултатите.      |