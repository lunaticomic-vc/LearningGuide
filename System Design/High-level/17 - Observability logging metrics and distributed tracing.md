# 17 - Observability logging metrics and distributed tracing

## 1. Activate Prior Knowledge

- Как бихте разбрали, че дадена AI система или уеб приложение работи некоректно, без да имате достъп до потребителския интерфейс?
- Каква е разликата между логовете (logs) и метриките (metrics), които сте виждали в предишни проекти?
- Можете ли да си представите ситуация, в която една заявка преминава през няколко микросервиза и трябва да проследите къде се е забавила?

## 2. Overview

Observability (наблюдаемостта) е способността да разберем вътрешното състояние на една система само чрез нейните външни изходи. В съвременните AI системи и разпределени приложения, където компонентите често са разпръснати и взаимосвързани, наблюдаемостта е ключова за диагностика, поддръжка и оптимизация.

Три основни стълба на наблюдаемостта са: логове, метрики и разпределено проследяване (distributed tracing). Логовете предоставят детайлна информация за събития, метриките дават количествени измервания, а разпределеното проследяване позволява да следим пътя на една заявка през множество услуги.

Тези инструменти помагат на инженерите да откриват и анализират проблеми, да разбират поведението на системата и да вземат информирани решения за подобрения. Без добра наблюдаемост, сложните системи стават "черни кутии", което затруднява поддръжката и развитието им.

## 3. Key Concepts

- Observability – Способността да разберем вътрешното състояние на системата чрез външни сигнали (логове, метрики, трасета). Мислете за това като за "инструментално табло" на автомобил.
- Logging – Записване на събития и съобщения за грешки или информация. Подобно на дневник, който описва какво се е случило и кога.
- Metrics – Квантитативни измервания като брой заявки, време за отговор или използване на ресурси. Представете си ги като "показатели" на таблото – скорост, температура.
- Distributed Tracing – Техника за проследяване на пътя на една заявка през няколко услуги. Аналогично на следене на пратка през различни куриери.
- Span – Отделна операция или стъпка в трасето, която съдържа информация за началото, края и контекста.
- Trace – Цялостната верига от span-ове, описваща пътя на една заявка през системата.
- Instrumentation – Добавяне на код или инструменти за събиране на логове, метрики и трасета.

## 4. Step-by-step Learning Path

1. **Understand the basics of observability**
   - Фокус: Разберете разликата между логове, метрики и трасета.
   - Задача: Прочетете лог файл от малко приложение и идентифицирайте различни типове съобщения.
   - Въпроси: Какво е лог? Как се различава от метрика?

2. **Work with metrics**
   - Фокус: Събиране и визуализация на метрики.
   - Задача: Използвайте Prometheus или подобен инструмент, за да съберете и визуализирате CPU usage на локално приложение.
   - Въпроси: Какви метрики са най-полезни за наблюдение на производителността?

3. **Implement logging best practices**
   - Фокус: Структуриране на логове и избор на нива (info, warning, error).
   - Задача: Добавете структурирани логове към функция в Python с помощта на logging модула.
   - Въпроси: Каква е разликата между info и error лог?

4. **Explore distributed tracing**
   - Фокус: Проследяване на заявки през няколко услуги.
   - Задача: Интегрирайте Jaeger или OpenTelemetry в малък микросервизен проект и проследете една заявка.
   - Въпроси: Какво е span? Как се съставя trace?

5. **Analyze and debug using observability data**
   - Фокус: Използване на логове, метрики и трасета за откриване на проблеми.
   - Задача: Симулирайте грешка и използвайте събраните данни, за да я локализирате.
   - Въпроси: Как бихте използвали трасета, за да разберете къде се забавя заявка?

## 5. Examples

### Пример 1: Структуриран лог в Python

```python
import logging
import json

logging.basicConfig(level=logging.INFO)

def process_order(order_id):
    logging.info(json.dumps({"event": "order_processed", "order_id": order_id}))

process_order(123)
```

### Пример 2: Събиране на метрики с Prometheus

```python
from prometheus_client import Counter, start_http_server

REQUEST_COUNT = Counter('request_count', 'Брой заявки')

def handle_request():
    REQUEST_COUNT.inc()
    # обработка на заявката

start_http_server(8000)
```

### Пример 3: Разпределено проследяване с OpenTelemetry (Python)

```python
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import SimpleSpanProcessor, ConsoleSpanExporter

trace.set_tracer_provider(TracerProvider())
tracer = trace.get_tracer(__name__)
trace.get_tracer_provider().add_span_processor(
    SimpleSpanProcessor(ConsoleSpanExporter())
)

with tracer.start_as_current_span("process_order"):
    # обработка на поръчката
    pass
```

## 6. Common Pitfalls

- **Пренебрегване на структурирани логове:** Неструктурираните логове са трудни за автоматичен анализ. Използвайте формати като JSON.
- **Събиране на твърде много или твърде малко данни:** Прекаленото логване затруднява анализа, а недостатъчното – прави диагностицирането невъзможно.
- **Липса на корелация между логове, метрики и трасета:** Без общи идентификатори е трудно да се свържат събитията.
- **Неинструментирани услуги:** Ако някоя услуга не събира данни, трасетата ще бъдат непълни.
- **Пропускане на грешки в логовете:** Не всички изключения се логват – уверете се, че критичните грешки се записват.

## 7. Short Retrieval Quiz

1. Каква е основната цел на observability?
2. Какво е разликата между лог и метрика?
3. Какво представлява span в разпределеното проследяване?
4. Защо е важно логовете да са структурирани?
5. Какво позволява distributed tracing, което логовете не могат?
6. Как може да се използва метрика за откриване на проблем?
7. Какви са рисковете при прекомерно логване?

## 8. Quick Recap

- Observability помага да разберем вътрешното състояние на системите чрез логове, метрики и трасета.
- Логовете записват събития и грешки, често във формат, подходящ за анализ.
- Метриките измерват количествени характеристики като натоварване и време за отговор.
- Distributed tracing проследява пътя на заявките през множество услуги.
- Структурираните логове и корелационните идентификатори улесняват анализа.
- Инструменти като Prometheus, Jaeger и OpenTelemetry са стандарт в индустрията.
- Добрата наблюдаемост ускорява откриването и отстраняването на проблеми.

## 9. Spaced Review Plan

| Време   | Преговори/Подсказки                                  |
|---------|------------------------------------------------------|
| 1 ден   | Опишете разликата между лог, метрика и трасе.        |
| 3 дни   | Дайте пример за структурирани логове и тяхното предимство. |
| 1 седмица | Обяснете как distributed tracing помага при дебъг. |
| 1 месец | Избройте основните инструменти за observability и техните роли. |