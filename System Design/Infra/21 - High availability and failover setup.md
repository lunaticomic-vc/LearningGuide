# 21 - High availability and failover setup

## 1. Activate Prior Knowledge

- Какво се случва, ако основният сървър на една AI система внезапно спре да работи? Какви са последствията за крайните потребители?
- Можете ли да си спомните случай, когато дадена услуга или приложение е било недостъпно поради хардуерен или софтуерен проблем?
- Как мислите, че големите компании като Google или Amazon осигуряват непрекъсната работа на своите услуги, дори при възникване на повреди?

## 2. Overview

High availability (HA) и failover са критични концепции в съвременните AI системи и софтуерно инженерство. Те гарантират, че приложенията и услугите остават достъпни и функционират правилно, дори при възникване на хардуерни или софтуерни повреди. Основната цел е да се минимизира времето на недостъпност (downtime) и да се осигури надеждност за крайните потребители.

В по-широк контекст, HA и failover се използват във всякакви мащаби — от малки уеб приложения до големи разпределени AI платформи. Те са особено важни за системи, които трябва да работят 24/7, като банкови платформи, здравни информационни системи или AI-базирани услуги за препоръки.

Внедряването на HA и failover изисква внимателно планиране на инфраструктурата, мониторинг, автоматизация и тестване. Това включва използване на резервни сървъри, балансиране на натоварването, репликация на данни и автоматично превключване към резервни компоненти при нужда.

## 3. Key Concepts

- High Availability (HA) – Архитектурен подход, който осигурява максимално време на непрекъсната работа на системата. Може да се сравни с резервна батерия, която се включва, когато основната източник на енергия отпадне.
- Failover – Автоматичен процес на превключване към резервен компонент или система при отказ на основния. Представете си го като аварийна лента на магистрала, по която трафикът се пренасочва при инцидент.
- Redundancy – Изграждане на резервни копия на критични компоненти (хардуер, софтуер, мрежи), за да се избегне единична точка на отказ.
- Load Balancer – Компонент, който разпределя входящия трафик между няколко сървъра, за да предотврати претоварване и да осигури HA.
- Heartbeat – Механизъм за периодична проверка на състоянието на компонентите; ако някой не отговори, се задейства failover.
- Quorum – Механизъм за избиране на „главен“ компонент в клъстер, за да се избегнат split-brain ситуации.
- Recovery Time Objective (RTO) – Максимално допустимото време за възстановяване след отказ.
- Recovery Point Objective (RPO) – Максимално допустимата загуба на данни, измерена във времеви интервал.

## 4. Step-by-step Learning Path

1. **Разберете нуждата от HA и failover**
   - Фокус: Защо са важни тези концепции в AI и критични системи.
   - Задача: Опишете сценарий, при който липсата на HA води до сериозни последствия.
   - Въпроси: Какви рискове крие липсата на HA? Кои системи са най-застрашени?

2. **Запознайте се с архитектурните модели за HA**
   - Фокус: Основни топологии (active-active, active-passive, N+1).
   - Задача: Нарисувайте схема на active-passive failover архитектура.
   - Въпроси: Каква е разликата между active-active и active-passive?

3. **Настройте прост failover с два сървъра**
   - Фокус: Практическа конфигурация на резервен сървър.
   - Задача: Инсталирайте и конфигурирайте Keepalived или Pacemaker за автоматичен failover.
   - Въпроси: Какво се случва, когато основният сървър спре? Как се възстановява услугата?

4. **Внедрете load balancer за HA**
   - Фокус: Използване на HAProxy или Nginx за балансиране на натоварването.
   - Задача: Конфигурирайте load balancer, който разпределя трафика между два бекенд сървъра.
   - Въпроси: Как load balancer-ът открива, че един сървър е недостъпен? Какво се случва с трафика?

5. **Тествайте и валидирайте failover механизма**
   - Фокус: Симулиране на отказ и наблюдение на реакцията на системата.
   - Задача: Изключете основния сървър и наблюдавайте дали услугата остава достъпна.
   - Въпроси: Колко време отнема failover? Има ли загуба на данни или заявки?

6. **Мониторинг и автоматизация**
   - Фокус: Настройване на мониторинг (например с Prometheus) и автоматични известия.
   - Задача: Конфигурирайте аларма, която се задейства при отказ на сървър.
   - Въпроси: Какви метрики са най-важни за наблюдение на HA? Какво трябва да се автоматизира?

## 5. Examples

### Пример 1: Active-Passive Web Server Failover

```bash
# Конфигуриране на Keepalived на два Ubuntu сървъра
sudo apt-get install keepalived

# /etc/keepalived/keepalived.conf (основен сървър)
vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1234
    }
    virtual_ipaddress {
        192.168.1.100
    }
}
```

### Пример 2: Load Balancing с HAProxy

```haproxy
# /etc/haproxy/haproxy.cfg
frontend http_front
    bind *:80
    default_backend http_back

backend http_back
    balance roundrobin
    server web1 192.168.1.101:80 check
    server web2 192.168.1.102:80 check
```

### Пример 3: Database Replication and Failover

- Използване на PostgreSQL с Patroni за автоматичен failover и репликация между master и standby инстанции.

## 6. Common Pitfalls

- **Single Point of Failure:** Оставяне на един компонент без резервен, което обезсмисля HA архитектурата.
- **Липса на тестване:** Не се симулират реални откази, което води до неработещи failover сценарии при нужда.
- **Неправилна конфигурация на quorum:** Split-brain ситуации, при които два сървъра се смятат за „главни“.
- **Недостатъчен мониторинг:** Пропускане на откази поради липса на аларми или метрики.
- **Слаба синхронизация на данни:** Възможна загуба на данни при failover, ако репликацията не е коректна.

## 7. Short Retrieval Quiz

1. Каква е основната цел на high availability архитектурата?
2. Какво представлява failover и кога се използва?
3. Каква е разликата между active-active и active-passive конфигурация?
4. Какво е load balancer и как помага за HA?
5. Какво е heartbeat в контекста на HA системи?
6. Какво означават RTO и RPO?
7. Какви мерки трябва да се вземат, за да се избегне single point of failure?

## 8. Quick Recap

- High availability гарантира минимално време на недостъпност на системите.
- Failover осигурява автоматично превключване към резервни компоненти при отказ.
- Redundancy и load balancing са основни техники за постигане на HA.
- Мониторингът и тестването са критични за надеждността на HA архитектурите.
- Конфигурацията на quorum предотвратява split-brain ситуации.
- RTO и RPO определят времевите и данните граници при възстановяване.
- Правилната автоматизация и алармиране минимизират човешките грешки.

## 9. Spaced Review Plan

| Review Time | Review Prompt                                               |
|-------------|------------------------------------------------------------|
| 1 day       | Обяснете с примери как работи failover в уеб приложение.   |
| 3 days      | Нарисувайте схема на HA архитектура и опишете компонентите.|
| 1 week      | Избройте основните грешки при внедряване на HA и как да ги избегнете. |
| 1 month     | Обяснете разликата между RTO и RPO и дайте практически пример.         |