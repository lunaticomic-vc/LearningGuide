# 14 - Fault tolerance and resilience patterns

## 1. Activate Prior Knowledge

- Какво се случва, когато дадена услуга или компонент в една сложна система спре да работи? Какви са последствията за цялостната система?
- Можете ли да дадете пример от реалния живот или от софтуерното инженерство, където системата е продължила да работи въпреки възникнала грешка?
- Какви подходи познавате за справяне с неочаквани грешки или сривове в AI системи или мащабируеми уеб приложения?

## 2. Overview

Fault tolerance и resilience са фундаментални принципи в дизайна на съвременни софтуерни системи, особено при разпределени и AI-базирани решения. Те гарантират, че системите могат да продължат да функционират, дори когато отделни компоненти се провалят или се появят неочаквани грешки.

В контекста на мащабни приложения, microservices или AI платформи, неизбежно е някои части да се сринат поради хардуерни, софтуерни или мрежови проблеми. Fault tolerance означава, че системата може да издържи на тези сривове, докато resilience се фокусира върху способността на системата да се възстановява и да поддържа нормална работа.

Тези модели са критични за постигане на висока наличност, надеждност и добро потребителско изживяване. Те са особено важни в AI системи, където обработката на големи обеми данни и сложни изчисления увеличава риска от грешки.

## 3. Key Concepts

- Fault tolerance – Способността на система да продължи да работи коректно, дори когато някои нейни части се провалят. Може да се сравни с резервна гума на автомобил.
- Resilience – Способността на система да се възстановява бързо след срив или грешка, подобно на това как човек се изправя след падане.
- Redundancy – Използване на резервни компоненти или услуги, които поемат работата при отказ на основните.
- Graceful degradation – Системата намалява функционалността си постепенно, вместо да спира напълно при проблем.
- Circuit breaker – Шаблон, който временно прекъсва връзката към проблемна услуга, за да предотврати по-големи щети.
- Retry pattern – Автоматично повторение на неуспешна операция след кратко изчакване.
- Bulkhead – Изолиране на различни части на системата, така че срив в една част да не засяга останалите.
- Fallback – Осигуряване на алтернативно поведение или отговор, когато основната функционалност не е налична.

## 4. Step-by-step Learning Path

1. **Разберете основите на fault tolerance и resilience**
   - Фокус: Прочетете кратка статия за разликите между двете понятия.
   - Задача: Направете списък с 3 примера за системи, които използват тези принципи.
   - Въпроси: Каква е основната разлика между fault tolerance и resilience? Може ли една система да бъде resilient, но не и fault tolerant?

2. **Изучете основните шаблони (patterns)**
   - Фокус: Запознайте се с circuit breaker, retry, bulkhead и fallback.
   - Задача: Нарисувайте диаграма на microservice архитектура с поне два от тези шаблони.
   - Въпроси: Как работи circuit breaker? Кога бихте използвали bulkhead?

3. **Имплементирайте прост fault tolerance механизъм**
   - Фокус: Използвайте библиотека като Hystrix (Java) или Polly (C#) за добавяне на circuit breaker.
   - Задача: Напишете малък код, който прави HTTP заявка с retry и circuit breaker.
   - Въпроси: Какво се случва, ако всички опити за retry се провалят? Какво е fallback?

4. **Тествайте и анализирайте поведението при грешки**
   - Фокус: Симулирайте сривове и наблюдавайте как системата реагира.
   - Задача: Изключете една услуга и наблюдавайте дали останалите продължават да работят.
   - Въпроси: Как graceful degradation помага на потребителите? Какво би станало без redundancy?

5. **Приложете наученото към AI или ML система**
   - Фокус: Помислете как fault tolerance и resilience могат да се използват при AI inference или data pipelines.
   - Задача: Опишете сценарий, в който AI система използва fallback при липса на резултат.
   - Въпроси: Какви специфични предизвикателства има при fault tolerance в AI системи?

## 5. Examples

### Пример 1: Circuit Breaker с Hystrix (Java)
```java
HystrixCommand<String> command = new HystrixCommand<String>(HystrixCommandGroupKey.Factory.asKey("ExampleGroup")) {
    @Override
    protected String run() throws Exception {
        // Основна логика
        return callRemoteService();
    }
    @Override
    protected String getFallback() {
        return "Fallback response";
    }
};
String result = command.execute();
```

### Пример 2: Retry Pattern с Polly (C#)
```csharp
var policy = Policy
    .Handle<HttpRequestException>()
    .Retry(3, (exception, retryCount) => {
        Console.WriteLine($"Retry {retryCount} due to {exception.Message}");
    });

policy.Execute(() => CallExternalApi());
```

### Пример 3: Bulkhead в Microservices
В една cloud архитектура, различни microservices са изолирани в отделни контейнери. Ако един service се претовари или срине, останалите продължават да работят без прекъсване.

## 6. Common Pitfalls

- Прекалено агресивно използване на retry, което води до претоварване на системата.
- Липса на fallback механизъм, което води до тотален срив при отказ.
- Неправилна конфигурация на circuit breaker (твърде чувствителен или твърде толерантен).
- Пренебрегване на graceful degradation – системата спира напълно вместо да предостави ограничена функционалност.
- Неизолирани компоненти – срив в една част води до срив на цялата система.

## 7. Short Retrieval Quiz

1. Каква е разликата между fault tolerance и resilience?
2. Как работи circuit breaker pattern?
3. Какво е fallback и кога се използва?
4. Какво представлява bulkhead pattern?
5. Как graceful degradation подобрява потребителското изживяване?
6. Какви са рисковете при прекомерно използване на retry?
7. Дайте пример за redundancy в софтуерна система.

## 8. Quick Recap

- Fault tolerance и resilience са ключови за надеждни и мащабируеми системи.
- Circuit breaker, retry, bulkhead и fallback са основни шаблони за устойчивост.
- Redundancy и graceful degradation минимизират последствията от сривове.
- Тестовете и симулациите на грешки са задължителни за валидиране на устойчивостта.
- В AI системи fault tolerance изисква специално внимание поради сложността на обработката.
- Правилната конфигурация и балансираното използване на шаблоните са критични.
- Избягвайте single points of failure чрез изолация и резервни компоненти.

## 9. Spaced Review Plan

| Review Time | Review Prompt                                              |
|-------------|-----------------------------------------------------------|
| 1 day       | Обяснете с примери разликата между fault tolerance и resilience. |
| 3 days      | Избройте и опишете основните шаблони за устойчивост.      |
| 1 week      | Нарисувайте архитектура с поне два resilience шаблона.    |
| 1 month     | Анализирайте реален срив и предложете подобрения с тези принципи. |