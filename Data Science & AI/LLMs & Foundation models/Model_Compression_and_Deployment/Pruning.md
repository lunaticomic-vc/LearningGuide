# Pruning

## 1. Activate Prior Knowledge
- Какво представлява оптимизацията на модели в контекста на изкуствения интелект?
- Защо е важно да намалим размера на невронните мрежи без да губим тяхната точност?
- Какви техники познавате за подобряване на ефективността на софтуерни системи и как те могат да се приложат към модели за машинно обучение?

## 2. Overview
Pruning е техника за намаляване на сложността на невронни мрежи чрез премахване на излишни или слабо значими параметри (тегла, неврони или връзки). Целта е да се създадат по-леки, по-бързи и по-енергийно ефективни модели, които запазват висока точност.

Тази техника е особено важна в контекста на внедряване на AI системи в устройства с ограничени ресурси, като мобилни телефони, вградени системи и IoT. Pruning се прилага след първоначалното обучение на модела и често се комбинира с други методи като квантоване и дистилация.

Pruning не само подобрява производителността, но и помага за по-добро разбиране на важността на различните компоненти в мрежата, което може да доведе до по-интуитивна архитектура и по-лесна поддръжка.

## 3. Key Concepts
- **Pruning (Подрязване)** – процес на премахване на ненужни или слабо влияещи параметри в невронна мрежа, за да се намали нейната сложност и размер.
- **Weight Magnitude Pruning (Подрязване по големина на теглата)** – премахване на връзки с тегла, чиито стойности са близки до нула, тъй като те оказват малък ефект върху изхода.
- **Structured Pruning (Структурирано подрязване)** – премахване на цели филтри, канали или неврони, което води до по-лесна оптимизация на хардуерно ниво.
- **Unstructured Pruning (Неструктурирано подрязване)** – премахване на отделни тегла без да се засягат цели структури, което може да доведе до по-рядка, но по-трудна за оптимизация мрежа.
- **Fine-tuning (Фина настройка)** – повторно обучение на модела след подрязване, за да се възстанови или подобри точността.
- **Sparsity (Разреждане)** – степента, до която моделът съдържа нулеви или премахнати параметри, което влияе на ефективността и скоростта.

## 4. Step-by-step Learning Path
1. **Запознайте се с основите на невронните мрежи и параметрите им.**  
   *Практическа задача:* Прегледайте структурата на предварително обучен модел (например ResNet).  
   *Въпроси за припомняне:* Какво представляват теглата и как влияят на изхода на мрежата?

2. **Научете за различните видове pruning – структурирано и нестуктурирано.**  
   *Практическа задача:* Изследвайте примери за подрязване на отделни тегла спрямо премахване на цели филтри.  
   *Въпроси за припомняне:* Каква е разликата между структурирано и нестуктурирано подрязване?

3. **Прилагайте weight magnitude pruning върху малък модел.**  
   *Практическа задача:* Напишете скрипт, който премахва тегла под определен праг и наблюдавайте промяната в точността.  
   *Въпроси за припомняне:* Какви са ефектите от премахването на малки тегла?

4. **Извършете фина настройка след подрязване.**  
   *Практическа задача:* Обучете модела отново след подрязване и сравнете резултатите.  
   *Въпроси за припомняне:* Защо е необходима фина настройка?

5. **Изследвайте хардуерните и софтуерни оптимизации, свързани с pruning.**  
   *Практическа задача:* Анализирайте как различните видове подрязване влияят на скоростта и използването на памет.  
   *Въпроси за припомняне:* Как pruning помага при внедряване на AI на устройства с ограничени ресурси?

## 5. Examples
### Пример 1: Неструктурирано подрязване на тегла в PyTorch
```python
import torch
import torch.nn.utils.prune as prune
import torchvision.models as models

model = models.resnet18(pretrained=True)
parameters_to_prune = (
    (model.layer1[0].conv1, 'weight'),
    (model.layer1[0].conv2, 'weight'),
)

for module, param in parameters_to_prune:
    prune.l1_unstructured(module, name=param, amount=0.2)

print("Подрязване завършено.")
```

### Пример 2: Структурирано подрязване на цели филтри
```python
prune.ln_structured(model.layer1[0].conv1, name='weight', amount=0.3, n=2, dim=0)
```

### Пример 3: Фина настройка след подрязване
```python
# След подрязване, продължете обучението с по-нисък learning rate
optimizer = torch.optim.SGD(model.parameters(), lr=1e-4)
# Обучение с новите параметри...
```

## 6. Common Pitfalls
- **Премахване на твърде много параметри наведнъж** – води до значително влошаване на точността. Решение: прилагайте подрязване постепенно и комбинирайте с фина настройка.
- **Игнориране на фина настройка след подрязване** – без повторно обучение моделът губи представяне. Винаги извършвайте фина настройка.
- **Подрязване без анализ на хардуерните ограничения** – някои видове подрязване не водят до реално ускорение на изпълнението. Изберете подходящ тип подрязване според целевата платформа.
- **Прекалено сложни критерии за подрязване** – усложняват процеса и не винаги подобряват резултатите. Започнете с прости методи като weight magnitude pruning.
- **Забравяне за оценка на модела след подрязване** – винаги тествайте точността и производителността след всяка стъпка.

## 7. Short Retrieval Quiz
1. Каква е основната цел на pruning в невронните мрежи?
2. Каква е разликата между структурирано и нестуктурирано подрязване?
3. Защо е необходима фина настройка след подрязване?
4. Какво означава sparsity и как влияе на модела?
5. Кои параметри обикновено се премахват при weight magnitude pruning?
6. Как pruning може да подобри внедряването на AI системи в мобилни устройства?
7. Какви са рисковете при прекалено агресивно подрязване?

## 8. Quick Recap
- Pruning намалява размера и сложността на невронните мрежи чрез премахване на незначими параметри.
- Съществуват два основни вида подрязване: структурирано и нестуктурирано.
- Weight magnitude pruning премахва тегла с малки стойности, които имат малък ефект върху изхода.
- Фина настройка е задължителна след подрязване, за да се възстанови точността.
- Pruning подобрява ефективността на модели при ограничени хардуерни ресурси.
- Твърде агресивното подрязване може да доведе до загуба на представяне.
- Винаги тествайте и анализирайте модела след всяка стъпка на подрязване.

## 9. Spaced Review Plan

| Време след изучаване | Промпт за преговор                                  |
|----------------------|----------------------------------------------------|
| 1 ден                | Обяснете какво представлява pruning и защо е важен.|
| 3 дни                | Разграничете структурирано и нестуктурирано подрязване.|
| 1 седмица            | Опишете процеса на weight magnitude pruning и фина настройка.|
| 1 месец              | Дайте примери за приложения на pruning в реални AI системи и изброите основните рискове. |