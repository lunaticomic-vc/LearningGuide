# 13 - CAP theorem and PACELC analysis

## 1. Activate Prior Knowledge

- Какви са основните предизвикателства при проектирането на разпределени бази данни или системи, които трябва да работят в реално време?
- Кога сте се сблъсквали с избор между последователност (consistency) и наличност (availability) в софтуерни архитектури?
- Какви компромиси бихте очаквали, когато една AI система трябва да обработва големи обеми данни, разпределени в различни локации?

## 2. Overview

CAP теоремата и PACELC анализът са фундаментални концепции в света на разпределените системи и бази данни. Те описват неизбежните компромиси, които архитектите трябва да направят между последователност, наличност и устойчивост към разделяне на мрежата. Тези принципи са особено важни при проектирането на мащабируеми AI системи, облачни услуги и всякакви приложения, които работят с големи разпределени данни.

CAP теоремата формализира ограниченията, като гласи, че една разпределена система не може едновременно да гарантира последователност, наличност и устойчивост към разделяне на мрежата. PACELC анализът разширява тази идея, като добавя още един компромис: дори когато няма разделение на мрежата, системата трябва да избира между латентност и последователност.

Разбирането на тези принципи помага на инженерите да вземат информирани решения при избора на технологии и архитектурни подходи, които най-добре отговарят на бизнес изискванията и очакванията за производителност.

## 3. Key Concepts

- **Consistency (Последователност)** – Всички възли виждат едни и същи данни по едно и също време. Може да се сравни с това всички каси в магазин да показват една и съща наличност на стока.
- **Availability (Наличност)** – Всяка заявка получава отговор, дори ако някои възли са офлайн. Представете си, че винаги има отворена каса, дори ако някои са затворени.
- **Partition Tolerance (Устойчивост към разделяне)** – Системата продължава да работи, дори ако има прекъсвания в комуникацията между възли. Това е като магазин, който продължава да обслужва клиенти, дори ако някои каси не могат да комуникират помежду си.
- **CAP Theorem (CAP теорема)** – В разпределена система могат да бъдат гарантирани само две от трите: последователност, наличност, устойчивост към разделяне.
- **PACELC** – Разширение на CAP, което добавя компромис между последователност и латентност, дори когато няма разделяне на мрежата.
- **Latency (Латентност)** – Времето, необходимо за отговор на заявка. По-ниската латентност често означава по-бързи, но потенциално по-непоследователни отговори.
- **Network Partition (Разделяне на мрежата)** – Ситуация, при която възлите в системата не могат да комуникират помежду си поради мрежови проблеми.

## 4. Step-by-step Learning Path

1. **Изучете CAP теоремата**
   - Фокус: Разберете трите основни свойства и защо не могат да се постигнат едновременно.
   - Практическа задача: Нарисувайте диаграма на CAP триъгълника и посочете примери за системи, които избират различни двойки свойства.
   - Въпроси: Кои са трите свойства на CAP? Може ли система да има и трите едновременно?

2. **Анализирайте реални системи според CAP**
   - Фокус: Разгледайте популярни бази данни (напр. MongoDB, Cassandra, Redis) и определете кои свойства приоритизират.
   - Практическа задача: Изберете една база данни и опишете как тя се държи при мрежово разделяне.
   - Въпроси: Какво се случва с последователността при мрежово разделяне в избраната система? Как се гарантира наличност?

3. **Запознайте се с PACELC анализа**
   - Фокус: Разберете как PACELC добавя компромиса между последователност и латентност, дори без мрежово разделяне.
   - Практическа задача: Попълнете таблица за няколко системи (напр. DynamoDB, Cassandra, Google Spanner) според PACELC.
   - Въпроси: Какво означава "EL" в PACELC? Как се различава PACELC от CAP?

4. **Приложете знанията в архитектурно решение**
   - Фокус: Използвайте CAP и PACELC, за да изберете подходяща база данни за AI система, която изисква висока наличност и ниска латентност.
   - Практическа задача: Опишете сценарий и аргументирайте избора си на база данни.
   - Въпроси: Защо избрахте тази система? Какви компромиси правите?

## 5. Examples

### Пример 1: MongoDB и CAP

MongoDB в конфигурация по подразбиране е AP система – при мрежово разделяне жертва последователността, за да осигури наличност и устойчивост към разделяне.

### Пример 2: Google Spanner и PACELC

Google Spanner е CP система според CAP, но според PACELC е PA/EC – при разделяне жертва наличността, а при липса на разделяне избира последователност пред латентност.

### Пример 3: Cassandra – настройка за баланс

Cassandra позволява настройка на нивата на последователност. Ето примерен код за запис с настройка на "QUORUM" (баланс между последователност и наличност):

```python
from cassandra.cluster import Cluster

cluster = Cluster(['127.0.0.1'])
session = cluster.connect('mykeyspace')

session.execute(
    """
    INSERT INTO users (user_id, name)
    VALUES (%s, %s)
    """,
    (123, 'Ivan'),
    consistency_level=ConsistencyLevel.QUORUM
)
```

## 6. Common Pitfalls

- **Неправилно разбиране на CAP** – Мисленето, че може да се постигнат и трите свойства едновременно. Винаги трябва да се избира кои две са най-важни.
- **Игнориране на PACELC** – Пренебрегване на компромиса между латентност и последователност, което може да доведе до неочаквано бавни или непоследователни системи.
- **Лош избор на база данни** – Избор на система, която не отговаря на бизнес изискванията за последователност, наличност или латентност.
- **Недостатъчно тестване при мрежови проблеми** – Липса на симулация на мрежови разделяния по време на разработка.

## 7. Short Retrieval Quiz

1. Кои са трите свойства в CAP теоремата?
2. Какво означава "partition tolerance"?
3. Какво добавя PACELC анализа към CAP?
4. Какво избира една AP система при мрежово разделяне?
5. Какво е компромисът между последователност и латентност?
6. Дайте пример за CP система.
7. Какво може да се случи, ако изберете база данни без да вземете предвид PACELC?

## 8. Quick Recap

- CAP теоремата описва невъзможността да се постигнат едновременно последователност, наличност и устойчивост към разделяне.
- Винаги трябва да се избират две от трите свойства според нуждите на системата.
- PACELC добавя компромиса между последователност и латентност, дори без разделяне на мрежата.
- Различните бази данни и системи приоритизират различни свойства според архитектурните си цели.
- Разбирането на тези компромиси е критично при проектиране на мащабируеми и надеждни AI системи.
- Правилният избор на база данни зависи от конкретните бизнес и технически изисквания.
- Тестването на системата при различни сценарии (вкл. мрежови проблеми) е задължително.

## 9. Spaced Review Plan

| Review Time | Prompt                                                                 |
|-------------|-----------------------------------------------------------------------|
| 1 day       | Избройте трите свойства на CAP и дайте пример за компромис между тях. |
| 3 days      | Обяснете PACELC и как се различава от CAP.                            |
| 1 week      | Анализирайте реална система според PACELC.                            |
| 1 month     | Опишете сценарий, в който изборът на база данни според CAP/PACELC е критичен. |