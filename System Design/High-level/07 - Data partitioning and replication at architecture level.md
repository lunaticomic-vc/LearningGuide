# 07 - Data partitioning and replication at architecture level

## 1. Activate Prior Knowledge

- Какви са основните предизвикателства при съхранението и обработката на големи обеми от данни в разпределени системи?
- Как бихте осигурили висока наличност и устойчивост на данните в една AI система?
- Какво означава "scalability" (мащабируемост) и как се постига тя на ниво архитектура на данните?

## 2. Overview

Data partitioning (разделяне на данни) и replication (репликация) са фундаментални техники в архитектурата на съвременните разпределени системи, особено когато се работи с големи обеми от данни или се изисква висока надеждност. Тези подходи позволяват на системите да се мащабират хоризонтално, да осигуряват устойчивост при откази и да подобряват производителността.

Partitioning разделя данните на по-малки, управляеми части (partitions/shards), които могат да се разпределят върху множество сървъри или локации. Това намалява натоварването върху отделен сървър и позволява паралелна обработка.

Replication означава създаване на копия на данните в различни възли или центрове за данни. Това осигурява устойчивост при хардуерни или софтуерни откази и позволява по-бърз достъп до данните от различни географски точки.

В контекста на AI системи и големи уеб приложения, тези техники са критични за гарантиране на бързина, надеждност и непрекъсната работа на услугите.

## 3. Key Concepts

- **Partitioning (Sharding)** – Разделяне на голям набор от данни на по-малки, независими части. Представете си библиотека, където книгите са разделени по жанр в различни зали.
- **Replication** – Създаване на едно или повече копия на данните. Подобно на това да имате резервни ключове за дома си на различни места.
- **Consistency** – Степента, до която всички копия на данните отразяват едно и също състояние. Мислете за това като за синхронизация между часовници.
- **Availability** – Способността на системата да отговаря на заявки, дори при отказ на някои компоненти.
- **Partition Tolerance** – Устойчивостта на системата при прекъсване на връзката между отделни части (network partitions).
- **Replication Factor** – Броят на копията на даден набор от данни в системата.
- **Primary-Replica Model** – Един възел е основен (primary/master), а останалите са реплики (replicas/slaves), които синхронизират данните си с основния.

## 4. Step-by-step Learning Path

1. **Understand Partitioning Strategies**
   - Фокус: Range-based, hash-based, и list-based partitioning.
   - Task: Изберете подходяща стратегия за разделяне на таблица с потребители по фамилия.
   - Retrieval: Каква е разликата между hash и range partitioning? Кога бихте избрали едното пред другото?

2. **Explore Replication Models**
   - Фокус: Synchronous vs. asynchronous replication; primary-replica vs. multi-primary.
   - Task: Моделирайте сценарий, в който данните се репликират между два дата центъра.
   - Retrieval: Какви са рисковете при асинхронна репликация?

3. **Balance Consistency, Availability, and Partition Tolerance (CAP Theorem)**
   - Фокус: Разберете компромисите според CAP теоремата.
   - Task: Опишете какво би се случило при network partition в система с висока консистентност.
   - Retrieval: Може ли една система да бъде едновременно напълно консистентна, налична и устойчива на партициониране?

4. **Implement Partitioning and Replication in Practice**
   - Фокус: Използване на реални инструменти (напр. MongoDB sharding, PostgreSQL replication).
   - Task: Настройте проста репликация или шардване на база данни по избор.
   - Retrieval: Какви конфигурационни стъпки са необходими за добавяне на нов shard или replica?

5. **Monitor and Troubleshoot**
   - Фокус: Следене на здравето на партициите и репликите.
   - Task: Симулирайте отказ на възел и анализирайте поведението на системата.
   - Retrieval: Как системата възстановява реплика или партиция след отказ?

## 5. Examples

### Example 1: Hash-based Partitioning in a NoSQL Database

```python
# Пример с Python: определяне на shard за user_id
def get_shard(user_id, num_shards):
    return hash(user_id) % num_shards

print(get_shard('user123', 4))  # Изход: 2 (примерно)
```

### Example 2: Synchronous Replication in PostgreSQL

- Master node приема запис.
- Записът се изпраща до replica node.
- Потвърждение за успех се връща на клиента едва след запис и на двете места.

### Example 3: Partitioning User Data by Region

- Данните за потребители от Европа се съхраняват в европейски дата център.
- Данните за потребители от Азия – в азиатски дата център.
- Това намалява latency и подобрява съответствието с регулации.

## 6. Common Pitfalls

- **Неравномерно разпределение на данните (data skew):** Води до претоварване на някои възли. Използвайте подходящи hash функции или динамично ребалансиране.
- **Липса на автоматизация при възстановяване:** При отказ на възел, липсва автоматично прехвърляне на партиции или реплики.
- **Пренебрегване на latency между дата центрове:** Асинхронната репликация може да доведе до загуба на данни при срив.
- **Недостатъчно тестване на отказоустойчивост:** Не симулирате достатъчно често откази и split-brain сценарии.
- **Сложност при миграция на данни:** Промяна на partitioning схемата в продукция може да доведе до downtime.

## 7. Short Retrieval Quiz

1. Каква е основната цел на partitioning в разпределените системи?
2. Какво представлява replication factor?
3. Каква е разликата между синхронна и асинхронна репликация?
4. Какво гласи CAP теоремата?
5. Как може да се избегне data skew при partitioning?
6. Какво се случва при отказ на primary node в primary-replica модел?
7. Защо е важно да се репликират данните в различни географски региони?

## 8. Quick Recap

- Partitioning разделя данните за по-добра мащабируемост и производителност.
- Replication осигурява устойчивост и висока наличност на данните.
- Изборът на partitioning и replication стратегия зависи от нуждите за консистентност, latency и устойчивост.
- CAP теоремата описва фундаменталните компромиси в разпределените системи.
- Неравномерното разпределение на данните може да доведе до bottlenecks.
- Репликацията може да бъде синхронна или асинхронна, всяка с плюсове и минуси.
- Мониторингът и автоматизацията са критични за стабилността на системата.

## 9. Spaced Review Plan

| When    | Review Prompt                                      |
|---------|----------------------------------------------------|
| 1 day   | Обяснете разликата между partitioning и replication. Дайте пример. |
| 3 days  | Опишете сценарий, в който CAP теоремата влияе на архитектурно решение. |
| 1 week  | Как бихте предотвратили data skew в нова система?  |
| 1 month | Какви са рисковете при асинхронна репликация и как се минимизират? |