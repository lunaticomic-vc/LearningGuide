# 16 - Query execution plans and performance tuning

## 1. Activate Prior Knowledge

- Как базите данни изпълняват заявки и какво означава оптимизация на заявки?
- Можете ли да си спомните случаи, когато една SQL заявка е работила бавно? Как бихте подходили към подобряване на нейната производителност?
- Какво влияние оказва изборът на индекс върху изпълнението на заявки в големи информационни системи или AI приложения?

## 2. Overview

Query execution plans и performance tuning са ключови аспекти от работата с релационни бази данни и други системи за управление на данни. Execution plan представлява стратегията, която системата избира, за да изпълни дадена заявка – например кои индекси да използва, в какъв ред да се присъединят таблиците и какви операции да се приложат. Анализът на тези планове позволява на инженерите да разберат защо дадена заявка е бавна и как може да бъде ускорена.

Performance tuning е процесът на систематично подобряване на скоростта и ефективността на заявките чрез промяна на SQL кода, добавяне на индекси, промяна на структурата на данните или настройка на параметри на базата данни. В контекста на AI системи или мащабни софтуерни решения, ефективното изпълнение на заявки често е критично за цялостната производителност.

Тези техники са важни не само за администратори на бази данни, но и за разработчици, които трябва да пишат оптимизиран код, работещ с големи обеми данни. Разбирането на execution plans и tuning подходите води до по-ефективни, мащабируеми и надеждни системи.

## 3. Key Concepts

- Query Execution Plan – Описание на стъпките, които базата данни ще предприеме, за да изпълни дадена заявка. Може да се разглежда като „рецепта“ за изпълнение.
- Cost-based Optimization – Метод, при който системата избира най-евтиния (по ресурси) план, използвайки статистика за данните.
- Index – Структура от данни, която ускорява достъпа до редове в таблица, подобно на съдържание в книга.
- Table Scan – Прочитане на всички редове в таблица; често е по-бавно от използване на индекс.
- Join Order – Последователността, в която се съединяват таблиците; може силно да повлияе на производителността.
- Cardinality – Оценка на броя редове, които ще бъдат върнати или обработени на даден етап; неточните оценки могат да доведат до неефективни планове.
- Query Hint – Специална инструкция към оптимизатора за избор на определена стратегия (например да използва конкретен индекс).

## 4. Step-by-step Learning Path

1. **Разгледайте execution plan за проста заявка**
   - Фокус: Как да получите и прочетете execution plan във вашата СУБД (например с `EXPLAIN` в PostgreSQL).
   - Задача: Изпълнете SELECT заявка и анализирайте execution plan.
   - Въпроси: Какви операции виждате в плана? Използва ли се индекс?

2. **Сравнете различни планове за една и съща заявка**
   - Фокус: Как промяната на заявката или наличието на индекси влияе на execution plan.
   - Задача: Добавете индекс и сравнете execution plan преди и след.
   - Въпроси: Какво се промени в плана? Как се отрази на времето за изпълнение?

3. **Идентифицирайте „скъпи“ операции**
   - Фокус: Откриване на операции с най-голям разход (cost) в плана.
   - Задача: Намерете най-ресурсоемката стъпка в execution plan на сложна заявка.
   - Въпроси: Коя операция е най-бавна? Как бихте я оптимизирали?

4. **Използвайте query hints и параметри**
   - Фокус: Влияние на hints върху избора на план.
   - Задача: Приложете hint (например FORCE INDEX) и наблюдавайте промяната.
   - Въпроси: Как hint-ът промени плана? Винаги ли е по-добре?

5. **Мониторирайте и настройвайте в реална система**
   - Фокус: Използване на инструменти за мониторинг и настройка на заявки в production среда.
   - Задача: Използвайте инструмент (например pg_stat_statements или SQL Server Profiler) за откриване на бавни заявки.
   - Въпроси: Какви са най-честите причини за бавни заявки? Какви действия предприехте?

## 5. Examples

### Пример 1: Анализ на execution plan

```sql
EXPLAIN SELECT * FROM customers WHERE last_name = 'Ivanov';
```
*Output*: Ако има индекс върху `last_name`, планът ще използва index scan; иначе – table scan.

### Пример 2: Добавяне на индекс и промяна на план

```sql
CREATE INDEX idx_last_name ON customers(last_name);
EXPLAIN SELECT * FROM customers WHERE last_name = 'Ivanov';
```
*Output*: След добавяне на индекса, execution plan показва използване на index scan, което е по-бързо.

### Пример 3: Използване на query hint

```sql
SELECT /*+ INDEX(customers idx_last_name) */ * FROM customers WHERE last_name = 'Ivanov';
```
*Output*: Оптимизаторът е принуден да използва конкретния индекс, което може да подобри или влоши производителността в зависимост от случая.

## 6. Common Pitfalls

- Пренебрегване на execution plan: Често се разчита на интуиция вместо на реален анализ на плана.
- Прекомерно използване на индекси: Много индекси могат да забавят записите и да увеличат разхода на място.
- Сляпо използване на query hints: Могат да доведат до по-лоши планове при промяна на данните.
- Игнориране на статистиките: Остарели статистики водят до неефективни планове.
- Фокус само върху една заявка: Оптимизацията на една заявка може да влоши други.

## 7. Short Retrieval Quiz

1. Какво представлява query execution plan?
2. Каква е ролята на индексите при изпълнение на заявки?
3. Какво е table scan и кога се използва?
4. Какво означава cardinality в контекста на execution plan?
5. Как query hints влияят на оптимизатора?
6. Какви са потенциалните недостатъци при прекомерното използване на индекси?
7. Защо е важно да се поддържат актуални статистики в базата данни?

## 8. Quick Recap

- Execution plan показва как базата данни ще изпълни дадена заявка.
- Индексите могат значително да ускорят достъпа до данни, но трябва да се използват разумно.
- Анализът на execution plan е ключов за диагностика и оптимизация на бавни заявки.
- Оптимизаторът избира план на база статистики и разходи.
- Query hints могат да насочат оптимизатора, но трябва да се използват внимателно.
- Остарели статистики и прекомерни индекси са чести причини за лоша производителност.
- Performance tuning е непрекъснат процес, особено при динамични или мащабни системи.

## 9. Spaced Review Plan

| Кога      | Преговори/Задачи                                              |
|-----------|---------------------------------------------------------------|
| 1 ден     | Прегледайте ключовите термини и един execution plan           |
| 3 дни     | Анализирайте нов execution plan и идентифицирайте скъпи операции |
| 1 седмица | Добавете/премахнете индекс и наблюдавайте промяната в плана   |
| 1 месец   | Оптимизирайте реална бавна заявка и документирайте процеса    |